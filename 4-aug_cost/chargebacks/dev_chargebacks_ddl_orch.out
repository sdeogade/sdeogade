[Errno 2] No such file or directory: 'dev1_chargebacks_ddl_orch.sql'
If the error message is unclear, enable logging using -o log_level=DEBUG and see the log to find out the cause. Contact support for further help.
/*

cd "/Volumes/GoogleDrive/Shared drives/Professional Services/Service Delivery/Individual Folders/Greg Sitzman/3) In-Use/Data Cloud Deployment Framework/Scripts/Chargebacks/Account"

snowsql -c aws_cas2 -r mwebster_dev_sysadmin_fr -D l_env=dev -f chargebacks_ddl_orch.sql -o output_file=chargebacks_ddl_orch.out

*/

------------------------------------------------------------------------------
-- snowsql session
--
------------------------------------------------------------------------------
-- 000_admin
--
!print 000_admin
000_admin

!print set context -----------------------------------------------------------
set context -----------------------------------------------------------

!source 000_admin/prd_context_ddl.sql
------------------------------------------------------------------------------
-- context
--
!print set environment context
set environment context

!define l_common_db=PRD_PLAT_GOV_COMMON_DB
!define l_common_schema=UTIL

!define l_raw_db=PRD_PLAT_GOV_RL_DB
!define l_raw_schema=account_usage

!define l_il_db=PRD_PLAT_GOV_IL_DB
!define l_il_schema=USAGE_METRIC

!define l_pl_db=PRD_PLAT_GOV_PL_DB
!define l_pl_schema=REPORTING

!print SUCCESS!
SUCCESS!

!print execute ddl -----------------------------------------------------------
execute ddl -----------------------------------------------------------

!source 000_admin/account_ddl_orch.sql
------------------------------------------------------------------------------
-- 000_admin
--
!print 000_admin
000_admin

!source 000_admin/wrk_environment.sql
--------------------------------------------------------------------
--  Purpose: Internal stage for accout_usage data
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
--
--create schema if not exists &{l_target_db}.&{l_target_schema};
------------------------------------------------------------------------------
-- 900_common
--
!print 900_common
900_common

!source 900_common/account_usage_stg.sql
--------------------------------------------------------------------
--  Purpose: Internal stage for accout_usage data
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

---set variable_substitution=true. But set it to FALSE ---!set variable_substitution=true


create stage if not exists PRD_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
002003 (02000): SQL compilation error:
Database 'PRD_PLAT_GOV_COMMON_DB' does not exist or not authorized.
If the error message is unclear, enable logging using -o log_level=DEBUG and see the log to find out the cause. Contact support for further help.
/*

cd "/Volumes/GoogleDrive/Shared drives/Professional Services/Service Delivery/Individual Folders/Greg Sitzman/3) In-Use/Data Cloud Deployment Framework/Scripts/Chargebacks/Account"

snowsql -c aws_cas2 -r mwebster_dev_sysadmin_fr -D l_env=dev -f chargebacks_ddl_orch.sql -o output_file=chargebacks_ddl_orch.out

*/

------------------------------------------------------------------------------
-- snowsql session
--
------------------------------------------------------------------------------
-- 000_admin
--
!print 000_admin
000_admin

!print set context -----------------------------------------------------------
set context -----------------------------------------------------------

!source 000_admin/dev_context_ddl.sql
------------------------------------------------------------------------------
-- context
--
!print set environment context
set environment context

!define l_common_db=DEV_PLAT_GOV_COMMON_DB
!define l_common_schema=UTIL

!define l_raw_db=DEV_PLAT_GOV_RL_DB
!define l_raw_schema=account_usage

!define l_il_db=DEV_PLAT_GOV_IL_DB
!define l_il_schema=USAGE_METRIC

!define l_pl_db=DEV_PLAT_GOV_PL_DB
!define l_pl_schema=REPORTING

!print SUCCESS!
SUCCESS!

!print execute ddl -----------------------------------------------------------
execute ddl -----------------------------------------------------------

!source 000_admin/account_ddl_orch.sql
------------------------------------------------------------------------------
-- 000_admin
--
!print 000_admin
000_admin

!source 000_admin/wrk_environment.sql
--------------------------------------------------------------------
--  Purpose: Internal stage for accout_usage data
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
--
--create schema if not exists &{l_target_db}.&{l_target_schema};
------------------------------------------------------------------------------
-- 900_common
--
!print 900_common
900_common

!source 900_common/account_usage_stg.sql
--------------------------------------------------------------------
--  Purpose: Internal stage for accout_usage data
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

---set variable_substitution=true. But set it to FALSE ---!set variable_substitution=true


create stage if not exists DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+----------------------------------------------------+
| status                                             |
|----------------------------------------------------|
| Stage area ACCOUNT_USAGE_STG successfully created. |
+----------------------------------------------------+
/*
url='azure://bysnow.blob.core.windows.net/admin/account_usage/'
credentials=(azure_sas_token="****&st=2021-06-01T00:00:00Z&se=2022-06-01T00:00:00Z&spr=https&sv=2020-02-10&sr=c&sig=****")
;

-- turn off session variable
*/


/*
--SET DATE_FOLDER = (SELECT REPLACE(TO_VARCHAR(TO_DATE(CURRENT_TIMESTAMP())),'-',''));
create or replace stage my_azure_stage
url='azure://bysnow.blob.core.windows.net/admin/account_usage/'
credentials=(azure_sas_token='sp=r&st=2021-06-01T00:00:00Z&se=2022-01-01T00:00:00Z&spr=https&sv=2020-02-10&sr=c&sig=****')
encryption=(type='AZURE_CSE' master_key = 'kPxX0jzYfIamtnJEUTHwq80Au6NbSgPH5r4BDDwOaO8=')
  file_format = my_csv_format;
*/
!source 900_common/date_sid_f.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
create or replace function DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f
(
    p_date             date
)
returns number
as
$$
    select to_number( to_char( p_date, 'yyyymmdd') )
$$
;
+-------------------------------------------+
| status                                    |
|-------------------------------------------|
| Function DATE_SID_F successfully created. |
+-------------------------------------------+
!source 900_common/dw_delta_date_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

create transient table if not exists DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date
(
     event_dt       timestamp_ltz not null
    ,dw_load_ts     timestamp_ltz not null
)
data_retention_time_in_days = 0
;
+-------------------------------------------+
| status                                    |
|-------------------------------------------|
| Table DW_DELTA_DATE successfully created. |
+-------------------------------------------+

!source 900_common/dw_delta_date_ld_sp.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
create or replace procedure DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_ld_sp( P_SRC_TABLE varchar, P_SRC_COLUMN varchar )
returns varchar
language javascript
execute as caller
as
$$
    // variables
    var status          = 'success';
    var tracePos        = 'step 0';
    var sqlResult;
    var sqlCmd;

    try {
        // insert distinct dates into work table
        tracePos  = 'insert into';
        sqlCmd    = `
            insert overwrite into
                --DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date
                DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date
            select distinct
                 to_date( ${P_SRC_COLUMN} )
                ,current_timestamp()
            from
                ${P_SRC_TABLE};
            `;

        sqlResult = snowflake.execute( { sqlText: sqlCmd } );

    }
    catch (err) {
        status  = 'line: ' + tracePos;
        status += '\n failed: code: ' + err.code + '\n state: ' + err.state;
        status += '\n message: ' + err.message;
        status += '\n stack trace:\n' + err.stacktracetxt;
    }
    finally {
        return status;
    }
$$
;
+----------------------------------------------------+
| status                                             |
|----------------------------------------------------|
| Function DW_DELTA_DATE_LD_SP successfully created. |
+----------------------------------------------------+
!source 900_common/dw_delta_date_range_f.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
create or replace function DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f
(
    p_period_type_cd   varchar
)
returns table( start_dt timestamp_ltz, end_dt timestamp_ltz )
as
$$
    select
         start_dt
        ,end_dt
    from
        (
        select
             case lower( p_period_type_cd )
                 when 'all'     then current_date()
                 when 'day'     then date_trunc( day, event_dt )
                 when 'week'    then date_trunc( week, event_dt )
                 when 'month'   then date_trunc( month, event_dt )
                 when 'quarter' then date_trunc( quarter, event_dt )
                 when 'year'    then date_trunc( year, event_dt )
                 else current_date()
             end                as partition_dt
            ,min( event_dt ) as start_dt
            ,max( event_dt ) as end_dt
        from
            DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date
        group by
            1
        )
    order by
        1
$$
;
+------------------------------------------------------+
| status                                               |
|------------------------------------------------------|
| Function DW_DELTA_DATE_RANGE_F successfully created. |
+------------------------------------------------------+
!source 900_common/fcst_linear_trend_sp.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
create or replace procedure DEV_PLAT_GOV_COMMON_DB.UTIL.fcst_linear_trend_sp( P_SRC_TABLE varchar, P_TGT_TABLE varchar )
returns varchar
language javascript
execute as caller
as
$$
    // variables
    var status          = 'success';
    var tracePos        = 'step 0';
    var sqlResult;
    var sqlCmd;

    try {
        // create temp table with derived forecast
        tracePos  = 'derive forecast';
        sqlCmd    = `
            create or replace temporary table identifier( '${P_TGT_TABLE}' ) as
                    -- period-to-date sequence for time
                    with l_ptd as
                    (
                        select
                             s.partition_key
                            ,s.period_dt
                            ,s.year_no
                            ,s.period_no
                            ,s.measure_no
                            ,row_number( ) over( partition by s.partition_key order by s.period_dt )    as ptd_seq_no
                        from
                            identifier( '${P_SRC_TABLE}' ) s
                        order by
                            1,2
                    )
                    -- intercept and slope
                    ,l_int_slope as
                    (
                        select
                             partition_key
                            ,regr_intercept( measure_no, ptd_seq_no ) as intercept_no
                            ,regr_slope( measure_no, ptd_seq_no )     as slope_no
                        from
                            l_ptd
                        where
                            measure_no is not null
                        group by 1
                        order by 1
                    )
                    --forecast
                    ,l_forecast as
                    (
                        select
                             lp.partition_key
                            ,lp.period_dt
                            ,lp.year_no
                            ,lp.period_no
                            ,lp.measure_no
                            ,lp.ptd_seq_no
                            ,lis.intercept_no
                            ,lis.slope_no
                            ,(lis.slope_no * lp.ptd_seq_no) + lis.intercept_no as fcst_measure_no
                        from
                            l_ptd lp
                            join l_int_slope lis on
                                lis.partition_key = lp.partition_key
                        order by
                            1,2
                    )
                    select
                         lf.partition_key
                        ,lf.period_dt
                        ,lf.year_no
                        ,lf.period_no
                        ,lf.measure_no
                        ,lf.fcst_measure_no
                        ,object_construct(*)                as component_json
                    from
                        l_forecast lf
                    order by
                        1,2,3
            `;

        sqlResult = snowflake.execute( { sqlText: sqlCmd } );

    }
    catch (err) {
        status  = 'line: ' + tracePos;
        status += '\n failed: code: ' + err.code + '\n state: ' + err.state;
        status += '\n message: ' + err.message;
        status += '\n stack trace:\n' + err.stacktracetxt;
    }
    finally {
        return status;
    }
$$
;
+-----------------------------------------------------+
| status                                              |
|-----------------------------------------------------|
| Function FCST_LINEAR_TREND_SP successfully created. |
+-----------------------------------------------------+
!source 900_common/fcst_seasonal_trend_sp.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
create or replace procedure DEV_PLAT_GOV_COMMON_DB.UTIL.fcst_seasonal_trend_sp( P_SRC_TABLE varchar, P_TGT_TABLE varchar )
returns varchar
language javascript
execute as caller
as
$$
    // variables
    var status          = 'success';
    var tracePos        = 'step 0';
    var sqlResult;
    var sqlCmd;
    var mAvgLagNo;
    var mAvgLeadNo;

    try {
        // get moving avg lag and lead row counts
        // assumes model period is the same across partitions
        tracePos  = 'mavg lag rows';
        sqlCmd    = `select
                          trunc( count( distinct period_no ) / 2 )     as mavg_lag_no
                         ,round( count( distinct period_no ) / 2 ) - 1 as mavg_lead_no
                     from
                         identifier( '${P_SRC_TABLE}' )`;
        sqlResult = snowflake.execute( { sqlText: sqlCmd } );
        sqlResult.next();
        mAvgLagNo   = sqlResult.getColumnValue( 'MAVG_LAG_NO' );
        mAvgLeadNo  = sqlResult.getColumnValue( 'MAVG_LEAD_NO' );

        // create temp table with derived forecast
        tracePos  = 'derive forecast';
        sqlCmd    = `
            create or replace temporary table identifier( '${P_TGT_TABLE}' ) as
                    -- moving average
                    with l_mavg as
                    (
                        select
                             s.partition_key
                            ,s.period_dt
                            ,s.year_no
                            ,s.period_no
                            ,s.measure_no
                            ,case
                                when lag( s.measure_no, ${mAvgLagNo} ) over( partition by s.partition_key order by s.period_dt ) is not null
                                 and lead( s.measure_no, ${mAvgLeadNo} ) over( partition by s.partition_key order by s.period_dt ) is not null
                                then avg( s.measure_no ) over( partition by s.partition_key order by s.period_dt
                                                               rows between ${mAvgLagNo} preceding and ${mAvgLeadNo} following )
                                else null
                             end    as mavg_measure_no
                        from
                            identifier( '${P_SRC_TABLE}' ) s
                        order by
                            1,2
                    )
                    -- center moving average: current row and next row
                    ,l_cmavg as
                    (
                        select
                             partition_key
                            ,period_dt
                            ,year_no
                            ,period_no
                            ,measure_no
                            ,mavg_measure_no
                            ,case
                                when mavg_measure_no is not null
                                 and lead( mavg_measure_no, 1 ) over( partition by partition_key order by period_dt ) is not null
                                then avg( mavg_measure_no ) over( partition by partition_key order by period_dt rows between 0 preceding and 1 following )
                                else null
                             end    as cmavg_measure_no
                        from
                            l_mavg
                        order by
                            1,2
                    )
                    -- seasonal and irregular components
                    ,l_seasonal as
                    (
                        select
                             partition_key
                            ,period_dt
                            ,year_no
                            ,period_no
                            ,measure_no
                            ,mavg_measure_no
                            ,cmavg_measure_no
                            ,measure_no / cmavg_measure_no  as seasonal_no
                        from
                            l_cmavg
                        order by
                            1,2
                    )
                    -- period average of seasonal
                    ,l_pavg_seasonal as
                    (
                        select
                             partition_key
                            ,period_no
                            ,avg( seasonal_no ) as pavg_seasonal_no
                        from
                            l_seasonal
                        where
                            seasonal_no is not null
                        group by 1,2
                        order by 1,2
                    )
                    -- deseasonalize with period avg and calc period-to-date sequence
                    ,l_deseason as
                    (
                        select
                             ls.partition_key
                            ,ls.period_dt
                            ,ls.year_no
                            ,ls.period_no
                            ,ls.measure_no
                            ,ls.mavg_measure_no
                            ,ls.cmavg_measure_no
                            ,ls.seasonal_no
                            ,lps.pavg_seasonal_no
                            ,case
                                when lps.pavg_seasonal_no is not null
                                then ls.measure_no / lps.pavg_seasonal_no
                                else 1
                             end                                                                                    as deseason_measure_no
                            ,row_number( ) over( partition by ls.partition_key order by ls.period_dt )  as ptd_seq_no
                        from
                            l_seasonal ls
                            left join l_pavg_seasonal lps on
                                    lps.partition_key = ls.partition_key
                                and lps.period_no     = ls.period_no
                        order by
                          1,2,3
                    )
                    -- intercept and slope
                    ,l_int_slope as
                    (
                        select
                             partition_key
                            ,regr_intercept( deseason_measure_no, ptd_seq_no ) as intercept_no
                            ,regr_slope( deseason_measure_no, ptd_seq_no )     as slope_no
                        from
                            l_deseason
                        where
                            deseason_measure_no is not null
                        group by 1
                        order by 1
                    )
                    -- trend
                    ,l_trend as
                    (
                        select
                             ld.partition_key
                            ,ld.period_dt
                            ,ld.year_no
                            ,ld.period_no
                            ,ld.measure_no
                            ,ld.mavg_measure_no
                            ,ld.cmavg_measure_no
                            ,ld.seasonal_no
                            ,ld.pavg_seasonal_no
                            ,ld.deseason_measure_no
                            ,ld.ptd_seq_no
                            ,lis.intercept_no
                            ,lis.slope_no
                            ,(lis.slope_no * ld.ptd_seq_no) + lis.intercept_no as trend_no
                        from
                            l_deseason ld
                            join l_int_slope lis on
                                lis.partition_key = ld.partition_key
                        order by
                            1,2
                    )
                    --forecast
                    ,l_forecast as
                    (
                        select
                             lt.partition_key
                            ,lt.period_dt
                            ,lt.year_no
                            ,lt.period_no
                            ,lt.measure_no
                            ,${mAvgLagNo}       as p_mavg_lag_no
                            ,${mAvgLeadNo}      as p_mavg_lead_no
                            ,lt.mavg_measure_no
                            ,lt.cmavg_measure_no
                            ,lt.seasonal_no
                            ,lt.pavg_seasonal_no
                            ,lt.deseason_measure_no
                            ,lt.ptd_seq_no
                            ,lt.intercept_no
                            ,lt.slope_no
                            ,lt.trend_no
                            ,lt.pavg_seasonal_no * lt.trend_no     as fcst_measure_no
                        from
                            l_trend lt
                        order by
                            1,2
                    )
                    select
                         lf.partition_key
                        ,lf.period_dt
                        ,lf.year_no
                        ,lf.period_no
                        ,lf.measure_no
                        ,lf.fcst_measure_no
                        ,object_construct(*)                as component_json
                    from
                        l_forecast lf
                    order by
                        1,2`;

        sqlResult = snowflake.execute( { sqlText: sqlCmd } );

    }
    catch (err) {
        status  = 'line: ' + tracePos;
        status += '\n failed: code: ' + err.code + '\n state: ' + err.state;
        status += '\n message: ' + err.message;
        status += '\n stack trace:\n' + err.stacktracetxt;
    }
    finally {
        return status;
    }
$$
;
+-------------------------------------------------------+
| status                                                |
|-------------------------------------------------------|
| Function FCST_SEASONAL_TREND_SP successfully created. |
+-------------------------------------------------------+
------------------------------------------------------------------------------
-- 100_acquisition
--
!print 100_acquisition
100_acquisition
------------------------------------------------------------------------------
-- 200_raw
--
!print 200_raw
200_raw

!source 200_raw/automatic_clustering_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history_stg
(
     organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,num_bytes_reclustered          number              null
    ,num_rows_reclustered           number              null
    ,table_id                       number              null
    ,table_name                     varchar( 250 )      null
    ,schema_id                      number              null
    ,schema_name                    varchar( 250 )      null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+--------------------------------------------------------------+
| status                                                       |
|--------------------------------------------------------------|
| Table AUTOMATIC_CLUSTERING_HISTORY_STG successfully created. |
+--------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history
(
     dw_automatic_clustering_history_shk                   binary( 20 )        null
    --
    ,organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,num_bytes_reclustered          number              null
    ,num_rows_reclustered           number              null
    ,table_id                       number              null
    ,table_name                     varchar( 250 )      null
    ,schema_id                      number              null
    ,schema_name                    varchar( 250 )      null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+----------------------------------------------------------+
| status                                                   |
|----------------------------------------------------------|
| Table AUTOMATIC_CLUSTERING_HISTORY successfully created. |
+----------------------------------------------------------+
!source 200_raw/be_resource_mapping_lkp_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.be_resource_mapping_lkp
(
     match_pattern                  varchar( 100 )
    ,priority_no                    number
    ,tag_json                       variant
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-----------------------------------------------------+
| status                                              |
|-----------------------------------------------------|
| Table BE_RESOURCE_MAPPING_LKP successfully created. |
+-----------------------------------------------------+
!source 200_raw/cb_service_type_lkp_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp
(
     dw_service_type_shk            binary( 20 )        not null
    ,dw_hash_diff                   binary( 20 )        not null
    ,service_type_cd                varchar( 50 )       not null
    ,service_type_name              varchar( 250 )      not null
    ,service_type_group_name        varchar( 250 )      not null
    ,active_dt                      date                not null
    ,inactive_dt                    date                not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
    ,dw_update_ts                   timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------------+
| status                                          |
|-------------------------------------------------|
| Table CB_SERVICE_TYPE_LKP successfully created. |
+-------------------------------------------------+
!source 200_raw/data_transfer_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history_stg
(
     organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,start_time                     timestamp_ltz       not null
    ,end_time                       timestamp_ltz       not null
    ,source_cloud                   varchar( 250 )
    ,source_region                  varchar( 250 )
    ,target_cloud                   varchar( 250 )
    ,target_region                  varchar( 250 )
    ,bytes_transferred              number
    ,transfer_type                  varchar( 250 )
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+-------------------------------------------------------+
| status                                                |
|-------------------------------------------------------|
| Table DATA_TRANSFER_HISTORY_STG successfully created. |
+-------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history
(
     dw_data_transfer_history_shk                   binary( 20 )        not null
    --
    ,organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,start_time                     timestamp_ltz       not null
    ,end_time                       timestamp_ltz       not null
    ,source_cloud                   varchar( 250 )
    ,source_region                  varchar( 250 )
    ,target_cloud                   varchar( 250 )
    ,target_region                  varchar( 250 )
    ,bytes_transferred              number
    ,transfer_type                  varchar( 250 )
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+---------------------------------------------------+
| status                                            |
|---------------------------------------------------|
| Table DATA_TRANSFER_HISTORY successfully created. |
+---------------------------------------------------+
!source 200_raw/database_storage_usage_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history_stg
(
     organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,usage_date                     date                not null
    ,database_id                    number              not null
    ,database_name                  varchar( 250 )      not null
    ,deleted                        timestamp_ltz           null
    ,average_database_bytes         float               not null
    ,average_failsafe_bytes         float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+----------------------------------------------------------------+
| status                                                         |
|----------------------------------------------------------------|
| Table DATABASE_STORAGE_USAGE_HISTORY_STG successfully created. |
+----------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history
(
     dw_database_storage_usage_history_shk                   binary( 20 )        not null
    --
    ,organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,usage_date                     date                not null
    ,database_id                    number              not null
    ,database_name                  varchar( 250 )      not null
    ,deleted                        timestamp_ltz           null
    ,average_database_bytes         float               not null
    ,average_failsafe_bytes         float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+------------------------------------------------------------+
| status                                                     |
|------------------------------------------------------------|
| Table DATABASE_STORAGE_USAGE_HISTORY successfully created. |
+------------------------------------------------------------+
!source 200_raw/materialized_view_refresh_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history_stg
(
     organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,table_id                       number              null
    ,table_name                     varchar( 250 )      null
    ,schema_id                      number              null
    ,schema_name                    varchar( 250 )      null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+-------------------------------------------------------------------+
| status                                                            |
|-------------------------------------------------------------------|
| Table MATERIALIZED_VIEW_REFRESH_HISTORY_STG successfully created. |
+-------------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history
(
     dw_materialized_view_refresh_history_shk                   binary( 20 )        null
    --
    ,organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,table_id                       number              null
    ,table_name                     varchar( 250 )      null
    ,schema_id                      number              null
    ,schema_name                    varchar( 250 )      null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+---------------------------------------------------------------+
| status                                                        |
|---------------------------------------------------------------|
| Table MATERIALIZED_VIEW_REFRESH_HISTORY successfully created. |
+---------------------------------------------------------------+
!source 200_raw/metering_daily_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.metering_daily_history_stg
(
     organization_name                  varchar( 250 )      not null
    ,account_name                       varchar( 250 )      not null
    ,region_name                        varchar( 250 )      not null
    ,service_type                       varchar( 250 )      not null
    ,usage_date                         timestamp_ltz       not null
    ,credits_used_compute               number              not null
    ,credits_used_cloud_services        number              not null
    ,credits_used                       number              not null
    ,credits_adjustment_cloud_services  number              not null
    ,credits_billed                     number              not null
    --
    ,dw_file_name                       varchar( 250 )      not null
    ,dw_file_row_no                     number              not null
    ,dw_load_ts                         timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+--------------------------------------------------------+
| status                                                 |
|--------------------------------------------------------|
| Table METERING_DAILY_HISTORY_STG successfully created. |
+--------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.metering_daily_history
(
     dw_metering_daily_history_shk                       binary( 20 )        not null
    --
    ,organization_name                  varchar( 250 )      not null
    ,account_name                       varchar( 250 )      not null
    ,region_name                        varchar( 250 )      not null
    ,service_type                       varchar( 250 )      not null
    ,usage_date                         timestamp_ltz       not null
    ,credits_used_compute               number              not null
    ,credits_used_cloud_services        number              not null
    ,credits_used                       number              not null
    ,credits_adjustment_cloud_services  number              not null
    ,credits_billed                     number              not null
    --
    ,dw_file_name                       varchar( 250 )      not null
    ,dw_file_row_no                     number              not null
    ,dw_load_ts                         timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+----------------------------------------------------+
| status                                             |
|----------------------------------------------------|
| Table METERING_DAILY_HISTORY successfully created. |
+----------------------------------------------------+
!source 200_raw/pipe_usage_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history_stg
(
     organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,bytes_inserted                 number              null
    ,files_inserted                 number              null
    ,pipe_id                        number              null
    ,pipe_name                      varchar( 250 )      null
    ,schema_name                    varchar( 250 )      null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+----------------------------------------------------+
| status                                             |
|----------------------------------------------------|
| Table PIPE_USAGE_HISTORY_STG successfully created. |
+----------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history
(
     dw_pipe_usage_history_shk                   binary( 20 )        null
    --
    ,organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,bytes_inserted                 number              null
    ,files_inserted                 number              null
    ,pipe_id                        number              null
    ,pipe_name                      varchar( 250 )      null
    ,schema_name                    varchar( 250 )      null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+------------------------------------------------+
| status                                         |
|------------------------------------------------|
| Table PIPE_USAGE_HISTORY successfully created. |
+------------------------------------------------+
!source 200_raw/query_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.query_history_stg
(
     organization_name                      varchar( 250 )      not null
    ,account_name                           varchar( 250 )      not null
    ,region_name                            varchar( 250 )      not null
    ,query_id                               text                not null
    ,query_text                             text                not null
    ,database_id                            number
    ,database_name                          text
    ,schema_id                              number
    ,schema_name                            text
    ,query_type                             text
    ,session_id                             number
    ,user_name                              text
    ,role_name                              text
    ,warehouse_id                           number
    ,warehouse_name                         text
    ,warehouse_size                         text
    ,warehouse_type                         text
    ,cluster_number                         number
    ,query_tag                              text
    ,execution_status                       text
    ,error_code                             number
    ,error_message                          text
    ,start_time                             timestamp_ltz
    ,end_time                               timestamp_ltz
    ,total_elapsed_time                     number
    ,bytes_scanned                          number
    ,percentage_scanned_from_cache          float
    ,bytes_written                          number
    ,bytes_written_to_result                number
    ,bytes_read_from_result                 number
    ,rows_produced                          number
    ,rows_inserted                          number
    ,rows_updated                           number
    ,rows_deleted                           number
    ,rows_unloaded                          number
    ,bytes_deleted                          number
    ,partitions_scanned                     number
    ,partitions_total                       number
    ,bytes_spilled_to_local_storage         number
    ,bytes_spilled_to_remote_storage        number
    ,bytes_sent_over_the_network            number
    ,compilation_time                       number
    ,execution_time                         number
    ,queued_provisioning_time               number
    ,queued_repair_time                     number
    ,queued_overload_time                   number
    ,transaction_blocked_time               number
    ,outbound_data_transfer_cloud           text
    ,outbound_data_transfer_region          text
    ,outbound_data_transfer_bytes           number
    ,inbound_data_transfer_cloud            text
    ,inbound_data_transfer_region           text
    ,inbound_data_transfer_bytes            number
    ,list_external_files_time               number
    ,credits_used_cloud_services            number
    ,release_version                        text
    ,external_function_total_invocations    number
    ,external_function_total_sent_rows      number
    ,external_function_total_received_rows  number
    ,external_function_total_sent_bytes     number
    ,external_function_total_received_bytes number
    ,query_load_percent                     number
    ,is_client_generated_statement          boolean
    --
    ,dw_file_name                           varchar( 250 )      not null
    ,dw_file_row_no                         number              not null
    ,dw_load_ts                             timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+-----------------------------------------------+
| status                                        |
|-----------------------------------------------|
| Table QUERY_HISTORY_STG successfully created. |
+-----------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.query_history
(
     dw_query_history_shk                           binary( 20 )        not null
    --
    ,organization_name                      varchar( 250 )      not null
    ,account_name                           varchar( 250 )      not null
    ,region_name                            varchar( 250 )      not null
    ,query_id                               text                not null
    ,query_text                             text                not null
    ,database_id                            number
    ,database_name                          text
    ,schema_id                              number
    ,schema_name                            text
    ,query_type                             text
    ,session_id                             number
    ,user_name                              text
    ,role_name                              text
    ,warehouse_id                           number
    ,warehouse_name                         text
    ,warehouse_size                         text
    ,warehouse_type                         text
    ,cluster_number                         number
    ,query_tag                              text
    ,execution_status                       text
    ,error_code                             number
    ,error_message                          text
    ,start_time                             timestamp_ltz
    ,end_time                               timestamp_ltz
    ,total_elapsed_time                     number
    ,bytes_scanned                          number
    ,percentage_scanned_from_cache          float
    ,bytes_written                          number
    ,bytes_written_to_result                number
    ,bytes_read_from_result                 number
    ,rows_produced                          number
    ,rows_inserted                          number
    ,rows_updated                           number
    ,rows_deleted                           number
    ,rows_unloaded                          number
    ,bytes_deleted                          number
    ,partitions_scanned                     number
    ,partitions_total                       number
    ,bytes_spilled_to_local_storage         number
    ,bytes_spilled_to_remote_storage        number
    ,bytes_sent_over_the_network            number
    ,compilation_time                       number
    ,execution_time                         number
    ,queued_provisioning_time               number
    ,queued_repair_time                     number
    ,queued_overload_time                   number
    ,transaction_blocked_time               number
    ,outbound_data_transfer_cloud           text
    ,outbound_data_transfer_region          text
    ,outbound_data_transfer_bytes           number
    ,inbound_data_transfer_cloud            text
    ,inbound_data_transfer_region           text
    ,inbound_data_transfer_bytes            number
    ,list_external_files_time               number
    ,credits_used_cloud_services            number
    ,release_version                        text
    ,external_function_total_invocations    number
    ,external_function_total_sent_rows      number
    ,external_function_total_received_rows  number
    ,external_function_total_sent_bytes     number
    ,external_function_total_received_bytes number
    ,query_load_percent                     number
    ,is_client_generated_statement          boolean
    --
    ,dw_file_name                           varchar( 250 )      not null
    ,dw_file_row_no                         number              not null
    ,dw_load_ts                             timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------+
| status                                    |
|-------------------------------------------|
| Table QUERY_HISTORY successfully created. |
+-------------------------------------------+
!source 200_raw/replication_usage_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history_stg
(
     organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    ,credits_used                   float               null
    ,bytes_transferred              float               null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+-----------------------------------------------------------+
| status                                                    |
|-----------------------------------------------------------|
| Table REPLICATION_USAGE_HISTORY_STG successfully created. |
+-----------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history
(
     dw_replication_usage_history_shk                   binary( 20 )        null
    --
    ,organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    ,credits_used                   float               null
    ,bytes_transferred              float               null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------------------+
| status                                                |
|-------------------------------------------------------|
| Table REPLICATION_USAGE_HISTORY successfully created. |
+-------------------------------------------------------+
!source 200_raw/search_optimization_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history_stg
(
     organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,table_id                       number              null
    ,table_name                     varchar( 250 )      null
    ,schema_id                      number              null
    ,schema_name                    varchar( 250 )      null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+-------------------------------------------------------------+
| status                                                      |
|-------------------------------------------------------------|
| Table SEARCH_OPTIMIZATION_HISTORY_STG successfully created. |
+-------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history
(
     dw_search_optimization_history_shk                   binary( 20 )        null
    --
    ,organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,table_id                       number              null
    ,table_name                     varchar( 250 )      null
    ,schema_id                      number              null
    ,schema_name                    varchar( 250 )      null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+---------------------------------------------------------+
| status                                                  |
|---------------------------------------------------------|
| Table SEARCH_OPTIMIZATION_HISTORY successfully created. |
+---------------------------------------------------------+
!source 200_raw/sf_compute_cost_lkp_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.sf_compute_cost_lkp
(
     organization_name              varchar( 250 )      not NULL
	,account_name                   varchar( 250 )      NOT null
    ,region_name                    varchar( 250 )      NOT null
    ,cost_amt                       float               not null
    ,active_dt                      date                not null
    ,inactive_dt                    date                not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------------+
| status                                          |
|-------------------------------------------------|
| Table SF_COMPUTE_COST_LKP successfully created. |
+-------------------------------------------------+
!source 200_raw/sf_data_xfer_cost_lkp_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.sf_data_xfer_cost_lkp
(
     organization_name              varchar( 250 )      not NULL
	,account_name                   varchar( 250 )      NOT null
    ,region_name                    varchar( 250 )      NOT null
    ,cost_amt                       float               not null
    ,active_dt                      date                not null
    ,inactive_dt                    date                not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+---------------------------------------------------+
| status                                            |
|---------------------------------------------------|
| Table SF_DATA_XFER_COST_LKP successfully created. |
+---------------------------------------------------+
!source 200_raw/sf_storage_cost_lkp_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.sf_storage_cost_lkp
(
     organization_name              varchar( 250 )      not NULL
	 ,account_name                   varchar( 250 )      NOT null
    ,region_name                    varchar( 250 )      NOT null
    ,cost_amt                       float               not null
    ,active_dt                      date                not null
    ,inactive_dt                    date                not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------------+
| status                                          |
|-------------------------------------------------|
| Table SF_STORAGE_COST_LKP successfully created. |
+-------------------------------------------------+
!source 200_raw/stage_storage_usage_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history_stg
(
     organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,usage_date                     date                not null
    ,average_stage_bytes            float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+-------------------------------------------------------------+
| status                                                      |
|-------------------------------------------------------------|
| Table STAGE_STORAGE_USAGE_HISTORY_STG successfully created. |
+-------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history
(
     dw_stage_storage_usage_history_shk                   binary( 20 )        not null
    --
    ,organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,usage_date                     date                not null
    ,average_stage_bytes            float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+---------------------------------------------------------+
| status                                                  |
|---------------------------------------------------------|
| Table STAGE_STORAGE_USAGE_HISTORY successfully created. |
+---------------------------------------------------------+
!source 200_raw/warehouse_load_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.warehouse_load_history_stg
(
     organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,start_time                     timestamp_ltz       not null
    ,end_time                       timestamp_ltz       not null
    ,warehouse_id                   number              not null
    ,warehouse_name                 varchar( 250 )      not null
    ,avg_running                    float               not null
    ,avg_queued_load                float               not null
    ,avg_queued_provisioning        float               not null
    ,avg_blocked                    float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+--------------------------------------------------------+
| status                                                 |
|--------------------------------------------------------|
| Table WAREHOUSE_LOAD_HISTORY_STG successfully created. |
+--------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.warehouse_load_history
(
     dw_warehouse_load_history_shk                   binary( 20 )        not null
    --
    ,organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,start_time                     timestamp_ltz       not null
    ,end_time                       timestamp_ltz       not null
    ,warehouse_id                   number              not null
    ,warehouse_name                 varchar( 250 )      not null
    ,avg_running                    float               not null
    ,avg_queued_load                float               not null
    ,avg_queued_provisioning        float               not null
    ,avg_blocked                    float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+----------------------------------------------------+
| status                                             |
|----------------------------------------------------|
| Table WAREHOUSE_LOAD_HISTORY successfully created. |
+----------------------------------------------------+
!source 200_raw/warehouse_metering_history_tbl.SQL
[Errno 2] No such file or directory: '200_raw/warehouse_metering_history_tbl.SQL'
If the error message is unclear, enable logging using -o log_level=DEBUG and see the log to find out the cause. Contact support for further help.
/*

cd "/Volumes/GoogleDrive/Shared drives/Professional Services/Service Delivery/Individual Folders/Greg Sitzman/3) In-Use/Data Cloud Deployment Framework/Scripts/Chargebacks/Account"

snowsql -c aws_cas2 -r mwebster_dev_sysadmin_fr -D l_env=dev -f chargebacks_ddl_orch.sql -o output_file=chargebacks_ddl_orch.out

*/

------------------------------------------------------------------------------
-- snowsql session
--
------------------------------------------------------------------------------
-- 000_admin
--
!print 000_admin
000_admin

!print set context -----------------------------------------------------------
set context -----------------------------------------------------------

!source 000_admin/dev_context_ddl.sql
------------------------------------------------------------------------------
-- context
--
!print set environment context
set environment context

!define l_common_db=DEV_PLAT_GOV_COMMON_DB
!define l_common_schema=UTIL

!define l_raw_db=DEV_PLAT_GOV_RL_DB
!define l_raw_schema=account_usage

!define l_il_db=DEV_PLAT_GOV_IL_DB
!define l_il_schema=USAGE_METRIC

!define l_pl_db=DEV_PLAT_GOV_PL_DB
!define l_pl_schema=REPORTING

!print SUCCESS!
SUCCESS!

!print execute ddl -----------------------------------------------------------
execute ddl -----------------------------------------------------------

!source 000_admin/account_ddl_orch.sql
------------------------------------------------------------------------------
-- 000_admin
--
!print 000_admin
000_admin

!source 000_admin/wrk_environment.sql
--------------------------------------------------------------------
--  Purpose: Internal stage for accout_usage data
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
--
--create schema if not exists &{l_target_db}.&{l_target_schema};
------------------------------------------------------------------------------
-- 900_common
--
!print 900_common
900_common

!source 900_common/account_usage_stg.sql
--------------------------------------------------------------------
--  Purpose: Internal stage for accout_usage data
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

---set variable_substitution=true. But set it to FALSE ---!set variable_substitution=true


create stage if not exists DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+--------------------------------------------------------+
| status                                                 |
|--------------------------------------------------------|
| ACCOUNT_USAGE_STG already exists, statement succeeded. |
+--------------------------------------------------------+
/*
url='azure://bysnow.blob.core.windows.net/admin/account_usage/'
credentials=(azure_sas_token="****&st=2021-06-01T00:00:00Z&se=2022-06-01T00:00:00Z&spr=https&sv=2020-02-10&sr=c&sig=****")
;

-- turn off session variable
*/


/*
--SET DATE_FOLDER = (SELECT REPLACE(TO_VARCHAR(TO_DATE(CURRENT_TIMESTAMP())),'-',''));
create or replace stage my_azure_stage
url='azure://bysnow.blob.core.windows.net/admin/account_usage/'
credentials=(azure_sas_token='sp=r&st=2021-06-01T00:00:00Z&se=2022-01-01T00:00:00Z&spr=https&sv=2020-02-10&sr=c&sig=****')
encryption=(type='AZURE_CSE' master_key = 'kPxX0jzYfIamtnJEUTHwq80Au6NbSgPH5r4BDDwOaO8=')
  file_format = my_csv_format;
*/
!source 900_common/date_sid_f.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
create or replace function DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f
(
    p_date             date
)
returns number
as
$$
    select to_number( to_char( p_date, 'yyyymmdd') )
$$
;
+-------------------------------------------+
| status                                    |
|-------------------------------------------|
| Function DATE_SID_F successfully created. |
+-------------------------------------------+
!source 900_common/dw_delta_date_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

create transient table if not exists DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date
(
     event_dt       timestamp_ltz not null
    ,dw_load_ts     timestamp_ltz not null
)
data_retention_time_in_days = 0
;
+----------------------------------------------------+
| status                                             |
|----------------------------------------------------|
| DW_DELTA_DATE already exists, statement succeeded. |
+----------------------------------------------------+

!source 900_common/dw_delta_date_ld_sp.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
create or replace procedure DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_ld_sp( P_SRC_TABLE varchar, P_SRC_COLUMN varchar )
returns varchar
language javascript
execute as caller
as
$$
    // variables
    var status          = 'success';
    var tracePos        = 'step 0';
    var sqlResult;
    var sqlCmd;

    try {
        // insert distinct dates into work table
        tracePos  = 'insert into';
        sqlCmd    = `
            insert overwrite into
                --DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date
                DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date
            select distinct
                 to_date( ${P_SRC_COLUMN} )
                ,current_timestamp()
            from
                ${P_SRC_TABLE};
            `;

        sqlResult = snowflake.execute( { sqlText: sqlCmd } );

    }
    catch (err) {
        status  = 'line: ' + tracePos;
        status += '\n failed: code: ' + err.code + '\n state: ' + err.state;
        status += '\n message: ' + err.message;
        status += '\n stack trace:\n' + err.stacktracetxt;
    }
    finally {
        return status;
    }
$$
;
+----------------------------------------------------+
| status                                             |
|----------------------------------------------------|
| Function DW_DELTA_DATE_LD_SP successfully created. |
+----------------------------------------------------+
!source 900_common/dw_delta_date_range_f.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
create or replace function DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f
(
    p_period_type_cd   varchar
)
returns table( start_dt timestamp_ltz, end_dt timestamp_ltz )
as
$$
    select
         start_dt
        ,end_dt
    from
        (
        select
             case lower( p_period_type_cd )
                 when 'all'     then current_date()
                 when 'day'     then date_trunc( day, event_dt )
                 when 'week'    then date_trunc( week, event_dt )
                 when 'month'   then date_trunc( month, event_dt )
                 when 'quarter' then date_trunc( quarter, event_dt )
                 when 'year'    then date_trunc( year, event_dt )
                 else current_date()
             end                as partition_dt
            ,min( event_dt ) as start_dt
            ,max( event_dt ) as end_dt
        from
            DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date
        group by
            1
        )
    order by
        1
$$
;
+------------------------------------------------------+
| status                                               |
|------------------------------------------------------|
| Function DW_DELTA_DATE_RANGE_F successfully created. |
+------------------------------------------------------+
!source 900_common/fcst_linear_trend_sp.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
create or replace procedure DEV_PLAT_GOV_COMMON_DB.UTIL.fcst_linear_trend_sp( P_SRC_TABLE varchar, P_TGT_TABLE varchar )
returns varchar
language javascript
execute as caller
as
$$
    // variables
    var status          = 'success';
    var tracePos        = 'step 0';
    var sqlResult;
    var sqlCmd;

    try {
        // create temp table with derived forecast
        tracePos  = 'derive forecast';
        sqlCmd    = `
            create or replace temporary table identifier( '${P_TGT_TABLE}' ) as
                    -- period-to-date sequence for time
                    with l_ptd as
                    (
                        select
                             s.partition_key
                            ,s.period_dt
                            ,s.year_no
                            ,s.period_no
                            ,s.measure_no
                            ,row_number( ) over( partition by s.partition_key order by s.period_dt )    as ptd_seq_no
                        from
                            identifier( '${P_SRC_TABLE}' ) s
                        order by
                            1,2
                    )
                    -- intercept and slope
                    ,l_int_slope as
                    (
                        select
                             partition_key
                            ,regr_intercept( measure_no, ptd_seq_no ) as intercept_no
                            ,regr_slope( measure_no, ptd_seq_no )     as slope_no
                        from
                            l_ptd
                        where
                            measure_no is not null
                        group by 1
                        order by 1
                    )
                    --forecast
                    ,l_forecast as
                    (
                        select
                             lp.partition_key
                            ,lp.period_dt
                            ,lp.year_no
                            ,lp.period_no
                            ,lp.measure_no
                            ,lp.ptd_seq_no
                            ,lis.intercept_no
                            ,lis.slope_no
                            ,(lis.slope_no * lp.ptd_seq_no) + lis.intercept_no as fcst_measure_no
                        from
                            l_ptd lp
                            join l_int_slope lis on
                                lis.partition_key = lp.partition_key
                        order by
                            1,2
                    )
                    select
                         lf.partition_key
                        ,lf.period_dt
                        ,lf.year_no
                        ,lf.period_no
                        ,lf.measure_no
                        ,lf.fcst_measure_no
                        ,object_construct(*)                as component_json
                    from
                        l_forecast lf
                    order by
                        1,2,3
            `;

        sqlResult = snowflake.execute( { sqlText: sqlCmd } );

    }
    catch (err) {
        status  = 'line: ' + tracePos;
        status += '\n failed: code: ' + err.code + '\n state: ' + err.state;
        status += '\n message: ' + err.message;
        status += '\n stack trace:\n' + err.stacktracetxt;
    }
    finally {
        return status;
    }
$$
;
+-----------------------------------------------------+
| status                                              |
|-----------------------------------------------------|
| Function FCST_LINEAR_TREND_SP successfully created. |
+-----------------------------------------------------+
!source 900_common/fcst_seasonal_trend_sp.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
create or replace procedure DEV_PLAT_GOV_COMMON_DB.UTIL.fcst_seasonal_trend_sp( P_SRC_TABLE varchar, P_TGT_TABLE varchar )
returns varchar
language javascript
execute as caller
as
$$
    // variables
    var status          = 'success';
    var tracePos        = 'step 0';
    var sqlResult;
    var sqlCmd;
    var mAvgLagNo;
    var mAvgLeadNo;

    try {
        // get moving avg lag and lead row counts
        // assumes model period is the same across partitions
        tracePos  = 'mavg lag rows';
        sqlCmd    = `select
                          trunc( count( distinct period_no ) / 2 )     as mavg_lag_no
                         ,round( count( distinct period_no ) / 2 ) - 1 as mavg_lead_no
                     from
                         identifier( '${P_SRC_TABLE}' )`;
        sqlResult = snowflake.execute( { sqlText: sqlCmd } );
        sqlResult.next();
        mAvgLagNo   = sqlResult.getColumnValue( 'MAVG_LAG_NO' );
        mAvgLeadNo  = sqlResult.getColumnValue( 'MAVG_LEAD_NO' );

        // create temp table with derived forecast
        tracePos  = 'derive forecast';
        sqlCmd    = `
            create or replace temporary table identifier( '${P_TGT_TABLE}' ) as
                    -- moving average
                    with l_mavg as
                    (
                        select
                             s.partition_key
                            ,s.period_dt
                            ,s.year_no
                            ,s.period_no
                            ,s.measure_no
                            ,case
                                when lag( s.measure_no, ${mAvgLagNo} ) over( partition by s.partition_key order by s.period_dt ) is not null
                                 and lead( s.measure_no, ${mAvgLeadNo} ) over( partition by s.partition_key order by s.period_dt ) is not null
                                then avg( s.measure_no ) over( partition by s.partition_key order by s.period_dt
                                                               rows between ${mAvgLagNo} preceding and ${mAvgLeadNo} following )
                                else null
                             end    as mavg_measure_no
                        from
                            identifier( '${P_SRC_TABLE}' ) s
                        order by
                            1,2
                    )
                    -- center moving average: current row and next row
                    ,l_cmavg as
                    (
                        select
                             partition_key
                            ,period_dt
                            ,year_no
                            ,period_no
                            ,measure_no
                            ,mavg_measure_no
                            ,case
                                when mavg_measure_no is not null
                                 and lead( mavg_measure_no, 1 ) over( partition by partition_key order by period_dt ) is not null
                                then avg( mavg_measure_no ) over( partition by partition_key order by period_dt rows between 0 preceding and 1 following )
                                else null
                             end    as cmavg_measure_no
                        from
                            l_mavg
                        order by
                            1,2
                    )
                    -- seasonal and irregular components
                    ,l_seasonal as
                    (
                        select
                             partition_key
                            ,period_dt
                            ,year_no
                            ,period_no
                            ,measure_no
                            ,mavg_measure_no
                            ,cmavg_measure_no
                            ,measure_no / cmavg_measure_no  as seasonal_no
                        from
                            l_cmavg
                        order by
                            1,2
                    )
                    -- period average of seasonal
                    ,l_pavg_seasonal as
                    (
                        select
                             partition_key
                            ,period_no
                            ,avg( seasonal_no ) as pavg_seasonal_no
                        from
                            l_seasonal
                        where
                            seasonal_no is not null
                        group by 1,2
                        order by 1,2
                    )
                    -- deseasonalize with period avg and calc period-to-date sequence
                    ,l_deseason as
                    (
                        select
                             ls.partition_key
                            ,ls.period_dt
                            ,ls.year_no
                            ,ls.period_no
                            ,ls.measure_no
                            ,ls.mavg_measure_no
                            ,ls.cmavg_measure_no
                            ,ls.seasonal_no
                            ,lps.pavg_seasonal_no
                            ,case
                                when lps.pavg_seasonal_no is not null
                                then ls.measure_no / lps.pavg_seasonal_no
                                else 1
                             end                                                                                    as deseason_measure_no
                            ,row_number( ) over( partition by ls.partition_key order by ls.period_dt )  as ptd_seq_no
                        from
                            l_seasonal ls
                            left join l_pavg_seasonal lps on
                                    lps.partition_key = ls.partition_key
                                and lps.period_no     = ls.period_no
                        order by
                          1,2,3
                    )
                    -- intercept and slope
                    ,l_int_slope as
                    (
                        select
                             partition_key
                            ,regr_intercept( deseason_measure_no, ptd_seq_no ) as intercept_no
                            ,regr_slope( deseason_measure_no, ptd_seq_no )     as slope_no
                        from
                            l_deseason
                        where
                            deseason_measure_no is not null
                        group by 1
                        order by 1
                    )
                    -- trend
                    ,l_trend as
                    (
                        select
                             ld.partition_key
                            ,ld.period_dt
                            ,ld.year_no
                            ,ld.period_no
                            ,ld.measure_no
                            ,ld.mavg_measure_no
                            ,ld.cmavg_measure_no
                            ,ld.seasonal_no
                            ,ld.pavg_seasonal_no
                            ,ld.deseason_measure_no
                            ,ld.ptd_seq_no
                            ,lis.intercept_no
                            ,lis.slope_no
                            ,(lis.slope_no * ld.ptd_seq_no) + lis.intercept_no as trend_no
                        from
                            l_deseason ld
                            join l_int_slope lis on
                                lis.partition_key = ld.partition_key
                        order by
                            1,2
                    )
                    --forecast
                    ,l_forecast as
                    (
                        select
                             lt.partition_key
                            ,lt.period_dt
                            ,lt.year_no
                            ,lt.period_no
                            ,lt.measure_no
                            ,${mAvgLagNo}       as p_mavg_lag_no
                            ,${mAvgLeadNo}      as p_mavg_lead_no
                            ,lt.mavg_measure_no
                            ,lt.cmavg_measure_no
                            ,lt.seasonal_no
                            ,lt.pavg_seasonal_no
                            ,lt.deseason_measure_no
                            ,lt.ptd_seq_no
                            ,lt.intercept_no
                            ,lt.slope_no
                            ,lt.trend_no
                            ,lt.pavg_seasonal_no * lt.trend_no     as fcst_measure_no
                        from
                            l_trend lt
                        order by
                            1,2
                    )
                    select
                         lf.partition_key
                        ,lf.period_dt
                        ,lf.year_no
                        ,lf.period_no
                        ,lf.measure_no
                        ,lf.fcst_measure_no
                        ,object_construct(*)                as component_json
                    from
                        l_forecast lf
                    order by
                        1,2`;

        sqlResult = snowflake.execute( { sqlText: sqlCmd } );

    }
    catch (err) {
        status  = 'line: ' + tracePos;
        status += '\n failed: code: ' + err.code + '\n state: ' + err.state;
        status += '\n message: ' + err.message;
        status += '\n stack trace:\n' + err.stacktracetxt;
    }
    finally {
        return status;
    }
$$
;
+-------------------------------------------------------+
| status                                                |
|-------------------------------------------------------|
| Function FCST_SEASONAL_TREND_SP successfully created. |
+-------------------------------------------------------+
------------------------------------------------------------------------------
-- 100_acquisition
--
!print 100_acquisition
100_acquisition
------------------------------------------------------------------------------
-- 200_raw
--
!print 200_raw
200_raw

!source 200_raw/automatic_clustering_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history_stg
(
     organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,num_bytes_reclustered          number              null
    ,num_rows_reclustered           number              null
    ,table_id                       number              null
    ,table_name                     varchar( 250 )      null
    ,schema_id                      number              null
    ,schema_name                    varchar( 250 )      null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+-----------------------------------------------------------------------+
| status                                                                |
|-----------------------------------------------------------------------|
| AUTOMATIC_CLUSTERING_HISTORY_STG already exists, statement succeeded. |
+-----------------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history
(
     dw_automatic_clustering_history_shk                   binary( 20 )        null
    --
    ,organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,num_bytes_reclustered          number              null
    ,num_rows_reclustered           number              null
    ,table_id                       number              null
    ,table_name                     varchar( 250 )      null
    ,schema_id                      number              null
    ,schema_name                    varchar( 250 )      null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------------------------------+
| status                                                            |
|-------------------------------------------------------------------|
| AUTOMATIC_CLUSTERING_HISTORY already exists, statement succeeded. |
+-------------------------------------------------------------------+
!source 200_raw/be_resource_mapping_lkp_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.be_resource_mapping_lkp
(
     match_pattern                  varchar( 100 )
    ,priority_no                    number
    ,tag_json                       variant
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+--------------------------------------------------------------+
| status                                                       |
|--------------------------------------------------------------|
| BE_RESOURCE_MAPPING_LKP already exists, statement succeeded. |
+--------------------------------------------------------------+
!source 200_raw/cb_service_type_lkp_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp
(
     dw_service_type_shk            binary( 20 )        not null
    ,dw_hash_diff                   binary( 20 )        not null
    ,service_type_cd                varchar( 50 )       not null
    ,service_type_name              varchar( 250 )      not null
    ,service_type_group_name        varchar( 250 )      not null
    ,active_dt                      date                not null
    ,inactive_dt                    date                not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
    ,dw_update_ts                   timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+----------------------------------------------------------+
| status                                                   |
|----------------------------------------------------------|
| CB_SERVICE_TYPE_LKP already exists, statement succeeded. |
+----------------------------------------------------------+
!source 200_raw/data_transfer_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history_stg
(
     organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,start_time                     timestamp_ltz       not null
    ,end_time                       timestamp_ltz       not null
    ,source_cloud                   varchar( 250 )
    ,source_region                  varchar( 250 )
    ,target_cloud                   varchar( 250 )
    ,target_region                  varchar( 250 )
    ,bytes_transferred              number
    ,transfer_type                  varchar( 250 )
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+----------------------------------------------------------------+
| status                                                         |
|----------------------------------------------------------------|
| DATA_TRANSFER_HISTORY_STG already exists, statement succeeded. |
+----------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history
(
     dw_data_transfer_history_shk                   binary( 20 )        not null
    --
    ,organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,start_time                     timestamp_ltz       not null
    ,end_time                       timestamp_ltz       not null
    ,source_cloud                   varchar( 250 )
    ,source_region                  varchar( 250 )
    ,target_cloud                   varchar( 250 )
    ,target_region                  varchar( 250 )
    ,bytes_transferred              number
    ,transfer_type                  varchar( 250 )
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+------------------------------------------------------------+
| status                                                     |
|------------------------------------------------------------|
| DATA_TRANSFER_HISTORY already exists, statement succeeded. |
+------------------------------------------------------------+
!source 200_raw/database_storage_usage_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history_stg
(
     organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,usage_date                     date                not null
    ,database_id                    number              not null
    ,database_name                  varchar( 250 )      not null
    ,deleted                        timestamp_ltz           null
    ,average_database_bytes         float               not null
    ,average_failsafe_bytes         float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+-------------------------------------------------------------------------+
| status                                                                  |
|-------------------------------------------------------------------------|
| DATABASE_STORAGE_USAGE_HISTORY_STG already exists, statement succeeded. |
+-------------------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history
(
     dw_database_storage_usage_history_shk                   binary( 20 )        not null
    --
    ,organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,usage_date                     date                not null
    ,database_id                    number              not null
    ,database_name                  varchar( 250 )      not null
    ,deleted                        timestamp_ltz           null
    ,average_database_bytes         float               not null
    ,average_failsafe_bytes         float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+---------------------------------------------------------------------+
| status                                                              |
|---------------------------------------------------------------------|
| DATABASE_STORAGE_USAGE_HISTORY already exists, statement succeeded. |
+---------------------------------------------------------------------+
!source 200_raw/materialized_view_refresh_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history_stg
(
     organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,table_id                       number              null
    ,table_name                     varchar( 250 )      null
    ,schema_id                      number              null
    ,schema_name                    varchar( 250 )      null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+----------------------------------------------------------------------------+
| status                                                                     |
|----------------------------------------------------------------------------|
| MATERIALIZED_VIEW_REFRESH_HISTORY_STG already exists, statement succeeded. |
+----------------------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history
(
     dw_materialized_view_refresh_history_shk                   binary( 20 )        null
    --
    ,organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,table_id                       number              null
    ,table_name                     varchar( 250 )      null
    ,schema_id                      number              null
    ,schema_name                    varchar( 250 )      null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+------------------------------------------------------------------------+
| status                                                                 |
|------------------------------------------------------------------------|
| MATERIALIZED_VIEW_REFRESH_HISTORY already exists, statement succeeded. |
+------------------------------------------------------------------------+
!source 200_raw/metering_daily_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.metering_daily_history_stg
(
     organization_name                  varchar( 250 )      not null
    ,account_name                       varchar( 250 )      not null
    ,region_name                        varchar( 250 )      not null
    ,service_type                       varchar( 250 )      not null
    ,usage_date                         timestamp_ltz       not null
    ,credits_used_compute               number              not null
    ,credits_used_cloud_services        number              not null
    ,credits_used                       number              not null
    ,credits_adjustment_cloud_services  number              not null
    ,credits_billed                     number              not null
    --
    ,dw_file_name                       varchar( 250 )      not null
    ,dw_file_row_no                     number              not null
    ,dw_load_ts                         timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+-----------------------------------------------------------------+
| status                                                          |
|-----------------------------------------------------------------|
| METERING_DAILY_HISTORY_STG already exists, statement succeeded. |
+-----------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.metering_daily_history
(
     dw_metering_daily_history_shk                       binary( 20 )        not null
    --
    ,organization_name                  varchar( 250 )      not null
    ,account_name                       varchar( 250 )      not null
    ,region_name                        varchar( 250 )      not null
    ,service_type                       varchar( 250 )      not null
    ,usage_date                         timestamp_ltz       not null
    ,credits_used_compute               number              not null
    ,credits_used_cloud_services        number              not null
    ,credits_used                       number              not null
    ,credits_adjustment_cloud_services  number              not null
    ,credits_billed                     number              not null
    --
    ,dw_file_name                       varchar( 250 )      not null
    ,dw_file_row_no                     number              not null
    ,dw_load_ts                         timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------------------------+
| status                                                      |
|-------------------------------------------------------------|
| METERING_DAILY_HISTORY already exists, statement succeeded. |
+-------------------------------------------------------------+
!source 200_raw/pipe_usage_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history_stg
(
     organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,bytes_inserted                 number              null
    ,files_inserted                 number              null
    ,pipe_id                        number              null
    ,pipe_name                      varchar( 250 )      null
    ,schema_name                    varchar( 250 )      null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+-------------------------------------------------------------+
| status                                                      |
|-------------------------------------------------------------|
| PIPE_USAGE_HISTORY_STG already exists, statement succeeded. |
+-------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history
(
     dw_pipe_usage_history_shk                   binary( 20 )        null
    --
    ,organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,bytes_inserted                 number              null
    ,files_inserted                 number              null
    ,pipe_id                        number              null
    ,pipe_name                      varchar( 250 )      null
    ,schema_name                    varchar( 250 )      null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+---------------------------------------------------------+
| status                                                  |
|---------------------------------------------------------|
| PIPE_USAGE_HISTORY already exists, statement succeeded. |
+---------------------------------------------------------+
!source 200_raw/query_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.query_history_stg
(
     organization_name                      varchar( 250 )      not null
    ,account_name                           varchar( 250 )      not null
    ,region_name                            varchar( 250 )      not null
    ,query_id                               text                not null
    ,query_text                             text                not null
    ,database_id                            number
    ,database_name                          text
    ,schema_id                              number
    ,schema_name                            text
    ,query_type                             text
    ,session_id                             number
    ,user_name                              text
    ,role_name                              text
    ,warehouse_id                           number
    ,warehouse_name                         text
    ,warehouse_size                         text
    ,warehouse_type                         text
    ,cluster_number                         number
    ,query_tag                              text
    ,execution_status                       text
    ,error_code                             number
    ,error_message                          text
    ,start_time                             timestamp_ltz
    ,end_time                               timestamp_ltz
    ,total_elapsed_time                     number
    ,bytes_scanned                          number
    ,percentage_scanned_from_cache          float
    ,bytes_written                          number
    ,bytes_written_to_result                number
    ,bytes_read_from_result                 number
    ,rows_produced                          number
    ,rows_inserted                          number
    ,rows_updated                           number
    ,rows_deleted                           number
    ,rows_unloaded                          number
    ,bytes_deleted                          number
    ,partitions_scanned                     number
    ,partitions_total                       number
    ,bytes_spilled_to_local_storage         number
    ,bytes_spilled_to_remote_storage        number
    ,bytes_sent_over_the_network            number
    ,compilation_time                       number
    ,execution_time                         number
    ,queued_provisioning_time               number
    ,queued_repair_time                     number
    ,queued_overload_time                   number
    ,transaction_blocked_time               number
    ,outbound_data_transfer_cloud           text
    ,outbound_data_transfer_region          text
    ,outbound_data_transfer_bytes           number
    ,inbound_data_transfer_cloud            text
    ,inbound_data_transfer_region           text
    ,inbound_data_transfer_bytes            number
    ,list_external_files_time               number
    ,credits_used_cloud_services            number
    ,release_version                        text
    ,external_function_total_invocations    number
    ,external_function_total_sent_rows      number
    ,external_function_total_received_rows  number
    ,external_function_total_sent_bytes     number
    ,external_function_total_received_bytes number
    ,query_load_percent                     number
    ,is_client_generated_statement          boolean
    --
    ,dw_file_name                           varchar( 250 )      not null
    ,dw_file_row_no                         number              not null
    ,dw_load_ts                             timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+--------------------------------------------------------+
| status                                                 |
|--------------------------------------------------------|
| QUERY_HISTORY_STG already exists, statement succeeded. |
+--------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.query_history
(
     dw_query_history_shk                           binary( 20 )        not null
    --
    ,organization_name                      varchar( 250 )      not null
    ,account_name                           varchar( 250 )      not null
    ,region_name                            varchar( 250 )      not null
    ,query_id                               text                not null
    ,query_text                             text                not null
    ,database_id                            number
    ,database_name                          text
    ,schema_id                              number
    ,schema_name                            text
    ,query_type                             text
    ,session_id                             number
    ,user_name                              text
    ,role_name                              text
    ,warehouse_id                           number
    ,warehouse_name                         text
    ,warehouse_size                         text
    ,warehouse_type                         text
    ,cluster_number                         number
    ,query_tag                              text
    ,execution_status                       text
    ,error_code                             number
    ,error_message                          text
    ,start_time                             timestamp_ltz
    ,end_time                               timestamp_ltz
    ,total_elapsed_time                     number
    ,bytes_scanned                          number
    ,percentage_scanned_from_cache          float
    ,bytes_written                          number
    ,bytes_written_to_result                number
    ,bytes_read_from_result                 number
    ,rows_produced                          number
    ,rows_inserted                          number
    ,rows_updated                           number
    ,rows_deleted                           number
    ,rows_unloaded                          number
    ,bytes_deleted                          number
    ,partitions_scanned                     number
    ,partitions_total                       number
    ,bytes_spilled_to_local_storage         number
    ,bytes_spilled_to_remote_storage        number
    ,bytes_sent_over_the_network            number
    ,compilation_time                       number
    ,execution_time                         number
    ,queued_provisioning_time               number
    ,queued_repair_time                     number
    ,queued_overload_time                   number
    ,transaction_blocked_time               number
    ,outbound_data_transfer_cloud           text
    ,outbound_data_transfer_region          text
    ,outbound_data_transfer_bytes           number
    ,inbound_data_transfer_cloud            text
    ,inbound_data_transfer_region           text
    ,inbound_data_transfer_bytes            number
    ,list_external_files_time               number
    ,credits_used_cloud_services            number
    ,release_version                        text
    ,external_function_total_invocations    number
    ,external_function_total_sent_rows      number
    ,external_function_total_received_rows  number
    ,external_function_total_sent_bytes     number
    ,external_function_total_received_bytes number
    ,query_load_percent                     number
    ,is_client_generated_statement          boolean
    --
    ,dw_file_name                           varchar( 250 )      not null
    ,dw_file_row_no                         number              not null
    ,dw_load_ts                             timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+----------------------------------------------------+
| status                                             |
|----------------------------------------------------|
| QUERY_HISTORY already exists, statement succeeded. |
+----------------------------------------------------+
!source 200_raw/replication_usage_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history_stg
(
     organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    ,credits_used                   float               null
    ,bytes_transferred              float               null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+--------------------------------------------------------------------+
| status                                                             |
|--------------------------------------------------------------------|
| REPLICATION_USAGE_HISTORY_STG already exists, statement succeeded. |
+--------------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history
(
     dw_replication_usage_history_shk                   binary( 20 )        null
    --
    ,organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    ,credits_used                   float               null
    ,bytes_transferred              float               null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+----------------------------------------------------------------+
| status                                                         |
|----------------------------------------------------------------|
| REPLICATION_USAGE_HISTORY already exists, statement succeeded. |
+----------------------------------------------------------------+
!source 200_raw/search_optimization_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history_stg
(
     organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,table_id                       number              null
    ,table_name                     varchar( 250 )      null
    ,schema_id                      number              null
    ,schema_name                    varchar( 250 )      null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+----------------------------------------------------------------------+
| status                                                               |
|----------------------------------------------------------------------|
| SEARCH_OPTIMIZATION_HISTORY_STG already exists, statement succeeded. |
+----------------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history
(
     dw_search_optimization_history_shk                   binary( 20 )        null
    --
    ,organization_name              varchar( 250 )      null
    ,account_name                   varchar( 250 )      null
    ,region_name                    varchar( 250 )      null
    ,start_time                     timestamp_ltz       null
    ,end_time                       timestamp_ltz       null
    ,credits_used                   float               null
    ,table_id                       number              null
    ,table_name                     varchar( 250 )      null
    ,schema_id                      number              null
    ,schema_name                    varchar( 250 )      null
    ,database_id                    number              null
    ,database_name                  varchar( 250 )      null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+------------------------------------------------------------------+
| status                                                           |
|------------------------------------------------------------------|
| SEARCH_OPTIMIZATION_HISTORY already exists, statement succeeded. |
+------------------------------------------------------------------+
!source 200_raw/sf_compute_cost_lkp_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.sf_compute_cost_lkp
(
     organization_name              varchar( 250 )      not NULL
	,account_name                   varchar( 250 )      NOT null
    ,region_name                    varchar( 250 )      NOT null
    ,cost_amt                       float               not null
    ,active_dt                      date                not null
    ,inactive_dt                    date                not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+----------------------------------------------------------+
| status                                                   |
|----------------------------------------------------------|
| SF_COMPUTE_COST_LKP already exists, statement succeeded. |
+----------------------------------------------------------+
!source 200_raw/sf_data_xfer_cost_lkp_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.sf_data_xfer_cost_lkp
(
     organization_name              varchar( 250 )      not NULL
	,account_name                   varchar( 250 )      NOT null
    ,region_name                    varchar( 250 )      NOT null
    ,cost_amt                       float               not null
    ,active_dt                      date                not null
    ,inactive_dt                    date                not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+------------------------------------------------------------+
| status                                                     |
|------------------------------------------------------------|
| SF_DATA_XFER_COST_LKP already exists, statement succeeded. |
+------------------------------------------------------------+
!source 200_raw/sf_storage_cost_lkp_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.sf_storage_cost_lkp
(
     organization_name              varchar( 250 )      not NULL
	 ,account_name                   varchar( 250 )      NOT null
    ,region_name                    varchar( 250 )      NOT null
    ,cost_amt                       float               not null
    ,active_dt                      date                not null
    ,inactive_dt                    date                not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+----------------------------------------------------------+
| status                                                   |
|----------------------------------------------------------|
| SF_STORAGE_COST_LKP already exists, statement succeeded. |
+----------------------------------------------------------+
!source 200_raw/stage_storage_usage_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history_stg
(
     organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,usage_date                     date                not null
    ,average_stage_bytes            float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+----------------------------------------------------------------------+
| status                                                               |
|----------------------------------------------------------------------|
| STAGE_STORAGE_USAGE_HISTORY_STG already exists, statement succeeded. |
+----------------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history
(
     dw_stage_storage_usage_history_shk                   binary( 20 )        not null
    --
    ,organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,usage_date                     date                not null
    ,average_stage_bytes            float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+------------------------------------------------------------------+
| status                                                           |
|------------------------------------------------------------------|
| STAGE_STORAGE_USAGE_HISTORY already exists, statement succeeded. |
+------------------------------------------------------------------+
!source 200_raw/warehouse_load_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.warehouse_load_history_stg
(
     organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,start_time                     timestamp_ltz       not null
    ,end_time                       timestamp_ltz       not null
    ,warehouse_id                   number              not null
    ,warehouse_name                 varchar( 250 )      not null
    ,avg_running                    float               not null
    ,avg_queued_load                float               not null
    ,avg_queued_provisioning        float               not null
    ,avg_blocked                    float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+-----------------------------------------------------------------+
| status                                                          |
|-----------------------------------------------------------------|
| WAREHOUSE_LOAD_HISTORY_STG already exists, statement succeeded. |
+-----------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.warehouse_load_history
(
     dw_warehouse_load_history_shk                   binary( 20 )        not null
    --
    ,organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,start_time                     timestamp_ltz       not null
    ,end_time                       timestamp_ltz       not null
    ,warehouse_id                   number              not null
    ,warehouse_name                 varchar( 250 )      not null
    ,avg_running                    float               not null
    ,avg_queued_load                float               not null
    ,avg_queued_provisioning        float               not null
    ,avg_blocked                    float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------------------------+
| status                                                      |
|-------------------------------------------------------------|
| WAREHOUSE_LOAD_HISTORY already exists, statement succeeded. |
+-------------------------------------------------------------+
!source 200_raw/warehouse_metering_history_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_stg
(
     organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,start_time                     timestamp_ltz       not null
    ,end_time                       timestamp_ltz       not null
    ,warehouse_id                   number              not null
    ,warehouse_name                 varchar( 250 )      not null
    ,credits_used                   float               not null
    ,credits_used_compute           float               not null
    ,credits_used_cloud_services    float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+------------------------------------------------------------+
| status                                                     |
|------------------------------------------------------------|
| Table WAREHOUSE_METERING_HISTORY_STG successfully created. |
+------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history
(
     dw_warehouse_metering_history_shk                   binary( 20 )        not null
    --
    ,organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,start_time                     timestamp_ltz       not null
    ,end_time                       timestamp_ltz       not null
    ,warehouse_id                   number              not null
    ,warehouse_name                 varchar( 250 )      not null
    ,credits_used                   float               not null
    ,credits_used_compute           float               not null
    ,credits_used_cloud_services    float               not null
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+--------------------------------------------------------+
| status                                                 |
|--------------------------------------------------------|
| Table WAREHOUSE_METERING_HISTORY successfully created. |
+--------------------------------------------------------+
-- For reader accounts
!source 200_raw/be_budget_cost_lkp_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.be_budget_cost_lkp
(
     be_name                        varchar( 250 )      not NULL
    ,month_begin_dt                 date                NOT null
    ,compute_credit_cnt             float               not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+------------------------------------------------+
| status                                         |
|------------------------------------------------|
| Table BE_BUDGET_COST_LKP successfully created. |
+------------------------------------------------+
!source 200_raw/warehouse_metering_history_reader_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_reader_stg
(
     organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not NULL
    ,reader_account_name            varchar( 250 )      NOT null
    ,start_time                     timestamp_ltz       not null
    ,end_time                       timestamp_ltz       not null
    ,warehouse_id                   number              not null
    ,warehouse_name                 varchar( 250 )      not null
    ,credits_used                   float               not null
    ,credits_used_compute           float               not null
    ,credits_used_cloud_services    float               not NULL
    ,reader_account_deleted_on      timestamp_ltz       
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+-------------------------------------------------------------------+
| status                                                            |
|-------------------------------------------------------------------|
| Table WAREHOUSE_METERING_HISTORY_READER_STG successfully created. |
+-------------------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_reader
(
     dw_warehouse_metering_history_shk                   binary( 20 )        not null
    --
    ,organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not NULL
    ,reader_account_name            varchar( 250 )      NOT null
    ,start_time                     timestamp_ltz       not null
    ,end_time                       timestamp_ltz       not null
    ,warehouse_id                   number              not null
    ,warehouse_name                 varchar( 250 )      not null
    ,credits_used                   float               not null
    ,credits_used_compute           float               not null
    ,credits_used_cloud_services    float               not NULL
    ,reader_account_deleted_on      timestamp_ltz       
    --
    ,dw_file_name                   varchar( 250 )      not null
    ,dw_file_row_no                 number              not null
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+---------------------------------------------------------------+
| status                                                        |
|---------------------------------------------------------------|
| Table WAREHOUSE_METERING_HISTORY_READER successfully created. |
+---------------------------------------------------------------+
!source 200_raw/query_history_reader_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- transient staging table with no retention days
--
create transient table if not exists DEV_PLAT_GOV_RL_DB.account_usage.query_history_reader_stg
(
     organization_name                      varchar( 250 )      not null
    ,account_name                           varchar( 250 )      not null
    ,region_name                            varchar( 250 )      not NULL
    ,reader_account_name                    varchar( 250 )      NOT null
    ,query_id                               text                not null
    ,query_text                             text                not null
    ,database_id                            number
    ,database_name                          text
    ,schema_id                              number
    ,schema_name                            text
    ,query_type                             text
    ,session_id                             number
    ,user_name                              text
    ,role_name                              text
    ,warehouse_id                           number
    ,warehouse_name                         text
    ,warehouse_size                         text
    ,warehouse_type                         text
    ,cluster_number                         number
    ,query_tag                              text
    ,execution_status                       text
    ,error_code                             number
    ,error_message                          text
    ,start_time                             timestamp_ltz
    ,end_time                               timestamp_ltz
    ,total_elapsed_time                     number
    ,bytes_scanned                          number
    ,rows_produced                          number
    ,compilation_time                       number
    ,execution_time                         number
    ,queued_provisioning_time               number
    ,queued_repair_time                     number
    ,queued_overload_time                   number
    ,transaction_blocked_time               number
    ,outbound_data_transfer_cloud           text
    ,outbound_data_transfer_region          text
    ,outbound_data_transfer_bytes           number
    ,inbound_data_transfer_cloud            text
    ,inbound_data_transfer_region           text
    ,inbound_data_transfer_bytes            number
    ,list_external_files_time               number
    ,credits_used_cloud_services            number
    ,reader_account_deleted_on              timestamp_ltz
    --
    ,dw_file_name                           varchar( 250 )      not null
    ,dw_file_row_no                         number              not null
    ,dw_load_ts                             timestamp_ltz       not null
)
data_retention_time_in_days = 0
;
+------------------------------------------------------+
| status                                               |
|------------------------------------------------------|
| Table QUERY_HISTORY_READER_STG successfully created. |
+------------------------------------------------------+
--
-- permanent history table with retention days
--
create table if not exists DEV_PLAT_GOV_RL_DB.account_usage.query_history_reader
(
     dw_query_history_shk                   binary( 20 )        not null
    --
    ,organization_name                      varchar( 250 )      not null
    ,account_name                           varchar( 250 )      not null
    ,region_name                            varchar( 250 )      not NULL
    ,reader_account_name                    varchar( 250 )      NOT null
    ,query_id                               text                not null
    ,query_text                             text                not null
    ,database_id                            number
    ,database_name                          text
    ,schema_id                              number
    ,schema_name                            text
    ,query_type                             text
    ,session_id                             number
    ,user_name                              text
    ,role_name                              text
    ,warehouse_id                           number
    ,warehouse_name                         text
    ,warehouse_size                         text
    ,warehouse_type                         text
    ,cluster_number                         number
    ,query_tag                              text
    ,execution_status                       text
    ,error_code                             number
    ,error_message                          text
    ,start_time                             timestamp_ltz
    ,end_time                               timestamp_ltz
    ,total_elapsed_time                     number
    ,bytes_scanned                          number
    ,rows_produced                          number
    ,compilation_time                       number
    ,execution_time                         number
    ,queued_provisioning_time               number
    ,queued_repair_time                     number
    ,queued_overload_time                   number
    ,transaction_blocked_time               number
    ,outbound_data_transfer_cloud           text
    ,outbound_data_transfer_region          text
    ,outbound_data_transfer_bytes           number
    ,inbound_data_transfer_cloud            text
    ,inbound_data_transfer_region           text
    ,inbound_data_transfer_bytes            number
    ,list_external_files_time               number
    ,credits_used_cloud_services            number
    ,reader_account_deleted_on              timestamp_ltz
    --
    ,dw_file_name                           varchar( 250 )      not null
    ,dw_file_row_no                         number              not null
    ,dw_load_ts                             timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+--------------------------------------------------+
| status                                           |
|--------------------------------------------------|
| Table QUERY_HISTORY_READER successfully created. |
+--------------------------------------------------+
------------------------------------------------------------------------------
-- 300_integration
--
!print 300_integration
300_integration

!source 300_integration/cb_account_h_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h
(
     dw_account_shk                 binary( 20 )        not null
    --
    ,organization_name              varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not NULL
    ,reader_account_name            varchar( 250 )      NOT null
    --
    ,dw_load_ts                     timestamp_ltz       not null
    ,dw_update_ts                   timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+------------------------------------------+
| status                                   |
|------------------------------------------|
| Table CB_ACCOUNT_H successfully created. |
+------------------------------------------+
!source 300_integration/cb_be_h_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_be_h
(
     dw_be_shk                binary( 20 )        not null
    --
    ,be_name                  varchar( 250 )      not null
    --
    ,dw_load_ts               timestamp_ltz       not null
    ,dw_update_ts             timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------+
| status                              |
|-------------------------------------|
| Table CB_BE_H successfully created. |
+-------------------------------------+
!source 300_integration/cb_account_resource_l_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_resource_l
(
     dw_account_shk                 binary( 20 )        not null
    ,dw_resource_shk                binary( 20 )        not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
    ,dw_update_ts                   timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+---------------------------------------------------+
| status                                            |
|---------------------------------------------------|
| Table CB_ACCOUNT_RESOURCE_L successfully created. |
+---------------------------------------------------+
!source 300_integration/cb_resource_h_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h
(
     dw_resource_shk                binary( 20 )        not null
    --
    ,organization_name              varchar( 250 )      not null
    ,region_name                    varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not NULL
    ,reader_account_name            varchar( 250 )      NOT null
    ,resource_name                  varchar( 250 )      not null
    ,resource_type_cd               varchar( 50 )       not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
    ,dw_update_ts                   timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------+
| status                                    |
|-------------------------------------------|
| Table CB_RESOURCE_H successfully created. |
+-------------------------------------------+
------------------------------------------------------------------------------
-- 310_derivation
--
!print 310_derivation
310_derivation

!source 310_derivation/be_resource_mapping_s_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.be_resource_mapping_s
(
     dw_resource_shk                binary( 20 )        not null
    ,be_name                        varchar( 250 )      not null
    ,tag_json                       variant
    --
    ,priority_no                    number
    ,match_pattern                  varchar( 100 )
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+---------------------------------------------------+
| status                                            |
|---------------------------------------------------|
| Table BE_RESOURCE_MAPPING_S successfully created. |
+---------------------------------------------------+
!source 310_derivation/cb_account_consumption_fcst_ms_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_fcst_ms
(
     dw_account_shk                 binary( 20 )
    ,dw_event_date_sid              number
    --
    ,event_month_dt                 date
    ,total_cost_amt                 float
    ,fcst_total_cost_amt            float
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+------------------------------------------------------------+
| status                                                     |
|------------------------------------------------------------|
| Table CB_ACCOUNT_CONSUMPTION_FCST_MS successfully created. |
+------------------------------------------------------------+
!source 310_derivation/cb_account_consumption_ds_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_ds
(
     dw_account_shk                 binary( 20 )
    ,dw_event_date_sid              number
    --
    ,event_dt                       date
    ,compute_credit_cnt             float
    ,compute_cost_amt               float
    ,storage_byte_cnt               number
    ,storage_tb_cnt                 float
    ,storage_cost_amt               float
    ,data_xfer_byte_cnt             number
    ,data_xfer_tb_cnt               float
    ,data_xfer_cost_amt             float
    ,total_cost_amt                 float
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------------------+
| status                                                |
|-------------------------------------------------------|
| Table CB_ACCOUNT_CONSUMPTION_DS successfully created. |
+-------------------------------------------------------+
!source 310_derivation/cb_resource_consumption_ds_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_consumption_ds
(
     dw_account_shk                 binary( 20 )
    ,dw_resource_shk                binary( 20 )
    ,dw_service_type_shk            binary( 20 )
    ,dw_event_date_sid              number
    --
    ,event_dt                       date
    ,compute_credit_cnt             float
    ,compute_cost_amt               float
    ,storage_byte_cnt               number
    ,storage_tb_cnt                 float
    ,storage_cost_amt               float
    ,data_xfer_byte_cnt             number
    ,data_xfer_tb_cnt               float
    ,data_xfer_cost_amt             float
    ,total_cost_amt                 float
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+--------------------------------------------------------+
| status                                                 |
|--------------------------------------------------------|
| Table CB_RESOURCE_CONSUMPTION_DS successfully created. |
+--------------------------------------------------------+
!source 310_derivation/cb_account_consumption_ms_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_ms
(
     dw_account_shk                 binary( 20 )
    ,dw_event_date_sid              number
    --
    ,event_month_dt                 date
    ,compute_credit_cnt             float
    ,compute_cost_amt               float
    ,storage_byte_cnt               number
    ,storage_tb_cnt                 float
    ,storage_cost_amt               float
    ,data_xfer_byte_cnt             number
    ,data_xfer_tb_cnt               float
    ,data_xfer_cost_amt             float
    ,total_cost_amt                 float
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------------------+
| status                                                |
|-------------------------------------------------------|
| Table CB_ACCOUNT_CONSUMPTION_MS successfully created. |
+-------------------------------------------------------+
!source 310_derivation/cb_resource_consumption_ms_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_consumption_ms
(
     dw_account_shk                 binary( 20 )
    ,dw_resource_shk                binary( 20 )
    ,dw_service_type_shk            binary( 20 )
    ,dw_event_date_sid              number
    --
    ,event_month_dt                 date
    ,compute_credit_cnt             float
    ,compute_cost_amt               float
    ,storage_byte_cnt               number
    ,storage_tb_cnt                 float
    ,storage_cost_amt               float
    ,data_xfer_byte_cnt             number
    ,data_xfer_tb_cnt               float
    ,data_xfer_cost_amt             float
    ,total_cost_amt                 float
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+--------------------------------------------------------+
| status                                                 |
|--------------------------------------------------------|
| Table CB_RESOURCE_CONSUMPTION_MS successfully created. |
+--------------------------------------------------------+
!source 310_derivation/cb_job_credits_s_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_job_credits_s
(
     dw_query_history_shk           binary( 20 )        not null
    ,start_time                     timestamp_ltz       not null
    ,hour_seq_no                    number              not null
    --
    ,organization_name              varchar( 250 )      not null
    ,account_name                   varchar( 250 )      not NULL
    ,reader_account_name              varchar( 250 )      NOT null
    ,region_name                    varchar( 250 )      not null
    ,warehouse_name                 text
    ,job_credits_used_compute       float
    --
    ,job_hour_cnt                   number
    ,credits_used_compute           float
    ,period_duration_pct            float
    ,period_duration                float
    ,adj_period_duration            float
    ,credits_consumed_bt            number
    ,job_period_start_ts            timestamp_ltz
    ,period_start_ts                timestamp_ltz
    ,period_end_ts                  timestamp_ltz
    ,adj_job_start_ts               timestamp_ltz
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+----------------------------------------------+
| status                                       |
|----------------------------------------------|
| Table CB_JOB_CREDITS_S successfully created. |
+----------------------------------------------+
!source 310_derivation/sf_compute_cost_s_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.sf_compute_cost_s
(
     dw_account_shk                 binary( 20 )        not null
    ,active_dt                      date                not null
    --
    ,cost_amt                       float               not null
    ,inactive_dt                    date                not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-----------------------------------------------+
| status                                        |
|-----------------------------------------------|
| Table SF_COMPUTE_COST_S successfully created. |
+-----------------------------------------------+
!source 310_derivation/be_budget_cost_s_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.be_budget_cost_s
(
     dw_be_shk                      binary( 20 )        not null
    ,be_name                        varchar( 250 )      not NULL
    ,dw_event_date_sid              number   
    --
    ,month_begin_dt                 date                NOT null
    ,compute_credit_cnt             number
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+----------------------------------------------+
| status                                       |
|----------------------------------------------|
| Table BE_BUDGET_COST_S successfully created. |
+----------------------------------------------+
!source 310_derivation/sf_data_xfer_cost_s_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.sf_data_xfer_cost_s
(
     dw_account_shk                 binary( 20 )        not null
    ,active_dt                      date                not null
    --
    ,cost_amt                       float               not null
    ,inactive_dt                    date                not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------------+
| status                                          |
|-------------------------------------------------|
| Table SF_DATA_XFER_COST_S successfully created. |
+-------------------------------------------------+
!source 310_derivation/sf_storage_cost_s_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_IL_DB.USAGE_METRIC.sf_storage_cost_s
(
     dw_account_shk                 binary( 20 )        not null
    ,active_dt                      date                not null
    --
    ,cost_amt                       float               not null
    ,inactive_dt                    date                not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-----------------------------------------------+
| status                                        |
|-----------------------------------------------|
| Table SF_STORAGE_COST_S successfully created. |
+-----------------------------------------------+
------------------------------------------------------------------------------
-- 320_mdm
--
!print 320_mdm
320_mdm
------------------------------------------------------------------------------
-- 400_dimension
--
!print 400_dimension
400_dimension

!source 400_dimension/cb_account_dm_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_PL_DB.REPORTING.cb_account_dm
(
     dw_account_shk                 binary( 20 )
    --
    ,organization_name              varchar( 250 )
    ,account_name                   varchar( 250 )
    ,reader_account_name            varchar( 250 )
    ,region_name                    varchar( 250 )
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------+
| status                                    |
|-------------------------------------------|
| Table CB_ACCOUNT_DM successfully created. |
+-------------------------------------------+

!source 400_dimension/cb_resource_dm_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_PL_DB.REPORTING.cb_resource_dm
(
     dw_resource_shk                binary( 20 )
    --
    ,be_name                        varchar( 250 )
    ,organization_name              varchar( 250 )
    ,account_name                   varchar( 250 )
    ,reader_account_name            varchar( 250 )
    ,region_name                    varchar( 250 )
    ,resource_name                  varchar( 250 )
    ,resource_type_cd               varchar( 250 )
    ,business_entity                varchar( 250 )
    ,team                           varchar( 250 )
    ,product_group                  varchar( 250 )
    ,environment_type               varchar( 250 )
    ,cost_center_id                 varchar( 250 )
    ,customer                       varchar( 250 )
    
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+--------------------------------------------+
| status                                     |
|--------------------------------------------|
| Table CB_RESOURCE_DM successfully created. |
+--------------------------------------------+
!source 400_dimension/cb_be_dm_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_PL_DB.REPORTING.cb_be_dm
(
     dw_be_shk                 binary( 20 )
    --
    ,be_name              varchar( 250 )
       --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+--------------------------------------+
| status                               |
|--------------------------------------|
| Table CB_BE_DM successfully created. |
+--------------------------------------+
!source 400_dimension/cb_service_type_dm_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_PL_DB.REPORTING.cb_service_type_dm
(
     dw_service_type_shk            binary( 20 )        not null
    ,dw_hash_diff                   binary( 20 )        not null
    ,service_type_cd                varchar( 50 )       not null
    ,service_type_name              varchar( 250 )      not null
    ,service_type_group_name        varchar( 250 )      not null
    ,active_dt                      date                not null
    ,inactive_dt                    date                not null
    --
    ,dw_load_ts                     timestamp_ltz       not null
    ,dw_update_ts                   timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+------------------------------------------------+
| status                                         |
|------------------------------------------------|
| Table CB_SERVICE_TYPE_DM successfully created. |
+------------------------------------------------+
!source 400_dimension/date_dm_tbl.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

create table if not exists DEV_PLAT_GOV_PL_DB.REPORTING.date_dm
(
     dw_date_sid             number               not null  primary key
    ,dw_cal_ly_date_sid      number               not null
    --
    -- day
    --
    ,cal_dt                  date                 not null
    ,cal_date_label          varchar( 250 )       not null
    ,cal_weekend_fl          varchar( 250 )       not null
    ,cal_weekday_fl          varchar( 250 )       not null
    --
    -- year
    --
    ,iso_year_no             number               not null
    ,iso_year_dt             date                 not null
    ,iso_year_quarter_no     number               not null
    ,iso_year_quarter_dt     date                 not null     -- current year's quarter date
    ,iso_year_month_no       number               not null
    ,iso_year_month_dt       date                 not null     -- current year's month date
    ,iso_year_week_no        number               not null
    ,iso_year_week_dt        date                null     -- current year's week date
    ,iso_year_day_no         number               not null
    --
    ,cal_year_no             number               not null
    ,cal_year_dt             date                 not null
    ,cal_year_quarter_no     number               not null
    ,cal_year_quarter_dt     date                 not null     -- current year's quarter date
    ,cal_year_month_no       number               not null
    ,cal_year_month_dt       date                 not null     -- current year's month date
    ,cal_year_day_no         number               not null
    --
    -- quarter
    --
    ,iso_quarter_dt          date                 not null
    ,iso_quarter_label       varchar( 250 )       not null
    ,iso_quarter_month_no    number               not null
    ,iso_quarter_week_no     number               not null
    ,iso_quarter_day_no      number               not null
    --
    ,cal_quarter_dt          date                 not null
    ,cal_quarter_label       varchar( 250 )       not null
    ,cal_quarter_month_no    number               not null
    ,cal_quarter_week_no     number               not null
    ,cal_quarter_day_no      number               not null
    --
    -- month
    --
    ,iso_month_dt            date                 not null       -- date to represent actual fiscal month (dd/01/yy) since it can cross calendar months.
    ,iso_month_label         varchar( 250 )       not null
    ,iso_month_week_no       number               not null
    ,iso_month_day_no        number               not null
    --
    ,cal_month_dt            date                 not null
    ,cal_month_label         varchar( 250 )       not null
    ,cal_month_week_no       number               not null
    ,cal_month_day_no        number               not null
    --
    -- week
    --
    ,iso_week_dt             date                 not null
    ,iso_week_label          varchar( 250 )       not null
    ,iso_week_day_no         number               not null
    --
    ,cal_week_day_no         number               not null
    --
    -- itd
    --
    ,iso_itd_quarter_no      number               not null
    ,iso_itd_month_no        number               not null
    ,iso_itd_week_no         number               not null
    ,iso_itd_day_no          number               not null
    --
    ,cal_itd_quarter_no      number               not null
    ,cal_itd_month_no        number               not null
    ,cal_itd_day_no          number               not null
    --
    -- ptd
    --
    ,iso_ptd_bt              number               not null
    ,iso_ptd_label           varchar( 250 )       not null
    ,cal_ptd_bt              number               not null
    ,cal_ptd_label           varchar( 250 )       not null
    --
    -- Future
    --
    ,cal_future_date_bt      number               not null
    --
    -- season
    --
    ,holiday_name            varchar( 250 )       not null     -- based on specific date on calendar labor day, halloween, thanksgiving, christmas, etc.
    ,dw_load_ts              timestamp_ltz        not null
    ,dw_update_ts            timestamp_ltz        not null
)
data_retention_time_in_days = 1
;
+-------------------------------------+
| status                              |
|-------------------------------------|
| Table DATE_DM successfully created. |
+-------------------------------------+
------------------------------------------------------------------------------
-- 410_fact_atomic
--
!print 410_fact_atomic
410_fact_atomic
------------------------------------------------------------------------------
-- 420_fact_aggregate
--
!print 420_fact_aggregate
420_fact_aggregate

!source 420_fact_aggregate/cb_account_df_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_PL_DB.REPORTING.cb_account_df
(
     dw_account_shk                 binary( 20 )
    ,dw_event_date_sid              number
    --
    ,event_dt                       date
    ,compute_credit_cnt             float
    ,compute_cost_amt               float
    ,storage_byte_cnt               number
    ,storage_cost_amt               float
    ,data_xfer_byte_cnt             number
    ,data_xfer_cost_amt             float
    ,total_cost_amt                 float
    --
    ,dw_load_ts                     timestamp_ltz       not null
    ,dw_update_ts                   timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------+
| status                                    |
|-------------------------------------------|
| Table CB_ACCOUNT_DF successfully created. |
+-------------------------------------------+
!source 420_fact_aggregate/cb_resource_df_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
--use role     sysadmin;

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_PL_DB.REPORTING.cb_resource_df
(
     dw_resource_shk                binary( 20 )
    ,dw_service_type_shk            binary( 20 )
    ,dw_event_date_sid              number
    --
    ,event_dt                       date
    ,compute_credit_cnt             float
    ,compute_cost_amt               float
    ,storage_byte_cnt               number
    ,storage_cost_amt               float
    ,data_xfer_byte_cnt             number
    ,data_xfer_cost_amt             float
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+--------------------------------------------+
| status                                     |
|--------------------------------------------|
| Table CB_RESOURCE_DF successfully created. |
+--------------------------------------------+
!source 420_fact_aggregate/cb_account_mf_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_PL_DB.REPORTING.cb_account_mf
(
     dw_account_shk                 binary( 20 )
    ,dw_event_date_sid              number
    --
    ,event_month_dt                 date
    ,compute_credit_cnt             float
    ,compute_cost_amt               float
    ,storage_byte_cnt               number
    ,storage_cost_amt               float
    ,data_xfer_byte_cnt             number
    ,data_xfer_cost_amt             float
    ,total_cost_amt                 float
    ,fcst_total_cost_amt            float
    --
    ,dw_load_ts                     timestamp_ltz       not null
    ,dw_update_ts                   timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+-------------------------------------------+
| status                                    |
|-------------------------------------------|
| Table CB_ACCOUNT_MF successfully created. |
+-------------------------------------------+
!source 420_fact_aggregate/cb_be_budget_mf_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_PL_DB.REPORTING.cb_be_budget_mf
(
     dw_be_shk                      binary( 20 )
    ,dw_event_date_sid              number
    --
    ,event_month_dt                 date
    ,bgt_compute_credit_cnt         float
    --
    ,dw_load_ts                     timestamp_ltz       not null
    ,dw_update_ts                   timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+---------------------------------------------+
| status                                      |
|---------------------------------------------|
| Table CB_BE_BUDGET_MF successfully created. |
+---------------------------------------------+
!source 420_fact_aggregate/cb_resource_mf_tbl.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
--use role     sysadmin;

--
-- permanent table with retention days
--
create table if not exists DEV_PLAT_GOV_PL_DB.REPORTING.cb_resource_mf
(
     dw_resource_shk                binary( 20 )
    ,dw_service_type_shk            binary( 20 )
    ,dw_event_date_sid              number
    --
    ,event_month_dt                 date
    ,compute_credit_cnt             float
    ,compute_cost_amt               float
    ,storage_byte_cnt               number
    ,storage_cost_amt               float
    ,data_xfer_byte_cnt             number
    ,data_xfer_cost_amt             float
    --
    ,dw_load_ts                     timestamp_ltz       not null
)
data_retention_time_in_days = 1
;
+--------------------------------------------+
| status                                     |
|--------------------------------------------|
| Table CB_RESOURCE_MF successfully created. |
+--------------------------------------------+
------------------------------------------------------------------------------
-- 500_outbound
--
!print 500_outbound
500_outbound
------------------------------------------------------------------------------
-- 900_common
--
!print 900_common
900_common

!source 900_common/sf_compute_cost_f.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
create or replace function DEV_PLAT_GOV_COMMON_DB.UTIL.sf_compute_cost_f
(
     p_dw_account_shk   binary
    ,p_date             date
)
returns float
as
$$
    select
        max( cost_amt )
    from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.sf_compute_cost_s
    where
            dw_account_shk    = p_dw_account_shk
        and p_date           >= active_dt
        and p_date            < inactive_dt
$$
;
+--------------------------------------------------+
| status                                           |
|--------------------------------------------------|
| Function SF_COMPUTE_COST_F successfully created. |
+--------------------------------------------------+
!source 900_common/sf_data_xfer_cost_f.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
create or replace function DEV_PLAT_GOV_COMMON_DB.UTIL.sf_data_xfer_cost_f
(
     p_dw_account_shk   binary
    ,p_date             date
)
returns float
as
$$
    select
        max( cost_amt )
    from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.sf_data_xfer_cost_s
    where
            dw_account_shk    = p_dw_account_shk
        and p_date           >= active_dt
        and p_date            < inactive_dt
$$
;
+----------------------------------------------------+
| status                                             |
|----------------------------------------------------|
| Function SF_DATA_XFER_COST_F successfully created. |
+----------------------------------------------------+
!source 900_common/sf_storage_cost_f.sql
--------------------------------------------------------------------
--  Purpose: create psa tables
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
create or replace function DEV_PLAT_GOV_COMMON_DB.UTIL.sf_storage_cost_f
(
     p_dw_account_shk   binary
    ,p_date             date
)
returns float
as
$$
    select
        max( cost_amt )
    from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.sf_storage_cost_s
    where
            dw_account_shk    = p_dw_account_shk
        and p_date           >= active_dt
        and p_date            < inactive_dt
$$
;
+--------------------------------------------------+
| status                                           |
|--------------------------------------------------|
| Function SF_STORAGE_COST_F successfully created. |
+--------------------------------------------------+

!print SUCCESS!
SUCCESS!

!print SUCCESS!
SUCCESS!
!quit
