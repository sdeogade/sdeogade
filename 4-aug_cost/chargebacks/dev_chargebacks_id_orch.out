[Errno 2] No such file or directory: 'dev_chargebacks_id_orch.sql'
If the error message is unclear, enable logging using -o log_level=DEBUG and see the log to find out the cause. Contact support for further help.
/*

cd "/Volumes/GoogleDrive/Shared drives/Professional Services/Service Delivery/Individual Folders/Greg Sitzman/3) In-Use/Data Cloud Deployment Framework/Scripts/Chargebacks/Account"

--C:\Users\<username>\.snowsql\cmd

--1--  snowsql  -c by_org -r SYSADMIN -D l_env=dev -f chargebacks_ddl_orch.sql -o output_file=chargebacks_ddl_orch.out



--2--  snowsql -c by_org -r SYSADMIN -D l_env=dev -f chargebacks_ld_orch.sql -o output_file=chargebacks_ld_orch.out

*/


------------------------------------------------------------------------------
-- snowsql session
--
------------------------------------------------------------------------------
-- 000_admin
--
!print 000_admin
000_admin

!print set context
set context

!source 000_admin/dev_context_dml.sql
------------------------------------------------------------------------------
-- context
--
!print set environment context
set environment context

!define l_common_db=DEV_PLAT_GOV_COMMON_DB
!define l_common_schema=UTIL

!define l_raw_db=DEV_PLAT_GOV_RL_DB
!define l_raw_schema=account_usage

!define l_il_db=DEV_PLAT_GOV_IL_DB
!define l_il_schema=USAGE_METRIC

!define l_pl_db=DEV_PLAT_GOV_PL_DB
!define l_pl_schema=REPORTING
use warehouse DEV_PLAT_GOV_WH;
002043 (02000): SQL compilation error:
Object does not exist, or operation cannot be performed.
If the error message is unclear, enable logging using -o log_level=DEBUG and see the log to find out the cause. Contact support for further help.
/*

cd "/Volumes/GoogleDrive/Shared drives/Professional Services/Service Delivery/Individual Folders/Greg Sitzman/3) In-Use/Data Cloud Deployment Framework/Scripts/Chargebacks/Account"

--C:\Users\<username>\.snowsql\cmd

--1--  snowsql  -c by_org -r SYSADMIN -D l_env=dev -f chargebacks_ddl_orch.sql -o output_file=chargebacks_ddl_orch.out



--2--  snowsql -c by_org -r SYSADMIN -D l_env=dev -f chargebacks_ld_orch.sql -o output_file=chargebacks_ld_orch.out

*/


------------------------------------------------------------------------------
-- snowsql session
--
------------------------------------------------------------------------------
-- 000_admin
--
!print 000_admin
000_admin

!print set context
set context

!source 000_admin/dev_context_dml.sql
------------------------------------------------------------------------------
-- context
--
!print set environment context
set environment context

!define l_common_db=DEV_PLAT_GOV_COMMON_DB
!define l_common_schema=UTIL

!define l_raw_db=DEV_PLAT_GOV_RL_DB
!define l_raw_schema=account_usage

!define l_il_db=DEV_PLAT_GOV_IL_DB
!define l_il_schema=USAGE_METRIC

!define l_pl_db=DEV_PLAT_GOV_PL_DB
!define l_pl_schema=REPORTING
use warehouse COMPUTE_WH;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
alter warehouse COMPUTE_WH set warehouse_size=small;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+

!print SUCCESS!
SUCCESS!
------------------------------------------------------------------------------
-- 000_admin acquisition
--
-- Add each source account to this section.  Make sure there is a connection
-- defined for each account within the snowsql config file.
--
!print 00_admin acquisition
00_admin acquisition
-- set delta hours for fixed delta window scenario
-- 366 days = 8784 hours
!define l_delta_hours=8784
--------
--account_acq_100_set_last_control_date_from_org_account
!print 000_admin acquisition account 1 ---------------------------------------
000_admin acquisition account 1 ---------------------------------------

!define l_account_name="apisero_dev"
!connect apisero_dev
-- org the snowflake account resides in
!define l_org_name='APISERO'
!source 000_admin/account_acq_100_acquisition_orch.sql
------------------------------------------------------------------------------
-- 100_acquisition
--
!print 100_acquisition
100_acquisition
-- acquisition scripts that need to run against each source account.
!print 100_acquisition Step 1
100_acquisition Step 1

!source 100_acquisition/automatic_clustering_history_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--

/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( start_time ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/

--Suraj : removed comment
--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.

set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/automatic_clustering_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,s.start_time
        ,s.end_time
        ,s.credits_used
        ,s.num_bytes_reclustered
        ,s.num_rows_reclustered
        ,s.table_id
        ,s.table_name
        ,s.schema_id
        ,s.schema_name
        ,s.database_id
        ,s.database_name
    from
        snowflake.account_usage.automatic_clustering_history s
    where
        s.start_time >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|             0 |           0 |            0 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------+------+-----+---------------+
| name | size | md5 | last_modified |
|------+------+-----+---------------|
+------+------+-----+---------------+
!source 100_acquisition/data_transfer_history_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--
/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( start_time ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/

--Suraj : removed comment

--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.

set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/data_transfer_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,s.start_time
        ,s.end_time
        ,s.source_cloud
        ,s.source_region
        ,s.target_cloud
        ,s.target_region
        ,s.bytes_transferred
        ,s.transfer_type
    from
        snowflake.account_usage.data_transfer_history s
    where
        s.start_time >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|            13 |        1959 |          969 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------+
| name                                                                                                       | size | md5                              | last_modified                 |
|------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz |  144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz |  144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz |  160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz |  128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz |  160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz |  128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz |  160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
+------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------+
!source 100_acquisition/database_storage_usage_history_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--
/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( usage_date ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/
--Suraj : removed comment

--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.

set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/database_storage_usage_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,s.usage_date
        ,s.database_id
        ,s.database_name
        ,s.deleted
        ,s.average_database_bytes
        ,s.average_failsafe_bytes
    from
        snowflake.account_usage.database_storage_usage_history s
    where
        s.usage_date >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|          1336 |      111807 |        13031 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+---------------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------+
| name                                                                                                                | size | md5                              | last_modified                 |
|---------------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz          |  144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz          |  144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz          |  160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz          |  128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz          |  160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz          |  128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz          |  160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz |  768 | 719b352649fb44b17236833cf2e7faf3 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz |  832 | baae15f11e36d4d7609e7860c756aecd | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz |  912 | 5a10fcf3c2fea0d49d761360d7e65b02 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz |  816 | e5a9d90192e239d147acd656ff64b1d0 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz |  720 | ddf6b9823dbbb97fdaac11ac8dd9335b | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz |  848 | 77cff417b66e9a73ca1467ebe59515d9 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz |  736 | 729aab4d82ddac0d492ce7e7cc8302cc | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz |  896 | 7a423e8132936e0709f5eded7f89ff50 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz |  752 | fe3a7639e8a4ea2ea8a0b8a7b465accb | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz |  992 | 4647f26041eb765e736d9fe065e2c984 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz |  816 | 68aec6faa928eb4c5cbccb134ea95c4c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz |  848 | f9e67356d0088ae8c65217ebc246278c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz |  928 | 585cbdd0cdc969afc0ea5679924b3f39 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz |  704 | fc885cb0c276f0a469fe1905d40b0149 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz |  880 | 5abbf523d2795f46cf8c49e5a7508f1e | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz |  736 | ac99fb43fa4f9d0b3b266bd64a998d72 | Mon, 20 Sep 2021 06:10:33 GMT |
+---------------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------+
!source 100_acquisition/materialized_view_refresh_history_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--
/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( start_time ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/

--Suraj : removed comment

--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.


set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/materialized_view_refresh_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,s.start_time
        ,s.end_time
        ,s.credits_used
        ,s.table_id
        ,s.table_name
        ,s.schema_id
        ,s.schema_name
        ,s.database_id
        ,s.database_name
    from
        snowflake.account_usage.materialized_view_refresh_history s
    where
        s.start_time >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|             5 |         790 |          333 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------------------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------+
| name                                                                                                                   | size | md5                              | last_modified                 |
|------------------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz             |  144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz             |  144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz             |  160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz             |  128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz             |  160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz             |  128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz             |  160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz    |  768 | 719b352649fb44b17236833cf2e7faf3 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz    |  832 | baae15f11e36d4d7609e7860c756aecd | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz    |  912 | 5a10fcf3c2fea0d49d761360d7e65b02 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz    |  816 | e5a9d90192e239d147acd656ff64b1d0 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz    |  720 | ddf6b9823dbbb97fdaac11ac8dd9335b | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz    |  848 | 77cff417b66e9a73ca1467ebe59515d9 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz    |  736 | 729aab4d82ddac0d492ce7e7cc8302cc | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz    |  896 | 7a423e8132936e0709f5eded7f89ff50 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz    |  752 | fe3a7639e8a4ea2ea8a0b8a7b465accb | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz    |  992 | 4647f26041eb765e736d9fe065e2c984 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz    |  816 | 68aec6faa928eb4c5cbccb134ea95c4c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz    |  848 | f9e67356d0088ae8c65217ebc246278c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz    |  928 | 585cbdd0cdc969afc0ea5679924b3f39 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz    |  704 | fc885cb0c276f0a469fe1905d40b0149 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz    |  880 | 5abbf523d2795f46cf8c49e5a7508f1e | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz    |  736 | ac99fb43fa4f9d0b3b266bd64a998d72 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_2_0.csv.gz |  160 | d639a69890ce3dd7f81227ee051368dc | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_4_0.csv.gz |  192 | b17e95a93177409d4d7708282d00f6eb | Mon, 20 Sep 2021 06:10:34 GMT |
+------------------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------+
!source 100_acquisition/metering_daily_history_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--
/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( usage_date ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.metering_daily_history
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/
--Suraj : removed comment

--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.

set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/metering_daily_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,s.service_type
        ,s.usage_date
        ,s.credits_used_compute
        ,s.credits_used_cloud_services
        ,s.credits_used
        ,s.credits_adjustment_cloud_services
        ,s.credits_billed
    from
        snowflake.account_usage.metering_daily_history s
    where
        s.usage_date >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|           141 |       18801 |         4980 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------------------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------+
| name                                                                                                                   | size | md5                              | last_modified                 |
|------------------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz             |  144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz             |  144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz             |  160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz             |  128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz             |  160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz             |  128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz             |  160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz    |  768 | 719b352649fb44b17236833cf2e7faf3 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz    |  832 | baae15f11e36d4d7609e7860c756aecd | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz    |  912 | 5a10fcf3c2fea0d49d761360d7e65b02 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz    |  816 | e5a9d90192e239d147acd656ff64b1d0 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz    |  720 | ddf6b9823dbbb97fdaac11ac8dd9335b | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz    |  848 | 77cff417b66e9a73ca1467ebe59515d9 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz    |  736 | 729aab4d82ddac0d492ce7e7cc8302cc | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz    |  896 | 7a423e8132936e0709f5eded7f89ff50 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz    |  752 | fe3a7639e8a4ea2ea8a0b8a7b465accb | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz    |  992 | 4647f26041eb765e736d9fe065e2c984 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz    |  816 | 68aec6faa928eb4c5cbccb134ea95c4c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz    |  848 | f9e67356d0088ae8c65217ebc246278c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz    |  928 | 585cbdd0cdc969afc0ea5679924b3f39 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz    |  704 | fc885cb0c276f0a469fe1905d40b0149 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz    |  880 | 5abbf523d2795f46cf8c49e5a7508f1e | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz    |  736 | ac99fb43fa4f9d0b3b266bd64a998d72 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_2_0.csv.gz |  160 | d639a69890ce3dd7f81227ee051368dc | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_4_0.csv.gz |  192 | b17e95a93177409d4d7708282d00f6eb | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_0_0.csv.gz            |  272 | 5903e276c551c3b597c02a88ea61b527 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_1_0.csv.gz            |  480 | 79aac75907c1376f815f5c208d587acd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_2_0.csv.gz            |  288 | 78d9ffed38fb2e3b74b412f2eb27e208 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_3_0.csv.gz            |  352 | 9fe9e42cfc5d084634569195fc11f6e2 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_4_0.csv.gz            |  288 | 3a3f209a4997c24a7c7e86d08d1e65cd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_5_0.csv.gz            |  256 | df653fad3016c308a56a91bf0a7d7373 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_6_0.csv.gz            |  352 | 1c26a2b3d19dd807c4878b347742a920 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_7_0.csv.gz            |  240 | 984aa5add77c20c2ef7dd01f9c583925 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_0_0.csv.gz            |  288 | 1abd052996cd723d9f5188ae7082a606 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_1_0.csv.gz            |  304 | 87c5f544069ec6da96160ad2421e82cb | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_2_0.csv.gz            |  272 | e744c76a7f77462d666130758ca32b30 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_3_0.csv.gz            |  320 | 06fe54498b886a5b064443eaa1405177 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_4_0.csv.gz            |  320 | 4fe977065b001f302a49101ebe4bd5ba | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_5_0.csv.gz            |  416 | aa9cf25e4521fbee1f24735cd8e3493c | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_6_0.csv.gz            |  368 | 4758d7d7e6bb7563ace77bd3a918213b | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_7_0.csv.gz            |  288 | 6105f98e1c25b5fa1a4120ec30c9a55f | Mon, 20 Sep 2021 06:10:39 GMT |
+------------------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------+
!source 100_acquisition/pipe_usage_history_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--
/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( start_time ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/


--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.

set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/pipe_usage_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,s.start_time
        ,s.end_time
        ,s.credits_used
        ,s.bytes_inserted
        ,s.files_inserted
        ,s.pipe_id
        ,s.pipe_name
        --
        ,p.pipe_schema             as schema_name
        ,p.pipe_catalog            as database_name
        --
    from
        snowflake.account_usage.pipe_usage_history s
        left join snowflake.account_usage.pipes p on
            p.pipe_id = s.pipe_id
    where
        s.start_time >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|            21 |        3507 |          707 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------------------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------+
| name                                                                                                                   | size | md5                              | last_modified                 |
|------------------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz             |  144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz             |  144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz             |  160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz             |  128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz             |  160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz             |  128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz             |  160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz    |  768 | 719b352649fb44b17236833cf2e7faf3 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz    |  832 | baae15f11e36d4d7609e7860c756aecd | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz    |  912 | 5a10fcf3c2fea0d49d761360d7e65b02 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz    |  816 | e5a9d90192e239d147acd656ff64b1d0 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz    |  720 | ddf6b9823dbbb97fdaac11ac8dd9335b | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz    |  848 | 77cff417b66e9a73ca1467ebe59515d9 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz    |  736 | 729aab4d82ddac0d492ce7e7cc8302cc | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz    |  896 | 7a423e8132936e0709f5eded7f89ff50 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz    |  752 | fe3a7639e8a4ea2ea8a0b8a7b465accb | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz    |  992 | 4647f26041eb765e736d9fe065e2c984 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz    |  816 | 68aec6faa928eb4c5cbccb134ea95c4c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz    |  848 | f9e67356d0088ae8c65217ebc246278c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz    |  928 | 585cbdd0cdc969afc0ea5679924b3f39 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz    |  704 | fc885cb0c276f0a469fe1905d40b0149 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz    |  880 | 5abbf523d2795f46cf8c49e5a7508f1e | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz    |  736 | ac99fb43fa4f9d0b3b266bd64a998d72 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_2_0.csv.gz |  160 | d639a69890ce3dd7f81227ee051368dc | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_4_0.csv.gz |  192 | b17e95a93177409d4d7708282d00f6eb | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_0_0.csv.gz            |  272 | 5903e276c551c3b597c02a88ea61b527 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_1_0.csv.gz            |  480 | 79aac75907c1376f815f5c208d587acd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_2_0.csv.gz            |  288 | 78d9ffed38fb2e3b74b412f2eb27e208 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_3_0.csv.gz            |  352 | 9fe9e42cfc5d084634569195fc11f6e2 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_4_0.csv.gz            |  288 | 3a3f209a4997c24a7c7e86d08d1e65cd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_5_0.csv.gz            |  256 | df653fad3016c308a56a91bf0a7d7373 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_6_0.csv.gz            |  352 | 1c26a2b3d19dd807c4878b347742a920 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_7_0.csv.gz            |  240 | 984aa5add77c20c2ef7dd01f9c583925 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_0_0.csv.gz            |  288 | 1abd052996cd723d9f5188ae7082a606 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_1_0.csv.gz            |  304 | 87c5f544069ec6da96160ad2421e82cb | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_2_0.csv.gz            |  272 | e744c76a7f77462d666130758ca32b30 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_3_0.csv.gz            |  320 | 06fe54498b886a5b064443eaa1405177 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_4_0.csv.gz            |  320 | 4fe977065b001f302a49101ebe4bd5ba | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_5_0.csv.gz            |  416 | aa9cf25e4521fbee1f24735cd8e3493c | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_6_0.csv.gz            |  368 | 4758d7d7e6bb7563ace77bd3a918213b | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_7_0.csv.gz            |  288 | 6105f98e1c25b5fa1a4120ec30c9a55f | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_4_0.csv.gz                |  176 | 60fec2e5a77b3bbceef76500e9418aed | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_6_0.csv.gz                |  560 | 230fc3769a2c292b4749d442064e5f4d | Mon, 20 Sep 2021 06:10:42 GMT |
+------------------------------------------------------------------------------------------------------------------------+------+----------------------------------+-------------------------------+
!source 100_acquisition/query_history_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--
/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( start_time ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.query_history
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/
--Suraj : removed comment

--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.


set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/query_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,s.query_id
        ,s.query_text
        ,s.database_id
        ,s.database_name
        ,s.schema_id
        ,s.schema_name
        ,s.query_type
        ,s.session_id
        ,s.user_name
        ,s.role_name
        ,s.warehouse_id
        ,s.warehouse_name
        ,s.warehouse_size
        ,s.warehouse_type
        ,s.cluster_number
        ,s.query_tag
        ,s.execution_status
        ,s.error_code
        ,s.error_message
        ,s.start_time
        ,s.end_time
        ,s.total_elapsed_time
        ,s.bytes_scanned
        ,s.percentage_scanned_from_cache
        ,s.bytes_written
        ,s.bytes_written_to_result
        ,s.bytes_read_from_result
        ,s.rows_produced
        ,s.rows_inserted
        ,s.rows_updated
        ,s.rows_deleted
        ,s.rows_unloaded
        ,s.bytes_deleted
        ,s.partitions_scanned
        ,s.partitions_total
        ,s.bytes_spilled_to_local_storage
        ,s.bytes_spilled_to_remote_storage
        ,s.bytes_sent_over_the_network
        ,s.compilation_time
        ,s.execution_time
        ,s.queued_provisioning_time
        ,s.queued_repair_time
        ,s.queued_overload_time
        ,s.transaction_blocked_time
        ,s.outbound_data_transfer_cloud
        ,s.outbound_data_transfer_region
        ,s.outbound_data_transfer_bytes
        ,s.inbound_data_transfer_cloud
        ,s.inbound_data_transfer_region
        ,s.inbound_data_transfer_bytes
        ,s.list_external_files_time
        ,s.credits_used_cloud_services
        ,s.release_version
        ,s.external_function_total_invocations
        ,s.external_function_total_sent_rows
        ,s.external_function_total_received_rows
        ,s.external_function_total_sent_bytes
        ,s.external_function_total_received_bytes
        ,s.query_load_percent
        ,s.is_client_generated_statement
    from
        snowflake.account_usage.query_history s
    where
        s.start_time >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|        113684 |    56547353 |      5630321 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
| name                                                                                                                   |    size | md5                              | last_modified                 |
|------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz             |     144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz             |     144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz             |     160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz             |     128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz             |     160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz             |     128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz             |     160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz    |     768 | 719b352649fb44b17236833cf2e7faf3 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz    |     832 | baae15f11e36d4d7609e7860c756aecd | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz    |     912 | 5a10fcf3c2fea0d49d761360d7e65b02 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz    |     816 | e5a9d90192e239d147acd656ff64b1d0 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz    |     720 | ddf6b9823dbbb97fdaac11ac8dd9335b | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz    |     848 | 77cff417b66e9a73ca1467ebe59515d9 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz    |     736 | 729aab4d82ddac0d492ce7e7cc8302cc | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz    |     896 | 7a423e8132936e0709f5eded7f89ff50 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz    |     752 | fe3a7639e8a4ea2ea8a0b8a7b465accb | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz    |     992 | 4647f26041eb765e736d9fe065e2c984 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz    |     816 | 68aec6faa928eb4c5cbccb134ea95c4c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz    |     848 | f9e67356d0088ae8c65217ebc246278c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz    |     928 | 585cbdd0cdc969afc0ea5679924b3f39 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz    |     704 | fc885cb0c276f0a469fe1905d40b0149 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz    |     880 | 5abbf523d2795f46cf8c49e5a7508f1e | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz    |     736 | ac99fb43fa4f9d0b3b266bd64a998d72 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_2_0.csv.gz |     160 | d639a69890ce3dd7f81227ee051368dc | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_4_0.csv.gz |     192 | b17e95a93177409d4d7708282d00f6eb | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_0_0.csv.gz            |     272 | 5903e276c551c3b597c02a88ea61b527 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_1_0.csv.gz            |     480 | 79aac75907c1376f815f5c208d587acd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_2_0.csv.gz            |     288 | 78d9ffed38fb2e3b74b412f2eb27e208 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_3_0.csv.gz            |     352 | 9fe9e42cfc5d084634569195fc11f6e2 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_4_0.csv.gz            |     288 | 3a3f209a4997c24a7c7e86d08d1e65cd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_5_0.csv.gz            |     256 | df653fad3016c308a56a91bf0a7d7373 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_6_0.csv.gz            |     352 | 1c26a2b3d19dd807c4878b347742a920 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_7_0.csv.gz            |     240 | 984aa5add77c20c2ef7dd01f9c583925 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_0_0.csv.gz            |     288 | 1abd052996cd723d9f5188ae7082a606 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_1_0.csv.gz            |     304 | 87c5f544069ec6da96160ad2421e82cb | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_2_0.csv.gz            |     272 | e744c76a7f77462d666130758ca32b30 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_3_0.csv.gz            |     320 | 06fe54498b886a5b064443eaa1405177 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_4_0.csv.gz            |     320 | 4fe977065b001f302a49101ebe4bd5ba | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_5_0.csv.gz            |     416 | aa9cf25e4521fbee1f24735cd8e3493c | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_6_0.csv.gz            |     368 | 4758d7d7e6bb7563ace77bd3a918213b | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_7_0.csv.gz            |     288 | 6105f98e1c25b5fa1a4120ec30c9a55f | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_4_0.csv.gz                |     176 | 60fec2e5a77b3bbceef76500e9418aed | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_6_0.csv.gz                |     560 | 230fc3769a2c292b4749d442064e5f4d | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_0_0.csv.gz                     |     928 | 2d945dec3a618cb693e581b3db777fea | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_1_0.csv.gz                     |  176464 | c440d63a85bee290f58bf1b0ef943cf8 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_2_0.csv.gz                     |   36128 | 7e0d853850d5c927ce969c6476a11dbd | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_3_0.csv.gz                     |   70224 | 4f6c0c3d4cd51abc80b1519c6751da4a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_4_0.csv.gz                     | 1324896 | a404bf1e96bf44b3c77dc284a7874114 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_5_0.csv.gz                     |  108688 | 6d92199ace70e1e8e96ad20305a8634a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_6_0.csv.gz                     |  733296 | ce2e1e4e39d6b0b8c2c3052b1c044fef | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_7_0.csv.gz                     |  367824 | 968e81af330c0e6eb4f5c803c3feeff0 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_0_0.csv.gz                     | 1054864 | 60229688817a1fc11a37bfd4f5bfae3b | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_1_0.csv.gz                     |  313584 | 41a2972c6dd25a0459fcf591b67ac7d5 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_2_0.csv.gz                     |  188912 | 0e6ee515d1740f02e79d2347216a2b9f | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_3_0.csv.gz                     |  678832 | 913dac450861ae098dd91f106c373079 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_4_0.csv.gz                     |    8992 | bea6ddbfcea32bc3f50c11049a609840 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_5_0.csv.gz                     |  105392 | 536750d9e42c0b2f05f5571fb28cb3c1 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_6_0.csv.gz                     |   87232 | 5c977afb4ee7457ec8b3db815223262e | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_7_0.csv.gz                     |  374176 | 807bf305d08b8ed2701702f1c7cf25b3 | Mon, 20 Sep 2021 06:10:47 GMT |
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
!source 100_acquisition/replication_usage_history_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--
/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( start_time ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/
--Suraj : removed comment

--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.

set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/replication_usage_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,s.start_time
        ,s.end_time
        ,s.database_id
        ,s.database_name
        ,s.credits_used
        ,s.bytes_transferred
    from
        snowflake.account_usage.replication_usage_history s
    where
        s.start_time >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|             0 |           0 |            0 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
| name                                                                                                                   |    size | md5                              | last_modified                 |
|------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz             |     144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz             |     144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz             |     160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz             |     128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz             |     160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz             |     128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz             |     160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz    |     768 | 719b352649fb44b17236833cf2e7faf3 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz    |     832 | baae15f11e36d4d7609e7860c756aecd | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz    |     912 | 5a10fcf3c2fea0d49d761360d7e65b02 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz    |     816 | e5a9d90192e239d147acd656ff64b1d0 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz    |     720 | ddf6b9823dbbb97fdaac11ac8dd9335b | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz    |     848 | 77cff417b66e9a73ca1467ebe59515d9 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz    |     736 | 729aab4d82ddac0d492ce7e7cc8302cc | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz    |     896 | 7a423e8132936e0709f5eded7f89ff50 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz    |     752 | fe3a7639e8a4ea2ea8a0b8a7b465accb | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz    |     992 | 4647f26041eb765e736d9fe065e2c984 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz    |     816 | 68aec6faa928eb4c5cbccb134ea95c4c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz    |     848 | f9e67356d0088ae8c65217ebc246278c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz    |     928 | 585cbdd0cdc969afc0ea5679924b3f39 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz    |     704 | fc885cb0c276f0a469fe1905d40b0149 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz    |     880 | 5abbf523d2795f46cf8c49e5a7508f1e | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz    |     736 | ac99fb43fa4f9d0b3b266bd64a998d72 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_2_0.csv.gz |     160 | d639a69890ce3dd7f81227ee051368dc | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_4_0.csv.gz |     192 | b17e95a93177409d4d7708282d00f6eb | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_0_0.csv.gz            |     272 | 5903e276c551c3b597c02a88ea61b527 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_1_0.csv.gz            |     480 | 79aac75907c1376f815f5c208d587acd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_2_0.csv.gz            |     288 | 78d9ffed38fb2e3b74b412f2eb27e208 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_3_0.csv.gz            |     352 | 9fe9e42cfc5d084634569195fc11f6e2 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_4_0.csv.gz            |     288 | 3a3f209a4997c24a7c7e86d08d1e65cd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_5_0.csv.gz            |     256 | df653fad3016c308a56a91bf0a7d7373 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_6_0.csv.gz            |     352 | 1c26a2b3d19dd807c4878b347742a920 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_7_0.csv.gz            |     240 | 984aa5add77c20c2ef7dd01f9c583925 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_0_0.csv.gz            |     288 | 1abd052996cd723d9f5188ae7082a606 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_1_0.csv.gz            |     304 | 87c5f544069ec6da96160ad2421e82cb | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_2_0.csv.gz            |     272 | e744c76a7f77462d666130758ca32b30 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_3_0.csv.gz            |     320 | 06fe54498b886a5b064443eaa1405177 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_4_0.csv.gz            |     320 | 4fe977065b001f302a49101ebe4bd5ba | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_5_0.csv.gz            |     416 | aa9cf25e4521fbee1f24735cd8e3493c | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_6_0.csv.gz            |     368 | 4758d7d7e6bb7563ace77bd3a918213b | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_7_0.csv.gz            |     288 | 6105f98e1c25b5fa1a4120ec30c9a55f | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_4_0.csv.gz                |     176 | 60fec2e5a77b3bbceef76500e9418aed | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_6_0.csv.gz                |     560 | 230fc3769a2c292b4749d442064e5f4d | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_0_0.csv.gz                     |     928 | 2d945dec3a618cb693e581b3db777fea | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_1_0.csv.gz                     |  176464 | c440d63a85bee290f58bf1b0ef943cf8 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_2_0.csv.gz                     |   36128 | 7e0d853850d5c927ce969c6476a11dbd | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_3_0.csv.gz                     |   70224 | 4f6c0c3d4cd51abc80b1519c6751da4a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_4_0.csv.gz                     | 1324896 | a404bf1e96bf44b3c77dc284a7874114 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_5_0.csv.gz                     |  108688 | 6d92199ace70e1e8e96ad20305a8634a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_6_0.csv.gz                     |  733296 | ce2e1e4e39d6b0b8c2c3052b1c044fef | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_7_0.csv.gz                     |  367824 | 968e81af330c0e6eb4f5c803c3feeff0 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_0_0.csv.gz                     | 1054864 | 60229688817a1fc11a37bfd4f5bfae3b | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_1_0.csv.gz                     |  313584 | 41a2972c6dd25a0459fcf591b67ac7d5 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_2_0.csv.gz                     |  188912 | 0e6ee515d1740f02e79d2347216a2b9f | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_3_0.csv.gz                     |  678832 | 913dac450861ae098dd91f106c373079 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_4_0.csv.gz                     |    8992 | bea6ddbfcea32bc3f50c11049a609840 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_5_0.csv.gz                     |  105392 | 536750d9e42c0b2f05f5571fb28cb3c1 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_6_0.csv.gz                     |   87232 | 5c977afb4ee7457ec8b3db815223262e | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_7_0.csv.gz                     |  374176 | 807bf305d08b8ed2701702f1c7cf25b3 | Mon, 20 Sep 2021 06:10:47 GMT |
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
!source 100_acquisition/search_optimization_history_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--
/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( start_time ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/
--Suraj : removed comment
--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.

set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/search_optimization_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,s.start_time
        ,s.end_time
        ,s.credits_used
        ,s.table_id
        ,s.table_name
        ,s.schema_id
        ,s.schema_name
        ,s.database_id
        ,s.database_name
    from
        snowflake.account_usage.search_optimization_history s
    where
        s.start_time >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|             0 |           0 |            0 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
| name                                                                                                                   |    size | md5                              | last_modified                 |
|------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz             |     144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz             |     144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz             |     160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz             |     128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz             |     160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz             |     128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz             |     160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz    |     768 | 719b352649fb44b17236833cf2e7faf3 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz    |     832 | baae15f11e36d4d7609e7860c756aecd | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz    |     912 | 5a10fcf3c2fea0d49d761360d7e65b02 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz    |     816 | e5a9d90192e239d147acd656ff64b1d0 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz    |     720 | ddf6b9823dbbb97fdaac11ac8dd9335b | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz    |     848 | 77cff417b66e9a73ca1467ebe59515d9 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz    |     736 | 729aab4d82ddac0d492ce7e7cc8302cc | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz    |     896 | 7a423e8132936e0709f5eded7f89ff50 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz    |     752 | fe3a7639e8a4ea2ea8a0b8a7b465accb | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz    |     992 | 4647f26041eb765e736d9fe065e2c984 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz    |     816 | 68aec6faa928eb4c5cbccb134ea95c4c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz    |     848 | f9e67356d0088ae8c65217ebc246278c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz    |     928 | 585cbdd0cdc969afc0ea5679924b3f39 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz    |     704 | fc885cb0c276f0a469fe1905d40b0149 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz    |     880 | 5abbf523d2795f46cf8c49e5a7508f1e | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz    |     736 | ac99fb43fa4f9d0b3b266bd64a998d72 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_2_0.csv.gz |     160 | d639a69890ce3dd7f81227ee051368dc | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_4_0.csv.gz |     192 | b17e95a93177409d4d7708282d00f6eb | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_0_0.csv.gz            |     272 | 5903e276c551c3b597c02a88ea61b527 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_1_0.csv.gz            |     480 | 79aac75907c1376f815f5c208d587acd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_2_0.csv.gz            |     288 | 78d9ffed38fb2e3b74b412f2eb27e208 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_3_0.csv.gz            |     352 | 9fe9e42cfc5d084634569195fc11f6e2 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_4_0.csv.gz            |     288 | 3a3f209a4997c24a7c7e86d08d1e65cd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_5_0.csv.gz            |     256 | df653fad3016c308a56a91bf0a7d7373 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_6_0.csv.gz            |     352 | 1c26a2b3d19dd807c4878b347742a920 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_7_0.csv.gz            |     240 | 984aa5add77c20c2ef7dd01f9c583925 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_0_0.csv.gz            |     288 | 1abd052996cd723d9f5188ae7082a606 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_1_0.csv.gz            |     304 | 87c5f544069ec6da96160ad2421e82cb | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_2_0.csv.gz            |     272 | e744c76a7f77462d666130758ca32b30 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_3_0.csv.gz            |     320 | 06fe54498b886a5b064443eaa1405177 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_4_0.csv.gz            |     320 | 4fe977065b001f302a49101ebe4bd5ba | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_5_0.csv.gz            |     416 | aa9cf25e4521fbee1f24735cd8e3493c | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_6_0.csv.gz            |     368 | 4758d7d7e6bb7563ace77bd3a918213b | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_7_0.csv.gz            |     288 | 6105f98e1c25b5fa1a4120ec30c9a55f | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_4_0.csv.gz                |     176 | 60fec2e5a77b3bbceef76500e9418aed | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_6_0.csv.gz                |     560 | 230fc3769a2c292b4749d442064e5f4d | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_0_0.csv.gz                     |     928 | 2d945dec3a618cb693e581b3db777fea | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_1_0.csv.gz                     |  176464 | c440d63a85bee290f58bf1b0ef943cf8 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_2_0.csv.gz                     |   36128 | 7e0d853850d5c927ce969c6476a11dbd | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_3_0.csv.gz                     |   70224 | 4f6c0c3d4cd51abc80b1519c6751da4a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_4_0.csv.gz                     | 1324896 | a404bf1e96bf44b3c77dc284a7874114 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_5_0.csv.gz                     |  108688 | 6d92199ace70e1e8e96ad20305a8634a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_6_0.csv.gz                     |  733296 | ce2e1e4e39d6b0b8c2c3052b1c044fef | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_7_0.csv.gz                     |  367824 | 968e81af330c0e6eb4f5c803c3feeff0 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_0_0.csv.gz                     | 1054864 | 60229688817a1fc11a37bfd4f5bfae3b | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_1_0.csv.gz                     |  313584 | 41a2972c6dd25a0459fcf591b67ac7d5 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_2_0.csv.gz                     |  188912 | 0e6ee515d1740f02e79d2347216a2b9f | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_3_0.csv.gz                     |  678832 | 913dac450861ae098dd91f106c373079 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_4_0.csv.gz                     |    8992 | bea6ddbfcea32bc3f50c11049a609840 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_5_0.csv.gz                     |  105392 | 536750d9e42c0b2f05f5571fb28cb3c1 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_6_0.csv.gz                     |   87232 | 5c977afb4ee7457ec8b3db815223262e | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_7_0.csv.gz                     |  374176 | 807bf305d08b8ed2701702f1c7cf25b3 | Mon, 20 Sep 2021 06:10:47 GMT |
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
!source 100_acquisition/stage_storage_usage_history_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--
/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( usage_date ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/
--Suraj : removed comment

--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.


set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/stage_storage_usage_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,s.usage_date
        ,s.average_stage_bytes
    from
        snowflake.account_usage.stage_storage_usage_history s
    where
        s.usage_date >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|           219 |       14094 |         1667 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
| name                                                                                                                   |    size | md5                              | last_modified                 |
|------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz             |     144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz             |     144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz             |     160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz             |     128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz             |     160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz             |     128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz             |     160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz    |     768 | 719b352649fb44b17236833cf2e7faf3 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz    |     832 | baae15f11e36d4d7609e7860c756aecd | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz    |     912 | 5a10fcf3c2fea0d49d761360d7e65b02 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz    |     816 | e5a9d90192e239d147acd656ff64b1d0 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz    |     720 | ddf6b9823dbbb97fdaac11ac8dd9335b | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz    |     848 | 77cff417b66e9a73ca1467ebe59515d9 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz    |     736 | 729aab4d82ddac0d492ce7e7cc8302cc | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz    |     896 | 7a423e8132936e0709f5eded7f89ff50 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz    |     752 | fe3a7639e8a4ea2ea8a0b8a7b465accb | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz    |     992 | 4647f26041eb765e736d9fe065e2c984 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz    |     816 | 68aec6faa928eb4c5cbccb134ea95c4c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz    |     848 | f9e67356d0088ae8c65217ebc246278c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz    |     928 | 585cbdd0cdc969afc0ea5679924b3f39 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz    |     704 | fc885cb0c276f0a469fe1905d40b0149 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz    |     880 | 5abbf523d2795f46cf8c49e5a7508f1e | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz    |     736 | ac99fb43fa4f9d0b3b266bd64a998d72 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_2_0.csv.gz |     160 | d639a69890ce3dd7f81227ee051368dc | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_4_0.csv.gz |     192 | b17e95a93177409d4d7708282d00f6eb | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_0_0.csv.gz            |     272 | 5903e276c551c3b597c02a88ea61b527 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_1_0.csv.gz            |     480 | 79aac75907c1376f815f5c208d587acd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_2_0.csv.gz            |     288 | 78d9ffed38fb2e3b74b412f2eb27e208 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_3_0.csv.gz            |     352 | 9fe9e42cfc5d084634569195fc11f6e2 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_4_0.csv.gz            |     288 | 3a3f209a4997c24a7c7e86d08d1e65cd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_5_0.csv.gz            |     256 | df653fad3016c308a56a91bf0a7d7373 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_6_0.csv.gz            |     352 | 1c26a2b3d19dd807c4878b347742a920 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_7_0.csv.gz            |     240 | 984aa5add77c20c2ef7dd01f9c583925 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_0_0.csv.gz            |     288 | 1abd052996cd723d9f5188ae7082a606 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_1_0.csv.gz            |     304 | 87c5f544069ec6da96160ad2421e82cb | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_2_0.csv.gz            |     272 | e744c76a7f77462d666130758ca32b30 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_3_0.csv.gz            |     320 | 06fe54498b886a5b064443eaa1405177 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_4_0.csv.gz            |     320 | 4fe977065b001f302a49101ebe4bd5ba | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_5_0.csv.gz            |     416 | aa9cf25e4521fbee1f24735cd8e3493c | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_6_0.csv.gz            |     368 | 4758d7d7e6bb7563ace77bd3a918213b | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_7_0.csv.gz            |     288 | 6105f98e1c25b5fa1a4120ec30c9a55f | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_4_0.csv.gz                |     176 | 60fec2e5a77b3bbceef76500e9418aed | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_6_0.csv.gz                |     560 | 230fc3769a2c292b4749d442064e5f4d | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_0_0.csv.gz                     |     928 | 2d945dec3a618cb693e581b3db777fea | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_1_0.csv.gz                     |  176464 | c440d63a85bee290f58bf1b0ef943cf8 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_2_0.csv.gz                     |   36128 | 7e0d853850d5c927ce969c6476a11dbd | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_3_0.csv.gz                     |   70224 | 4f6c0c3d4cd51abc80b1519c6751da4a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_4_0.csv.gz                     | 1324896 | a404bf1e96bf44b3c77dc284a7874114 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_5_0.csv.gz                     |  108688 | 6d92199ace70e1e8e96ad20305a8634a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_6_0.csv.gz                     |  733296 | ce2e1e4e39d6b0b8c2c3052b1c044fef | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_7_0.csv.gz                     |  367824 | 968e81af330c0e6eb4f5c803c3feeff0 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_0_0.csv.gz                     | 1054864 | 60229688817a1fc11a37bfd4f5bfae3b | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_1_0.csv.gz                     |  313584 | 41a2972c6dd25a0459fcf591b67ac7d5 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_2_0.csv.gz                     |  188912 | 0e6ee515d1740f02e79d2347216a2b9f | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_3_0.csv.gz                     |  678832 | 913dac450861ae098dd91f106c373079 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_4_0.csv.gz                     |    8992 | bea6ddbfcea32bc3f50c11049a609840 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_5_0.csv.gz                     |  105392 | 536750d9e42c0b2f05f5571fb28cb3c1 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_6_0.csv.gz                     |   87232 | 5c977afb4ee7457ec8b3db815223262e | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_7_0.csv.gz                     |  374176 | 807bf305d08b8ed2701702f1c7cf25b3 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_0_0.csv.gz       |     768 | 734d3c56481603e42903c2b0e9aa08b4 | Mon, 20 Sep 2021 06:10:50 GMT |
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_1_0.csv.gz       |     912 | 2d9c3b8580f5de780c18a32df1d672a1 | Mon, 20 Sep 2021 06:10:50 GMT |
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
!source 100_acquisition/warehouse_load_history_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--
/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( start_time ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.warehouse_load_history
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/
--Suraj : removed comment

--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.

set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/warehouse_load_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,s.start_time
        ,s.end_time
        ,s.warehouse_id
        ,s.warehouse_name
        ,s.avg_running
        ,s.avg_queued_load
        ,s.avg_queued_provisioning
        ,s.avg_blocked
    from
        snowflake.account_usage.warehouse_load_history s
    where
        s.start_time >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|          4808 |      796108 |        64570 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
| name                                                                                                                   |    size | md5                              | last_modified                 |
|------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz             |     144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz             |     144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz             |     160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz             |     128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz             |     160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz             |     128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz             |     160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz    |     768 | 719b352649fb44b17236833cf2e7faf3 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz    |     832 | baae15f11e36d4d7609e7860c756aecd | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz    |     912 | 5a10fcf3c2fea0d49d761360d7e65b02 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz    |     816 | e5a9d90192e239d147acd656ff64b1d0 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz    |     720 | ddf6b9823dbbb97fdaac11ac8dd9335b | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz    |     848 | 77cff417b66e9a73ca1467ebe59515d9 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz    |     736 | 729aab4d82ddac0d492ce7e7cc8302cc | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz    |     896 | 7a423e8132936e0709f5eded7f89ff50 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz    |     752 | fe3a7639e8a4ea2ea8a0b8a7b465accb | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz    |     992 | 4647f26041eb765e736d9fe065e2c984 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz    |     816 | 68aec6faa928eb4c5cbccb134ea95c4c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz    |     848 | f9e67356d0088ae8c65217ebc246278c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz    |     928 | 585cbdd0cdc969afc0ea5679924b3f39 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz    |     704 | fc885cb0c276f0a469fe1905d40b0149 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz    |     880 | 5abbf523d2795f46cf8c49e5a7508f1e | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz    |     736 | ac99fb43fa4f9d0b3b266bd64a998d72 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_2_0.csv.gz |     160 | d639a69890ce3dd7f81227ee051368dc | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_4_0.csv.gz |     192 | b17e95a93177409d4d7708282d00f6eb | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_0_0.csv.gz            |     272 | 5903e276c551c3b597c02a88ea61b527 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_1_0.csv.gz            |     480 | 79aac75907c1376f815f5c208d587acd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_2_0.csv.gz            |     288 | 78d9ffed38fb2e3b74b412f2eb27e208 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_3_0.csv.gz            |     352 | 9fe9e42cfc5d084634569195fc11f6e2 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_4_0.csv.gz            |     288 | 3a3f209a4997c24a7c7e86d08d1e65cd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_5_0.csv.gz            |     256 | df653fad3016c308a56a91bf0a7d7373 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_6_0.csv.gz            |     352 | 1c26a2b3d19dd807c4878b347742a920 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_7_0.csv.gz            |     240 | 984aa5add77c20c2ef7dd01f9c583925 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_0_0.csv.gz            |     288 | 1abd052996cd723d9f5188ae7082a606 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_1_0.csv.gz            |     304 | 87c5f544069ec6da96160ad2421e82cb | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_2_0.csv.gz            |     272 | e744c76a7f77462d666130758ca32b30 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_3_0.csv.gz            |     320 | 06fe54498b886a5b064443eaa1405177 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_4_0.csv.gz            |     320 | 4fe977065b001f302a49101ebe4bd5ba | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_5_0.csv.gz            |     416 | aa9cf25e4521fbee1f24735cd8e3493c | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_6_0.csv.gz            |     368 | 4758d7d7e6bb7563ace77bd3a918213b | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_7_0.csv.gz            |     288 | 6105f98e1c25b5fa1a4120ec30c9a55f | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_4_0.csv.gz                |     176 | 60fec2e5a77b3bbceef76500e9418aed | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_6_0.csv.gz                |     560 | 230fc3769a2c292b4749d442064e5f4d | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_0_0.csv.gz                     |     928 | 2d945dec3a618cb693e581b3db777fea | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_1_0.csv.gz                     |  176464 | c440d63a85bee290f58bf1b0ef943cf8 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_2_0.csv.gz                     |   36128 | 7e0d853850d5c927ce969c6476a11dbd | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_3_0.csv.gz                     |   70224 | 4f6c0c3d4cd51abc80b1519c6751da4a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_4_0.csv.gz                     | 1324896 | a404bf1e96bf44b3c77dc284a7874114 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_5_0.csv.gz                     |  108688 | 6d92199ace70e1e8e96ad20305a8634a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_6_0.csv.gz                     |  733296 | ce2e1e4e39d6b0b8c2c3052b1c044fef | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_7_0.csv.gz                     |  367824 | 968e81af330c0e6eb4f5c803c3feeff0 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_0_0.csv.gz                     | 1054864 | 60229688817a1fc11a37bfd4f5bfae3b | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_1_0.csv.gz                     |  313584 | 41a2972c6dd25a0459fcf591b67ac7d5 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_2_0.csv.gz                     |  188912 | 0e6ee515d1740f02e79d2347216a2b9f | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_3_0.csv.gz                     |  678832 | 913dac450861ae098dd91f106c373079 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_4_0.csv.gz                     |    8992 | bea6ddbfcea32bc3f50c11049a609840 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_5_0.csv.gz                     |  105392 | 536750d9e42c0b2f05f5571fb28cb3c1 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_6_0.csv.gz                     |   87232 | 5c977afb4ee7457ec8b3db815223262e | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_7_0.csv.gz                     |  374176 | 807bf305d08b8ed2701702f1c7cf25b3 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_0_0.csv.gz       |     768 | 734d3c56481603e42903c2b0e9aa08b4 | Mon, 20 Sep 2021 06:10:50 GMT |
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_1_0.csv.gz       |     912 | 2d9c3b8580f5de780c18a32df1d672a1 | Mon, 20 Sep 2021 06:10:50 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_0_0.csv.gz            |    1840 | 278e1112da439e28f1f5f9a815f3efe8 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_1_0.csv.gz            |   12656 | 65a6f644631740a7c3e9047e0af300fc | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_2_0.csv.gz            |     144 | 2855594d765322fbd477bb297f7410c6 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_4_0.csv.gz            |    2240 | 9a25f46a715984fe4cf6c281b44c7d63 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_5_0.csv.gz            |    2976 | 198f5e243009d8821a91a397e072d2ee | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_6_0.csv.gz            |   28976 | 5726096e95c5f287dd27b87c945fc1f3 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_0_0.csv.gz            |    4176 | 3b262c3a6270e70861dddc51f7c80ded | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_1_0.csv.gz            |     432 | 57f3e6dedccb9051c4fa7dd0845ba736 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_2_0.csv.gz            |    2576 | 67cc91d47b9b548b513cea5ac584c096 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_3_0.csv.gz            |    1952 | 173708ffeb3c4b39579c1c34bbeb784e | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_4_0.csv.gz            |    2224 | 6918bdc630f92bac0f3251ea65c5f308 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_5_0.csv.gz            |     784 | c0720bec5f1f4d5c877543c877b548ed | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_6_0.csv.gz            |    3392 | fe966663febb580c259546ec62c47d7c | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_7_0.csv.gz            |     288 | c9b5151654cdf965ef710564853af5ab | Mon, 20 Sep 2021 06:10:51 GMT |
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
!source 100_acquisition/warehouse_metering_history_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--
/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( start_time ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/
--Suraj : removed comment

--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.

set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/warehouse_metering_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,s.start_time
        ,s.end_time
        ,s.warehouse_id
        ,s.warehouse_name
        ,s.credits_used
        ,s.credits_used_compute
        ,s.credits_used_cloud_services
    from
        snowflake.account_usage.warehouse_metering_history s
    where
        s.start_time >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|          1327 |      206359 |        30074 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
| name                                                                                                                   |    size | md5                              | last_modified                 |
|------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz             |     144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz             |     144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz             |     160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz             |     128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz             |     160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz             |     128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz             |     160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz    |     768 | 719b352649fb44b17236833cf2e7faf3 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz    |     832 | baae15f11e36d4d7609e7860c756aecd | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz    |     912 | 5a10fcf3c2fea0d49d761360d7e65b02 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz    |     816 | e5a9d90192e239d147acd656ff64b1d0 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz    |     720 | ddf6b9823dbbb97fdaac11ac8dd9335b | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz    |     848 | 77cff417b66e9a73ca1467ebe59515d9 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz    |     736 | 729aab4d82ddac0d492ce7e7cc8302cc | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz    |     896 | 7a423e8132936e0709f5eded7f89ff50 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz    |     752 | fe3a7639e8a4ea2ea8a0b8a7b465accb | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz    |     992 | 4647f26041eb765e736d9fe065e2c984 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz    |     816 | 68aec6faa928eb4c5cbccb134ea95c4c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz    |     848 | f9e67356d0088ae8c65217ebc246278c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz    |     928 | 585cbdd0cdc969afc0ea5679924b3f39 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz    |     704 | fc885cb0c276f0a469fe1905d40b0149 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz    |     880 | 5abbf523d2795f46cf8c49e5a7508f1e | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz    |     736 | ac99fb43fa4f9d0b3b266bd64a998d72 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_2_0.csv.gz |     160 | d639a69890ce3dd7f81227ee051368dc | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_4_0.csv.gz |     192 | b17e95a93177409d4d7708282d00f6eb | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_0_0.csv.gz            |     272 | 5903e276c551c3b597c02a88ea61b527 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_1_0.csv.gz            |     480 | 79aac75907c1376f815f5c208d587acd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_2_0.csv.gz            |     288 | 78d9ffed38fb2e3b74b412f2eb27e208 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_3_0.csv.gz            |     352 | 9fe9e42cfc5d084634569195fc11f6e2 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_4_0.csv.gz            |     288 | 3a3f209a4997c24a7c7e86d08d1e65cd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_5_0.csv.gz            |     256 | df653fad3016c308a56a91bf0a7d7373 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_6_0.csv.gz            |     352 | 1c26a2b3d19dd807c4878b347742a920 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_7_0.csv.gz            |     240 | 984aa5add77c20c2ef7dd01f9c583925 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_0_0.csv.gz            |     288 | 1abd052996cd723d9f5188ae7082a606 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_1_0.csv.gz            |     304 | 87c5f544069ec6da96160ad2421e82cb | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_2_0.csv.gz            |     272 | e744c76a7f77462d666130758ca32b30 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_3_0.csv.gz            |     320 | 06fe54498b886a5b064443eaa1405177 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_4_0.csv.gz            |     320 | 4fe977065b001f302a49101ebe4bd5ba | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_5_0.csv.gz            |     416 | aa9cf25e4521fbee1f24735cd8e3493c | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_6_0.csv.gz            |     368 | 4758d7d7e6bb7563ace77bd3a918213b | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_7_0.csv.gz            |     288 | 6105f98e1c25b5fa1a4120ec30c9a55f | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_4_0.csv.gz                |     176 | 60fec2e5a77b3bbceef76500e9418aed | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_6_0.csv.gz                |     560 | 230fc3769a2c292b4749d442064e5f4d | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_0_0.csv.gz                     |     928 | 2d945dec3a618cb693e581b3db777fea | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_1_0.csv.gz                     |  176464 | c440d63a85bee290f58bf1b0ef943cf8 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_2_0.csv.gz                     |   36128 | 7e0d853850d5c927ce969c6476a11dbd | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_3_0.csv.gz                     |   70224 | 4f6c0c3d4cd51abc80b1519c6751da4a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_4_0.csv.gz                     | 1324896 | a404bf1e96bf44b3c77dc284a7874114 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_5_0.csv.gz                     |  108688 | 6d92199ace70e1e8e96ad20305a8634a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_6_0.csv.gz                     |  733296 | ce2e1e4e39d6b0b8c2c3052b1c044fef | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_7_0.csv.gz                     |  367824 | 968e81af330c0e6eb4f5c803c3feeff0 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_0_0.csv.gz                     | 1054864 | 60229688817a1fc11a37bfd4f5bfae3b | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_1_0.csv.gz                     |  313584 | 41a2972c6dd25a0459fcf591b67ac7d5 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_2_0.csv.gz                     |  188912 | 0e6ee515d1740f02e79d2347216a2b9f | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_3_0.csv.gz                     |  678832 | 913dac450861ae098dd91f106c373079 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_4_0.csv.gz                     |    8992 | bea6ddbfcea32bc3f50c11049a609840 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_5_0.csv.gz                     |  105392 | 536750d9e42c0b2f05f5571fb28cb3c1 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_6_0.csv.gz                     |   87232 | 5c977afb4ee7457ec8b3db815223262e | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_7_0.csv.gz                     |  374176 | 807bf305d08b8ed2701702f1c7cf25b3 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_0_0.csv.gz       |     768 | 734d3c56481603e42903c2b0e9aa08b4 | Mon, 20 Sep 2021 06:10:50 GMT |
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_1_0.csv.gz       |     912 | 2d9c3b8580f5de780c18a32df1d672a1 | Mon, 20 Sep 2021 06:10:50 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_0_0.csv.gz            |    1840 | 278e1112da439e28f1f5f9a815f3efe8 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_1_0.csv.gz            |   12656 | 65a6f644631740a7c3e9047e0af300fc | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_2_0.csv.gz            |     144 | 2855594d765322fbd477bb297f7410c6 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_4_0.csv.gz            |    2240 | 9a25f46a715984fe4cf6c281b44c7d63 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_5_0.csv.gz            |    2976 | 198f5e243009d8821a91a397e072d2ee | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_6_0.csv.gz            |   28976 | 5726096e95c5f287dd27b87c945fc1f3 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_0_0.csv.gz            |    4176 | 3b262c3a6270e70861dddc51f7c80ded | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_1_0.csv.gz            |     432 | 57f3e6dedccb9051c4fa7dd0845ba736 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_2_0.csv.gz            |    2576 | 67cc91d47b9b548b513cea5ac584c096 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_3_0.csv.gz            |    1952 | 173708ffeb3c4b39579c1c34bbeb784e | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_4_0.csv.gz            |    2224 | 6918bdc630f92bac0f3251ea65c5f308 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_5_0.csv.gz            |     784 | c0720bec5f1f4d5c877543c877b548ed | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_6_0.csv.gz            |    3392 | fe966663febb580c259546ec62c47d7c | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_7_0.csv.gz            |     288 | c9b5151654cdf965ef710564853af5ab | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_0_0.csv.gz        |    1296 | 1fb490d93330a8d15bbdab183a1ad002 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_1_0.csv.gz        |    1088 | 2663182563e895be47e704fdf5005f22 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_2_0.csv.gz        |    2176 | e50b95179326c54375dc602404eb523b | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_3_0.csv.gz        |    1104 | 43a6efd178e60be8b2afe958a7b9f41e | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_4_0.csv.gz        |    1136 | a5998f85dc75340df6cb3be54622dc2f | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_5_0.csv.gz        |    1440 | 31ce0a57735faa408c2c622221e2b06c | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_6_0.csv.gz        |    1648 | 2093fde6194f83546f70d6e8a3fa791c | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_7_0.csv.gz        |    2096 | 11c5dbe0e5100e98e7ec304f389f41dd | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_0_0.csv.gz        |    1744 | 9142fcc4d0524ed6728400c96a3b9639 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_1_0.csv.gz        |    1936 | e016f3b1e232301cab830427c44d50f6 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_2_0.csv.gz        |    2544 | d735b5175d7b824fd10a4bc037a7f0a7 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_3_0.csv.gz        |    2944 | 2b3558506f3798a8b4710ef43cb69fa5 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_4_0.csv.gz        |    1616 | 69f7dbdc1580ac202a1ab562ad698e04 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_5_0.csv.gz        |    3024 | 243ea7dd3ec84e94df8f91dd9296eaa3 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_6_0.csv.gz        |    2624 | dda09e8cd641838578c85958a656815f | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_7_0.csv.gz        |    1808 | 806f27ce770c419471fbbe699cfd5760 | Mon, 20 Sep 2021 06:10:52 GMT |
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+

!source 100_acquisition/warehouse_metering_history_reader_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--
/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( start_time ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/

--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.

set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/reader_warehouse_metering_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,reader_account_name            
        ,s.start_time
        ,s.end_time
        ,s.warehouse_id
        ,s.warehouse_name
        ,s.credits_used
        ,s.credits_used_compute
        ,s.credits_used_cloud_services
        ,s.reader_account_deleted_on
    from
        snowflake.reader_account_usage.warehouse_metering_history s
    where
        s.start_time >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|             2 |         350 |          274 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
| name                                                                                                                   |    size | md5                              | last_modified                 |
|------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz             |     144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz             |     144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz             |     160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz             |     128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz             |     160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz             |     128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz             |     160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz    |     768 | 719b352649fb44b17236833cf2e7faf3 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz    |     832 | baae15f11e36d4d7609e7860c756aecd | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz    |     912 | 5a10fcf3c2fea0d49d761360d7e65b02 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz    |     816 | e5a9d90192e239d147acd656ff64b1d0 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz    |     720 | ddf6b9823dbbb97fdaac11ac8dd9335b | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz    |     848 | 77cff417b66e9a73ca1467ebe59515d9 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz    |     736 | 729aab4d82ddac0d492ce7e7cc8302cc | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz    |     896 | 7a423e8132936e0709f5eded7f89ff50 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz    |     752 | fe3a7639e8a4ea2ea8a0b8a7b465accb | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz    |     992 | 4647f26041eb765e736d9fe065e2c984 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz    |     816 | 68aec6faa928eb4c5cbccb134ea95c4c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz    |     848 | f9e67356d0088ae8c65217ebc246278c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz    |     928 | 585cbdd0cdc969afc0ea5679924b3f39 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz    |     704 | fc885cb0c276f0a469fe1905d40b0149 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz    |     880 | 5abbf523d2795f46cf8c49e5a7508f1e | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz    |     736 | ac99fb43fa4f9d0b3b266bd64a998d72 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_2_0.csv.gz |     160 | d639a69890ce3dd7f81227ee051368dc | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_4_0.csv.gz |     192 | b17e95a93177409d4d7708282d00f6eb | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_0_0.csv.gz            |     272 | 5903e276c551c3b597c02a88ea61b527 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_1_0.csv.gz            |     480 | 79aac75907c1376f815f5c208d587acd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_2_0.csv.gz            |     288 | 78d9ffed38fb2e3b74b412f2eb27e208 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_3_0.csv.gz            |     352 | 9fe9e42cfc5d084634569195fc11f6e2 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_4_0.csv.gz            |     288 | 3a3f209a4997c24a7c7e86d08d1e65cd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_5_0.csv.gz            |     256 | df653fad3016c308a56a91bf0a7d7373 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_6_0.csv.gz            |     352 | 1c26a2b3d19dd807c4878b347742a920 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_7_0.csv.gz            |     240 | 984aa5add77c20c2ef7dd01f9c583925 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_0_0.csv.gz            |     288 | 1abd052996cd723d9f5188ae7082a606 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_1_0.csv.gz            |     304 | 87c5f544069ec6da96160ad2421e82cb | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_2_0.csv.gz            |     272 | e744c76a7f77462d666130758ca32b30 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_3_0.csv.gz            |     320 | 06fe54498b886a5b064443eaa1405177 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_4_0.csv.gz            |     320 | 4fe977065b001f302a49101ebe4bd5ba | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_5_0.csv.gz            |     416 | aa9cf25e4521fbee1f24735cd8e3493c | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_6_0.csv.gz            |     368 | 4758d7d7e6bb7563ace77bd3a918213b | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_7_0.csv.gz            |     288 | 6105f98e1c25b5fa1a4120ec30c9a55f | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_4_0.csv.gz                |     176 | 60fec2e5a77b3bbceef76500e9418aed | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_6_0.csv.gz                |     560 | 230fc3769a2c292b4749d442064e5f4d | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_0_0.csv.gz                     |     928 | 2d945dec3a618cb693e581b3db777fea | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_1_0.csv.gz                     |  176464 | c440d63a85bee290f58bf1b0ef943cf8 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_2_0.csv.gz                     |   36128 | 7e0d853850d5c927ce969c6476a11dbd | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_3_0.csv.gz                     |   70224 | 4f6c0c3d4cd51abc80b1519c6751da4a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_4_0.csv.gz                     | 1324896 | a404bf1e96bf44b3c77dc284a7874114 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_5_0.csv.gz                     |  108688 | 6d92199ace70e1e8e96ad20305a8634a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_6_0.csv.gz                     |  733296 | ce2e1e4e39d6b0b8c2c3052b1c044fef | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_7_0.csv.gz                     |  367824 | 968e81af330c0e6eb4f5c803c3feeff0 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_0_0.csv.gz                     | 1054864 | 60229688817a1fc11a37bfd4f5bfae3b | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_1_0.csv.gz                     |  313584 | 41a2972c6dd25a0459fcf591b67ac7d5 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_2_0.csv.gz                     |  188912 | 0e6ee515d1740f02e79d2347216a2b9f | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_3_0.csv.gz                     |  678832 | 913dac450861ae098dd91f106c373079 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_4_0.csv.gz                     |    8992 | bea6ddbfcea32bc3f50c11049a609840 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_5_0.csv.gz                     |  105392 | 536750d9e42c0b2f05f5571fb28cb3c1 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_6_0.csv.gz                     |   87232 | 5c977afb4ee7457ec8b3db815223262e | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_7_0.csv.gz                     |  374176 | 807bf305d08b8ed2701702f1c7cf25b3 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/reader_warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0bb-0027-cb83009da4d2_1_1_0.csv.gz |     144 | bde79080d851831b6081a9779ecf1a18 | Mon, 20 Sep 2021 06:10:55 GMT |
| account_usage_stg/reader_warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0bb-0027-cb83009da4d2_1_2_0.csv.gz |     144 | ff7d9bed8b5437331b8fb439a92ef819 | Mon, 20 Sep 2021 06:10:55 GMT |
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_0_0.csv.gz       |     768 | 734d3c56481603e42903c2b0e9aa08b4 | Mon, 20 Sep 2021 06:10:50 GMT |
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_1_0.csv.gz       |     912 | 2d9c3b8580f5de780c18a32df1d672a1 | Mon, 20 Sep 2021 06:10:50 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_0_0.csv.gz            |    1840 | 278e1112da439e28f1f5f9a815f3efe8 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_1_0.csv.gz            |   12656 | 65a6f644631740a7c3e9047e0af300fc | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_2_0.csv.gz            |     144 | 2855594d765322fbd477bb297f7410c6 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_4_0.csv.gz            |    2240 | 9a25f46a715984fe4cf6c281b44c7d63 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_5_0.csv.gz            |    2976 | 198f5e243009d8821a91a397e072d2ee | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_6_0.csv.gz            |   28976 | 5726096e95c5f287dd27b87c945fc1f3 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_0_0.csv.gz            |    4176 | 3b262c3a6270e70861dddc51f7c80ded | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_1_0.csv.gz            |     432 | 57f3e6dedccb9051c4fa7dd0845ba736 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_2_0.csv.gz            |    2576 | 67cc91d47b9b548b513cea5ac584c096 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_3_0.csv.gz            |    1952 | 173708ffeb3c4b39579c1c34bbeb784e | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_4_0.csv.gz            |    2224 | 6918bdc630f92bac0f3251ea65c5f308 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_5_0.csv.gz            |     784 | c0720bec5f1f4d5c877543c877b548ed | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_6_0.csv.gz            |    3392 | fe966663febb580c259546ec62c47d7c | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_7_0.csv.gz            |     288 | c9b5151654cdf965ef710564853af5ab | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_0_0.csv.gz        |    1296 | 1fb490d93330a8d15bbdab183a1ad002 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_1_0.csv.gz        |    1088 | 2663182563e895be47e704fdf5005f22 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_2_0.csv.gz        |    2176 | e50b95179326c54375dc602404eb523b | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_3_0.csv.gz        |    1104 | 43a6efd178e60be8b2afe958a7b9f41e | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_4_0.csv.gz        |    1136 | a5998f85dc75340df6cb3be54622dc2f | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_5_0.csv.gz        |    1440 | 31ce0a57735faa408c2c622221e2b06c | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_6_0.csv.gz        |    1648 | 2093fde6194f83546f70d6e8a3fa791c | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_7_0.csv.gz        |    2096 | 11c5dbe0e5100e98e7ec304f389f41dd | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_0_0.csv.gz        |    1744 | 9142fcc4d0524ed6728400c96a3b9639 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_1_0.csv.gz        |    1936 | e016f3b1e232301cab830427c44d50f6 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_2_0.csv.gz        |    2544 | d735b5175d7b824fd10a4bc037a7f0a7 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_3_0.csv.gz        |    2944 | 2b3558506f3798a8b4710ef43cb69fa5 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_4_0.csv.gz        |    1616 | 69f7dbdc1580ac202a1ab562ad698e04 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_5_0.csv.gz        |    3024 | 243ea7dd3ec84e94df8f91dd9296eaa3 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_6_0.csv.gz        |    2624 | dda09e8cd641838578c85958a656815f | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_7_0.csv.gz        |    1808 | 806f27ce770c419471fbbe699cfd5760 | Mon, 20 Sep 2021 06:10:52 GMT |
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
!source 100_acquisition/query_history_reader_acq.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- !!! Note: this first step is an example of what would need to be
--           executed against the target account to get the last
--           control date high water mark.  When implemented this
--           would be executed with a wrapper script like python and
--           then the date could be used to execute the copy into step
--           against the source account.
--
-- pull last event date from the table and back up n hours for late
-- arriving data.
--
/*
set l_last_control_dt =
(
    select
        ifnull( dateadd( hour, -4, max( start_time ) ), dateadd( month, -13, current_timestamp() ) ) as last_control_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.query_history_reader
    where
            organization_name = upper( 'APISERO' )
        and account_name      = upper( 'apisero_dev' )
);
*/

--------------------------------------------------------------------
-- !!! Note: code to use when demonstrating across multiple accounts.
--           uses a fixed delta window.

set l_last_control_dt =
(
    select dateadd( hour, -8784, current_timestamp() ) as last_control_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
   @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/reader_query_history/apisero_dev
from
(
    select
         upper( 'APISERO' )           as organization_name
        ,current_account()                  as account_name
        ,current_region()                   as region_name
        ,reader_account_name                AS reader_account_name
        ,s.query_id
        ,regexp_replace(replace(s.query_text, '"'),'[^[:print:]]','')    AS query_text
        ,s.database_id
        ,s.database_name
        ,s.schema_id
        ,s.schema_name
        ,s.query_type
        ,s.session_id
        ,s.user_name
        ,s.role_name
        ,s.warehouse_id
        ,s.warehouse_name
        ,s.warehouse_size
        ,s.warehouse_type
        ,s.cluster_number
        ,s.query_tag
        ,s.execution_status
        ,s.error_code
        ,s.error_message
        ,s.start_time
        ,s.end_time
        ,s.total_elapsed_time
        ,s.bytes_scanned
        ,s.rows_produced
        ,s.compilation_time
        ,s.execution_time
        ,s.queued_provisioning_time
        ,s.queued_repair_time
        ,s.queued_overload_time
        ,s.transaction_blocked_time
        ,s.outbound_data_transfer_cloud
        ,s.outbound_data_transfer_region
        ,s.outbound_data_transfer_bytes
        ,s.inbound_data_transfer_cloud
        ,s.inbound_data_transfer_region
        ,s.inbound_data_transfer_bytes
        ,s.list_external_files_time
        ,s.credits_used_cloud_services
        ,s.reader_account_deleted_on
    from
        snowflake.reader_account_usage.query_history s
    where
        s.start_time >= to_timestamp( $l_last_control_dt )
)
file_format      = ( type=csv field_optionally_enclosed_by = '"' )
include_query_id = true
overwrite        = false
single           = false
;
+---------------+-------------+--------------+
| rows_unloaded | input_bytes | output_bytes |
|---------------+-------------+--------------|
|            97 |       37819 |         3803 |
+---------------+-------------+--------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
| name                                                                                                                   |    size | md5                              | last_modified                 |
|------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz             |     144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz             |     144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz             |     160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz             |     128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz             |     160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz             |     128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz             |     160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz    |     768 | 719b352649fb44b17236833cf2e7faf3 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz    |     832 | baae15f11e36d4d7609e7860c756aecd | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz    |     912 | 5a10fcf3c2fea0d49d761360d7e65b02 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz    |     816 | e5a9d90192e239d147acd656ff64b1d0 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz    |     720 | ddf6b9823dbbb97fdaac11ac8dd9335b | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz    |     848 | 77cff417b66e9a73ca1467ebe59515d9 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz    |     736 | 729aab4d82ddac0d492ce7e7cc8302cc | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz    |     896 | 7a423e8132936e0709f5eded7f89ff50 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz    |     752 | fe3a7639e8a4ea2ea8a0b8a7b465accb | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz    |     992 | 4647f26041eb765e736d9fe065e2c984 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz    |     816 | 68aec6faa928eb4c5cbccb134ea95c4c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz    |     848 | f9e67356d0088ae8c65217ebc246278c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz    |     928 | 585cbdd0cdc969afc0ea5679924b3f39 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz    |     704 | fc885cb0c276f0a469fe1905d40b0149 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz    |     880 | 5abbf523d2795f46cf8c49e5a7508f1e | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz    |     736 | ac99fb43fa4f9d0b3b266bd64a998d72 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_2_0.csv.gz |     160 | d639a69890ce3dd7f81227ee051368dc | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_4_0.csv.gz |     192 | b17e95a93177409d4d7708282d00f6eb | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_0_0.csv.gz            |     272 | 5903e276c551c3b597c02a88ea61b527 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_1_0.csv.gz            |     480 | 79aac75907c1376f815f5c208d587acd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_2_0.csv.gz            |     288 | 78d9ffed38fb2e3b74b412f2eb27e208 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_3_0.csv.gz            |     352 | 9fe9e42cfc5d084634569195fc11f6e2 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_4_0.csv.gz            |     288 | 3a3f209a4997c24a7c7e86d08d1e65cd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_5_0.csv.gz            |     256 | df653fad3016c308a56a91bf0a7d7373 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_6_0.csv.gz            |     352 | 1c26a2b3d19dd807c4878b347742a920 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_7_0.csv.gz            |     240 | 984aa5add77c20c2ef7dd01f9c583925 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_0_0.csv.gz            |     288 | 1abd052996cd723d9f5188ae7082a606 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_1_0.csv.gz            |     304 | 87c5f544069ec6da96160ad2421e82cb | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_2_0.csv.gz            |     272 | e744c76a7f77462d666130758ca32b30 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_3_0.csv.gz            |     320 | 06fe54498b886a5b064443eaa1405177 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_4_0.csv.gz            |     320 | 4fe977065b001f302a49101ebe4bd5ba | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_5_0.csv.gz            |     416 | aa9cf25e4521fbee1f24735cd8e3493c | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_6_0.csv.gz            |     368 | 4758d7d7e6bb7563ace77bd3a918213b | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_7_0.csv.gz            |     288 | 6105f98e1c25b5fa1a4120ec30c9a55f | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_4_0.csv.gz                |     176 | 60fec2e5a77b3bbceef76500e9418aed | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_6_0.csv.gz                |     560 | 230fc3769a2c292b4749d442064e5f4d | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_0_0.csv.gz                     |     928 | 2d945dec3a618cb693e581b3db777fea | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_1_0.csv.gz                     |  176464 | c440d63a85bee290f58bf1b0ef943cf8 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_2_0.csv.gz                     |   36128 | 7e0d853850d5c927ce969c6476a11dbd | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_3_0.csv.gz                     |   70224 | 4f6c0c3d4cd51abc80b1519c6751da4a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_4_0.csv.gz                     | 1324896 | a404bf1e96bf44b3c77dc284a7874114 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_5_0.csv.gz                     |  108688 | 6d92199ace70e1e8e96ad20305a8634a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_6_0.csv.gz                     |  733296 | ce2e1e4e39d6b0b8c2c3052b1c044fef | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_7_0.csv.gz                     |  367824 | 968e81af330c0e6eb4f5c803c3feeff0 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_0_0.csv.gz                     | 1054864 | 60229688817a1fc11a37bfd4f5bfae3b | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_1_0.csv.gz                     |  313584 | 41a2972c6dd25a0459fcf591b67ac7d5 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_2_0.csv.gz                     |  188912 | 0e6ee515d1740f02e79d2347216a2b9f | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_3_0.csv.gz                     |  678832 | 913dac450861ae098dd91f106c373079 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_4_0.csv.gz                     |    8992 | bea6ddbfcea32bc3f50c11049a609840 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_5_0.csv.gz                     |  105392 | 536750d9e42c0b2f05f5571fb28cb3c1 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_6_0.csv.gz                     |   87232 | 5c977afb4ee7457ec8b3db815223262e | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_7_0.csv.gz                     |  374176 | 807bf305d08b8ed2701702f1c7cf25b3 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/reader_query_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db34a_1_2_0.csv.gz              |    3808 | 1ac4706259add1b68cdb185e50e60441 | Mon, 20 Sep 2021 06:11:24 GMT |
| account_usage_stg/reader_warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0bb-0027-cb83009da4d2_1_1_0.csv.gz |     144 | bde79080d851831b6081a9779ecf1a18 | Mon, 20 Sep 2021 06:10:55 GMT |
| account_usage_stg/reader_warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0bb-0027-cb83009da4d2_1_2_0.csv.gz |     144 | ff7d9bed8b5437331b8fb439a92ef819 | Mon, 20 Sep 2021 06:10:55 GMT |
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_0_0.csv.gz       |     768 | 734d3c56481603e42903c2b0e9aa08b4 | Mon, 20 Sep 2021 06:10:50 GMT |
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_1_0.csv.gz       |     912 | 2d9c3b8580f5de780c18a32df1d672a1 | Mon, 20 Sep 2021 06:10:50 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_0_0.csv.gz            |    1840 | 278e1112da439e28f1f5f9a815f3efe8 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_1_0.csv.gz            |   12656 | 65a6f644631740a7c3e9047e0af300fc | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_2_0.csv.gz            |     144 | 2855594d765322fbd477bb297f7410c6 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_4_0.csv.gz            |    2240 | 9a25f46a715984fe4cf6c281b44c7d63 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_5_0.csv.gz            |    2976 | 198f5e243009d8821a91a397e072d2ee | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_6_0.csv.gz            |   28976 | 5726096e95c5f287dd27b87c945fc1f3 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_0_0.csv.gz            |    4176 | 3b262c3a6270e70861dddc51f7c80ded | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_1_0.csv.gz            |     432 | 57f3e6dedccb9051c4fa7dd0845ba736 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_2_0.csv.gz            |    2576 | 67cc91d47b9b548b513cea5ac584c096 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_3_0.csv.gz            |    1952 | 173708ffeb3c4b39579c1c34bbeb784e | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_4_0.csv.gz            |    2224 | 6918bdc630f92bac0f3251ea65c5f308 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_5_0.csv.gz            |     784 | c0720bec5f1f4d5c877543c877b548ed | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_6_0.csv.gz            |    3392 | fe966663febb580c259546ec62c47d7c | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_7_0.csv.gz            |     288 | c9b5151654cdf965ef710564853af5ab | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_0_0.csv.gz        |    1296 | 1fb490d93330a8d15bbdab183a1ad002 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_1_0.csv.gz        |    1088 | 2663182563e895be47e704fdf5005f22 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_2_0.csv.gz        |    2176 | e50b95179326c54375dc602404eb523b | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_3_0.csv.gz        |    1104 | 43a6efd178e60be8b2afe958a7b9f41e | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_4_0.csv.gz        |    1136 | a5998f85dc75340df6cb3be54622dc2f | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_5_0.csv.gz        |    1440 | 31ce0a57735faa408c2c622221e2b06c | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_6_0.csv.gz        |    1648 | 2093fde6194f83546f70d6e8a3fa791c | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_7_0.csv.gz        |    2096 | 11c5dbe0e5100e98e7ec304f389f41dd | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_0_0.csv.gz        |    1744 | 9142fcc4d0524ed6728400c96a3b9639 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_1_0.csv.gz        |    1936 | e016f3b1e232301cab830427c44d50f6 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_2_0.csv.gz        |    2544 | d735b5175d7b824fd10a4bc037a7f0a7 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_3_0.csv.gz        |    2944 | 2b3558506f3798a8b4710ef43cb69fa5 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_4_0.csv.gz        |    1616 | 69f7dbdc1580ac202a1ab562ad698e04 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_5_0.csv.gz        |    3024 | 243ea7dd3ec84e94df8f91dd9296eaa3 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_6_0.csv.gz        |    2624 | dda09e8cd641838578c85958a656815f | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_7_0.csv.gz        |    1808 | 806f27ce770c419471fbbe699cfd5760 | Mon, 20 Sep 2021 06:10:52 GMT |
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
list @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg;
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+
| name                                                                                                                   |    size | md5                              | last_modified                 |
|------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz             |     144 | 926f49a3643adbe49dec69110a6a13dd | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz             |     144 | fea215df74c40dc6a7d39d8d81e84451 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz             |     160 | f854581292358b8848e10141c8eb62a2 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz             |     128 | 6d8713cb31a5523e7ac41a330d14df89 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz             |     160 | 31e4e12474fd5a4bb6e1fef0499e2e93 | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz             |     128 | 7f0b8c2b10ab260c26217baa6b1cd71e | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz             |     160 | 0a7db99825372f8c61b4804c50949e1f | Mon, 20 Sep 2021 06:10:31 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz    |     768 | 719b352649fb44b17236833cf2e7faf3 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz    |     832 | baae15f11e36d4d7609e7860c756aecd | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz    |     912 | 5a10fcf3c2fea0d49d761360d7e65b02 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz    |     816 | e5a9d90192e239d147acd656ff64b1d0 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz    |     720 | ddf6b9823dbbb97fdaac11ac8dd9335b | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz    |     848 | 77cff417b66e9a73ca1467ebe59515d9 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz    |     736 | 729aab4d82ddac0d492ce7e7cc8302cc | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz    |     896 | 7a423e8132936e0709f5eded7f89ff50 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz    |     752 | fe3a7639e8a4ea2ea8a0b8a7b465accb | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz    |     992 | 4647f26041eb765e736d9fe065e2c984 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz    |     816 | 68aec6faa928eb4c5cbccb134ea95c4c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz    |     848 | f9e67356d0088ae8c65217ebc246278c | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz    |     928 | 585cbdd0cdc969afc0ea5679924b3f39 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz    |     704 | fc885cb0c276f0a469fe1905d40b0149 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz    |     880 | 5abbf523d2795f46cf8c49e5a7508f1e | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz    |     736 | ac99fb43fa4f9d0b3b266bd64a998d72 | Mon, 20 Sep 2021 06:10:33 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_2_0.csv.gz |     160 | d639a69890ce3dd7f81227ee051368dc | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_4_0.csv.gz |     192 | b17e95a93177409d4d7708282d00f6eb | Mon, 20 Sep 2021 06:10:34 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_0_0.csv.gz            |     272 | 5903e276c551c3b597c02a88ea61b527 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_1_0.csv.gz            |     480 | 79aac75907c1376f815f5c208d587acd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_2_0.csv.gz            |     288 | 78d9ffed38fb2e3b74b412f2eb27e208 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_3_0.csv.gz            |     352 | 9fe9e42cfc5d084634569195fc11f6e2 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_4_0.csv.gz            |     288 | 3a3f209a4997c24a7c7e86d08d1e65cd | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_5_0.csv.gz            |     256 | df653fad3016c308a56a91bf0a7d7373 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_6_0.csv.gz            |     352 | 1c26a2b3d19dd807c4878b347742a920 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_7_0.csv.gz            |     240 | 984aa5add77c20c2ef7dd01f9c583925 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_0_0.csv.gz            |     288 | 1abd052996cd723d9f5188ae7082a606 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_1_0.csv.gz            |     304 | 87c5f544069ec6da96160ad2421e82cb | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_2_0.csv.gz            |     272 | e744c76a7f77462d666130758ca32b30 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_3_0.csv.gz            |     320 | 06fe54498b886a5b064443eaa1405177 | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_4_0.csv.gz            |     320 | 4fe977065b001f302a49101ebe4bd5ba | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_5_0.csv.gz            |     416 | aa9cf25e4521fbee1f24735cd8e3493c | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_6_0.csv.gz            |     368 | 4758d7d7e6bb7563ace77bd3a918213b | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_7_0.csv.gz            |     288 | 6105f98e1c25b5fa1a4120ec30c9a55f | Mon, 20 Sep 2021 06:10:39 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_4_0.csv.gz                |     176 | 60fec2e5a77b3bbceef76500e9418aed | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_6_0.csv.gz                |     560 | 230fc3769a2c292b4749d442064e5f4d | Mon, 20 Sep 2021 06:10:42 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_0_0.csv.gz                     |     928 | 2d945dec3a618cb693e581b3db777fea | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_1_0.csv.gz                     |  176464 | c440d63a85bee290f58bf1b0ef943cf8 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_2_0.csv.gz                     |   36128 | 7e0d853850d5c927ce969c6476a11dbd | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_3_0.csv.gz                     |   70224 | 4f6c0c3d4cd51abc80b1519c6751da4a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_4_0.csv.gz                     | 1324896 | a404bf1e96bf44b3c77dc284a7874114 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_5_0.csv.gz                     |  108688 | 6d92199ace70e1e8e96ad20305a8634a | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_6_0.csv.gz                     |  733296 | ce2e1e4e39d6b0b8c2c3052b1c044fef | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_7_0.csv.gz                     |  367824 | 968e81af330c0e6eb4f5c803c3feeff0 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_0_0.csv.gz                     | 1054864 | 60229688817a1fc11a37bfd4f5bfae3b | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_1_0.csv.gz                     |  313584 | 41a2972c6dd25a0459fcf591b67ac7d5 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_2_0.csv.gz                     |  188912 | 0e6ee515d1740f02e79d2347216a2b9f | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_3_0.csv.gz                     |  678832 | 913dac450861ae098dd91f106c373079 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_4_0.csv.gz                     |    8992 | bea6ddbfcea32bc3f50c11049a609840 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_5_0.csv.gz                     |  105392 | 536750d9e42c0b2f05f5571fb28cb3c1 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_6_0.csv.gz                     |   87232 | 5c977afb4ee7457ec8b3db815223262e | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_7_0.csv.gz                     |  374176 | 807bf305d08b8ed2701702f1c7cf25b3 | Mon, 20 Sep 2021 06:10:47 GMT |
| account_usage_stg/reader_query_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db34a_1_2_0.csv.gz              |    3808 | 1ac4706259add1b68cdb185e50e60441 | Mon, 20 Sep 2021 06:11:24 GMT |
| account_usage_stg/reader_warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0bb-0027-cb83009da4d2_1_1_0.csv.gz |     144 | bde79080d851831b6081a9779ecf1a18 | Mon, 20 Sep 2021 06:10:55 GMT |
| account_usage_stg/reader_warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0bb-0027-cb83009da4d2_1_2_0.csv.gz |     144 | ff7d9bed8b5437331b8fb439a92ef819 | Mon, 20 Sep 2021 06:10:55 GMT |
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_0_0.csv.gz       |     768 | 734d3c56481603e42903c2b0e9aa08b4 | Mon, 20 Sep 2021 06:10:50 GMT |
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_1_0.csv.gz       |     912 | 2d9c3b8580f5de780c18a32df1d672a1 | Mon, 20 Sep 2021 06:10:50 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_0_0.csv.gz            |    1840 | 278e1112da439e28f1f5f9a815f3efe8 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_1_0.csv.gz            |   12656 | 65a6f644631740a7c3e9047e0af300fc | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_2_0.csv.gz            |     144 | 2855594d765322fbd477bb297f7410c6 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_4_0.csv.gz            |    2240 | 9a25f46a715984fe4cf6c281b44c7d63 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_5_0.csv.gz            |    2976 | 198f5e243009d8821a91a397e072d2ee | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_6_0.csv.gz            |   28976 | 5726096e95c5f287dd27b87c945fc1f3 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_0_0.csv.gz            |    4176 | 3b262c3a6270e70861dddc51f7c80ded | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_1_0.csv.gz            |     432 | 57f3e6dedccb9051c4fa7dd0845ba736 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_2_0.csv.gz            |    2576 | 67cc91d47b9b548b513cea5ac584c096 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_3_0.csv.gz            |    1952 | 173708ffeb3c4b39579c1c34bbeb784e | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_4_0.csv.gz            |    2224 | 6918bdc630f92bac0f3251ea65c5f308 | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_5_0.csv.gz            |     784 | c0720bec5f1f4d5c877543c877b548ed | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_6_0.csv.gz            |    3392 | fe966663febb580c259546ec62c47d7c | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_7_0.csv.gz            |     288 | c9b5151654cdf965ef710564853af5ab | Mon, 20 Sep 2021 06:10:51 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_0_0.csv.gz        |    1296 | 1fb490d93330a8d15bbdab183a1ad002 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_1_0.csv.gz        |    1088 | 2663182563e895be47e704fdf5005f22 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_2_0.csv.gz        |    2176 | e50b95179326c54375dc602404eb523b | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_3_0.csv.gz        |    1104 | 43a6efd178e60be8b2afe958a7b9f41e | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_4_0.csv.gz        |    1136 | a5998f85dc75340df6cb3be54622dc2f | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_5_0.csv.gz        |    1440 | 31ce0a57735faa408c2c622221e2b06c | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_6_0.csv.gz        |    1648 | 2093fde6194f83546f70d6e8a3fa791c | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_7_0.csv.gz        |    2096 | 11c5dbe0e5100e98e7ec304f389f41dd | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_0_0.csv.gz        |    1744 | 9142fcc4d0524ed6728400c96a3b9639 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_1_0.csv.gz        |    1936 | e016f3b1e232301cab830427c44d50f6 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_2_0.csv.gz        |    2544 | d735b5175d7b824fd10a4bc037a7f0a7 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_3_0.csv.gz        |    2944 | 2b3558506f3798a8b4710ef43cb69fa5 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_4_0.csv.gz        |    1616 | 69f7dbdc1580ac202a1ab562ad698e04 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_5_0.csv.gz        |    3024 | 243ea7dd3ec84e94df8f91dd9296eaa3 | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_6_0.csv.gz        |    2624 | dda09e8cd641838578c85958a656815f | Mon, 20 Sep 2021 06:10:52 GMT |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_7_0.csv.gz        |    1808 | 806f27ce770c419471fbbe699cfd5760 | Mon, 20 Sep 2021 06:10:52 GMT |
+------------------------------------------------------------------------------------------------------------------------+---------+----------------------------------+-------------------------------+

!print SUCCESS!
SUCCESS!

!disconnect
-- !print 000_admin acquisition account 2 ---------------------------------------

-- !define l_account_name="by_euw_prd"
-- !connect &{l_account_name}

-- -- org the snowflake account resides in
-- !define l_org_name='BY'
-- !source 000_admin/account_acq_100_acquisition_orch.sql

-- !disconnect

-- !print 000_admin acquisition account 3 ---------------------------------------

-- !define l_account_name="by_org"
-- !connect &{l_account_name}

-- -- org the snowflake account resides in
-- !define l_org_name='BY'
-- !source 000_admin/account_acq_100_acquisition_orch.sql

-- !disconnect


------------------------------------------------------------------------------
-- 000_admin load
--
-- Load all acquisition step files
--
!print 000_admin account load ------------------------------org account--------------------------
000_admin account load ------------------------------org account--------------------------

!define l_account_name="apisero_dev"
!connect apisero_dev

!source 000_admin/account_ld_000_admin_orch.sql
------------------------------------------------------------------------------
-- 000_admin
--
!print 000_admin
000_admin

!print SUCCESS!
SUCCESS!
!source 000_admin/account_ld_200_raw_orch.sql
------------------------------------------------------------------------------
-- 200_raw
--
!print 200_raw
200_raw
-- reference data needed by downstream processes for mapping wareho--use and database resources to business entities
-- also cost numbers used to convert credits to cost of consumption
!print 200_raw Step 1
200_raw Step 1

!source 200_raw/be_resource_mapping_lkp_ld.sql
--------------------------------------------------------------------
--  Purpose: load lookup table with an insert-only pattern since the
--           pk has the potential of changing.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
-- mapping match patterns and priorities

insert overwrite into
--
-- For all product development it should be 474000 with the exception of
-- IS development which is an addback so the Cost Center ID for them is 402100
-- once we start creating customer POC or demo environments the cost
-- center ID will either be 206500 or 131000 depending on whether
-- or not they are paid customer engagements

-- https://jda365.sharepoint.com/:x:/t/ITG/team-BI/eds/EYctzU9oQR1DivMk-ONKMVQB0-Qb9sFvYR-ZtOTzjcz0zw?e=coVEHa

    DEV_PLAT_GOV_RL_DB.account_usage.be_resource_mapping_lkp
with l_mapping as
(
    -- 0 exact match
    -- 1 team match (e.g., ent_prd_[^_]_team_.*)
    -- 2 general business entity match
    -- 5 match all to catch and categorize new patterns
    select to_char( null ) as match_pattern, to_number( null ) as priority_no, to_variant( null ) as tag_json


    --- LDE
    union all select '(dev|tst|prd|uat)_plan_lde_ui.*',     1, object_construct( 'product_group','Luminate Demand Edge', 'be','plan_lde','environment_type','dev','team', 'lde_ui','cost_center_id','474000', 'Customer', 'Unassigned' )
    union all select '(dev|tst|prd|uat)_plan_lde.*',        2, object_construct( 'product_group','Luminate Demand Edge', 'be','plan_lde','environment_type','dev','team', 'lde','cost_center_id','474000', 'Customer', 'Unassigned' )
    union all select 'plan_lde.*',                          2, object_construct( 'product_group','Luminate Demand Edge', 'be','plan_lde','environment_type','dev','team', 'lde','cost_center_id','474000', 'Customer', 'Unassigned' )
    union all select 'lde.*',                               2, object_construct( 'product_group','Luminate Demand Edge', 'be','plan_lde','environment_type','dev','team', 'lde','cost_center_id','474000', 'Customer', 'Unassigned' )
    union all select 'ml_medium_coreload',                  0, object_construct( 'product_group','Luminate Demand Edge', 'be','plan_lde','environment_type','dev','team', 'lde','cost_center_id','474000', 'Customer', 'Unassigned' )
    union all select 'jens',                                0, object_construct( 'product_group','Luminate Demand Edge', 'be','plan_lde','environment_type','dev','team', 'lde','cost_center_id','474000', 'Customer', 'Unassigned' )

    --- LPDM
    union all select '(dev|tst|prd|uat)_plat_lpdm.*',   1, object_construct( 'product_group','Luminate Platform', 'be','plat_lpdm','environment_type','dev','team','lpdm','cost_center_id','474000', 'Customer', 'Unassigned' )

    union all select 'platform_.*',                     1, object_construct( 'product_group','Luminate Platform', 'be','plat_lpdm','environment_type','dev','team','lpdm','cost_center_id','474000', 'Customer', 'Unassigned' )
    union all select 'plat_lpdm.*',                     1, object_construct( 'product_group','Luminate Platform', 'be','plat_lpdm','environment_type','dev','team','lpdm','cost_center_id','474000', 'Customer', 'Unassigned' )
    union all select 'compute_wh',                      0, object_construct( 'product_group','Luminate Platform', 'be','plat_lpdm','environment_type','dev','team','lpdm','cost_center_id','474000', 'Customer', 'Unassigned' )
    union all select 'temp_wh',                         0, object_construct( 'product_group','Luminate Platform', 'be','plat_lpdm','environment_type','dev','team','lpdm','cost_center_id','474000', 'Customer', 'Unassigned' )
    union all select 'psr_wh',                          0, object_construct( 'product_group','Luminate Platform', 'be','plat_lpdm','environment_type','dev','team','lpdm','cost_center_id','474000', 'Customer', 'Unassigned' )
    union all select 'cloud_services_only',             0, object_construct( 'product_group','Luminate Platform', 'be','plat_lpdm','environment_type','dev','team','lpdm','cost_center_id','474000', 'Customer', 'Unassigned' )

    --- WMS

     union all select '(dev|tst|prd|uat)_exec_wms.*',     1, object_construct( 'product_group','WMS', 'be','exec_wms','environment_type','dev','team','wms','cost_center_id','474000', 'Customer', 'Unassigned' )

    --- LCT
    union all select '(dev|tst|prd|uat)_plat_lct.*',     1, object_construct( 'product_group','Luminate Control Tower', 'be','plat_lct','environment_type','dev','team','lct','cost_center_id','474000', 'Customer', 'Unassigned' )
    union all select 'LCT_ANALYTICS_WH',                 0, object_construct( 'product_group','Luminate Control Tower', 'be','plat_lct','environment_type','dev','team','lct','cost_center_id','474000', 'Customer', 'Unassigned' )

    --- LVDS
    union all select '(dev|tst|prd|uat)_plat_lvds.*',     1, object_construct( 'product_group','Luminate Platform', 'be','plat_lvds','environment_type','dev','team','lvds','cost_center_id','474000', 'Customer', 'Unassigned' )

    --- LUI
    union all select '(dev|tst|prd|uat)_plat_lui.*',     1, object_construct( 'product_group','Luminate Platform', 'be','plat_lui','environment_type','dev','team','lui','cost_center_id','474000', 'Customer', 'Unassigned' )

    --- RETAIL
    union all select '(dev|tst|prd|uat)_plan_retail.*',     1, object_construct( 'product_group','Luminate Platform', 'be','plan_retail','environment_type','dev','team','retail','cost_center_id','474000', 'Customer', 'Unassigned' )


    
    --- IS / DMS

    union all select '(dev|tst|prd|uat)_is_dms.*',     1, object_construct( 'product_group', 'Data Management and Analytics', 'be','is_dms','environment_type','dev','team','dms','cost_center_id','402100' )



    --- Default Catch all
    union all select '.*',                           5, object_construct( 'product_group','?', 'be','?','environment_type','dev','team','?','cost_center_id','?', 'Customer', 'Unassigned' )
    --
)
select
     lm.match_pattern
    ,lm.priority_no
    ,lm.tag_json
    ,current_timestamp()    as dw_load_ts
from
    l_mapping lm
where
    lm.tag_json is not null
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      21 |
+-------------------------+
!source 200_raw/cb_service_type_lkp_ld.sql
--------------------------------------------------------------------
--  Purpose: load lookup table with an insert-only pattern since the 
--           pk has the potential of changing.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
--
-- update modified and insert new
--
merge into DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp t using
(
    with l_stg as
    (
        select
             sha1_binary( s.service_type_cd )   as dw_service_type_shk
            ,sha1_binary( concat( s.service_type_cd
                                 ,'|', s.service_type_name
                                 ,'|', s.service_type_group_name
                                 ,'|', to_char( s.active_dt, 'yyyymmdd' )
                                 ,'|', to_char( s.inactive_dt, 'yyyymmdd' )
                                )
                        )                       as dw_hash_diff
            ,current_timestamp()                as dw_update_ts
            --
            ,s.*
        from
            ( values
                   ( 'AUTOMATIC_CLUSTERING',      'Automatic Clustering',      'Service Metering',   '2021-05-01'::date, '2022-04-30'::date)
                  ,( 'MATERIALIZED_VIEW',         'Materialized View',         'Service Metering',   '2021-05-01'::date, '2022-04-30'::date)
                  ,( 'PIPE',                      'Snowpipe',                  'Service Metering',   '2021-05-01'::date, '2022-04-30'::date)
                  ,( 'REPLICATION_METERING',      'Replication Metering',      'Service Metering',   '2021-05-01'::date, '2022-04-30'::date)
                  ,( 'SEARCH_OPTIMIZATION',       'Search Optimization',       'Service Metering',   '2021-05-01'::date, '2022-04-30'::date)
                  ,( 'WAREHOUSE_METERING',        'Warehouse Metering',        'Warehouse Metering', '2021-05-01'::date, '2022-04-30'::date)
                  ,( 'WAREHOUSE_METERING_READER', 'Warehouse Metering Reader', 'Warehouse Metering', '2021-05-01'::date, '2022-04-30'::date)
                  --                                                                                                              
                  ,( 'STORAGE_DATABASE',          'Storage Database',          'Storage',            '2021-05-01'::date, '2022-04-30'::date)
                  ,( 'STORAGE_STAGE',             'Storage Internal Stage',    'Storage',            '2021-05-01'::date, '2022-04-30'::date)
                  --                                                                                                             
                  ,( 'DATA_TRANSFER',             'Data Transfer',             'Data Transfer',      '2021-05-01'::date, '2022-04-30'::date)
                  ,( 'REPLICATION_DATA_TRANSFER', 'Replication Data Transfer', 'Data Transfer',      '2021-05-01'::date, '2022-04-30'::date)
            ) s ( service_type_cd, service_type_name, service_type_group_name, active_dt, inactive_dt )
    )
    ,l_deduped as
    (
        select
            *
        from
            (
            select
                 -- identify dupes and only keep copy 1
                 -- note this is deduping on the primary key
                 row_number() over( partition by s.dw_service_type_shk order by s.active_dt desc ) as seq_no
                ,s.*
            from
                l_stg s
            )
        where
            seq_no = 1 -- keep only unique rows
    )
    select
         current_timestamp()        as dw_version_ts
        ,s.*
    from
        l_deduped s
        left join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp t on
            t.dw_service_type_shk = s.dw_service_type_shk
    where
        -- source row does not exist in target table
        t.dw_service_type_shk is null
        -- or source row is more recent and differs from target table
        or (
                t.dw_update_ts      < s.dw_update_ts
            and t.dw_hash_diff     != s.dw_hash_diff
           )
    order by
        s.active_dt
) s
on
(
    t.dw_service_type_shk = s.dw_service_type_shk
)
when matched then update set
     t.dw_hash_diff             = s.dw_hash_diff
    ,t.service_type_cd          = s.service_type_cd        
    ,t.service_type_name        = s.service_type_name      
    ,t.service_type_group_name  = s.service_type_group_name
    ,t.active_dt                = s.active_dt              
    ,t.inactive_dt              = s.inactive_dt
    --
    ,t.dw_update_ts             = current_timestamp()
when not matched then insert
(
     dw_service_type_shk
    ,dw_hash_diff
    ,service_type_cd        
    ,service_type_name      
    ,service_type_group_name
    ,active_dt              
    ,inactive_dt            
    ,dw_load_ts
    ,dw_update_ts
)
values
(
     s.dw_service_type_shk
    ,s.dw_hash_diff
    ,s.service_type_cd        
    ,s.service_type_name      
    ,s.service_type_group_name
    ,s.active_dt              
    ,s.inactive_dt            
    ,current_timestamp()
    ,current_timestamp()
)
;
+-------------------------+------------------------+
| number of rows inserted | number of rows updated |
|-------------------------+------------------------|
|                      11 |                      0 |
+-------------------------+------------------------+

!source 200_raw/sf_compute_cost_lkp_ld.sql
--------------------------------------------------------------------
--  Purpose: load lookup table with an insert-only pattern since the 
--           pk has the potential of changing.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
-- cost rows for each account and time period
insert overwrite into 
    DEV_PLAT_GOV_RL_DB.account_usage.sf_compute_cost_lkp
select
     cst.organization_name
	,cst.account_name
    ,cst.region_name
    ,cst.cost_amt
    ,cst.active_dt
    ,cst.inactive_dt
    --
    ,current_timestamp()        as dw_load_ts
from
    ( values
	
		 ( 'BY','OV40102',		'AZURE_EASTUS2', 	2.37, 	'2021-05-01', '2022-04-30')
		 ,( 'BY','KL23518', 	'AZURE_EASTUS2', 	3.16, 	'2021-05-01', '2022-04-30')
         ,( 'BY','GL26249',		'AZURE_WESTEUROPE', 3.95, 	'2021-05-01', '2022-04-30')
         ,( 'BY','OV40102', 		'AZURE_EASTUS2', 	0.00,	'2021-01-01', '2021-04-30')
		 ,( 'BY','KL23518', 	'AZURE_EASTUS2', 	0.00, 	'2021-01-01', '2021-04-30')
         ,( 'BY', 'GL26249',	'AZURE_WESTEUROPE', 0.00, 	'2021-01-01', '2021-04-30')
         --KL23518  ADMIN_PRD
		 --OV40102  US_DEV
         --GL26249  EUW_PRD
        
    ) cst( organization_name, account_name, region_name, cost_amt, active_dt, inactive_dt)
order by
    cst.active_dt
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       6 |
+-------------------------+

!source 200_raw/sf_data_xfer_cost_lkp_ld.sql
--------------------------------------------------------------------
--  Purpose: load lookup table with an insert-only pattern since the 
--           pk has the potential of changing.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
-- cost rows for each account and time period
insert overwrite into 
    DEV_PLAT_GOV_RL_DB.account_usage.sf_data_xfer_cost_lkp
select
     cst.organization_name
	,cst.account_name
    ,cst.region_name
    ,cst.cost_amt
    ,cst.active_dt
    ,cst.inactive_dt
    --
    ,current_timestamp()        as dw_load_ts
from
    ( values
        ( 'BY','OV40102',	'AZURE_EASTUS2', 	87.00, 	'2021-05-01', '2022-04-30')
		,( 'BY','KL23518', 'AZURE_EASTUS2', 	87.00, 	'2021-05-01', '2022-04-30')
        ,( 'BY','GL26249',	'AZURE_WESTEUROPE', 87.00, 	'2021-05-01', '2022-04-30')
        ,( 'BY','OV40102', 'AZURE_EASTUS2', 	0.00,	'2021-01-01', '2021-04-30')
		,( 'BY','KL23518', 'AZURE_EASTUS2', 	0.00, 	'2021-01-01', '2021-04-30')
        ,( 'BY', 'GL26249','AZURE_WESTEUROPE', 0.00, 	'2021-01-01', '2021-04-30')
         --KL23518  ADMIN_PRD
		 --OV40102  US_DEV
		 --GL26249  EUW_PRD
    ) cst( organization_name, account_name, region_name, cost_amt, active_dt, inactive_dt )
order by
    cst.active_dt
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       6 |
+-------------------------+

!source 200_raw/sf_storage_cost_lkp_ld.sql
--------------------------------------------------------------------
--  Purpose: load lookup table with an insert-only pattern since the 
--           pk has the potential of changing.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
-- cost rows for each account and time period
insert overwrite into 
    DEV_PLAT_GOV_RL_DB.account_usage.sf_storage_cost_lkp
select
     cst.organization_name
	 ,cst.account_name
    ,cst.region_name
    ,cst.cost_amt
    ,cst.active_dt
    ,cst.inactive_dt
    --
    ,current_timestamp()        as dw_load_ts
from
    ( values
        ( 'BY','OV40102',	'AZURE_EASTUS2', 	23.00, 	'2021-05-01', '2022-04-30')
		,( 'BY','KL23518', 'AZURE_EASTUS2', 	23.00, 	'2021-05-01', '2022-04-30')
        ,( 'BY','GL26249',	'AZURE_WESTEUROPE', 23.00, 	'2021-05-01', '2022-04-30')
        ,( 'BY','OV40102', 'AZURE_EASTUS2', 	0.00,	'2021-01-01', '2021-04-30')
		,( 'BY','KL23518', 'AZURE_EASTUS2', 	0.00, 	'2021-01-01', '2021-04-30')
        ,( 'BY', 'GL26249','AZURE_WESTEUROPE', 0.00, 	'2021-01-01', '2021-04-30')
         --KL23518  ADMIN_PRD
		 --OV40102  US_DEV
		 --GL26249  EUW_PRD
         
         --- Swis account needs to be added
         
    ) cst( organization_name, account_name, region_name, cost_amt, active_dt, inactive_dt )
order by
    cst.active_dt
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       6 |
+-------------------------+
!source 200_raw/be_budget_cost_lkp_ld.sql
--------------------------------------------------------------------
--  Purpose: load lookup table with an insert-only pattern since the 
--           pk has the potential of changing.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
-- mapping match patterns and priorities

truncate table DEV_PLAT_GOV_RL_DB.account_usage.be_budget_cost_lkp;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
insert overwrite into 
    DEV_PLAT_GOV_RL_DB.account_usage.be_budget_cost_lkp
with l_mapping as
(
    select to_char( null ) as be_name, to_date( null ) as month_begin_dt, to_number( null ) as compute_credit_cnt
    -- 
    union all select 'plan_lde', to_date('5/1/2021','mm/dd/yyyy'),  3426 
    union all select 'plan_lde', to_date('6/1/2021','mm/dd/yyyy'),  3426 
    union all select 'plan_lde', to_date('7/1/2021','mm/dd/yyyy'),  3953
    union all select 'plan_lde', to_date('8/1/2021','mm/dd/yyyy'),  4744 
    union all select 'plan_lde', to_date('9/1/2021','mm/dd/yyyy'),  5271
    union all select 'plan_lde', to_date('10/1/2021','mm/dd/yyyy'), 5534 
    union all select 'plan_lde', to_date('11/1/2021','mm/dd/yyyy'), 5534 
    union all select 'plan_lde', to_date('12/1/2021','mm/dd/yyyy'), 5798 
    union all select 'plan_lde', to_date('1/1/2022','mm/dd/yyyy'),  6061 
    union all select 'plan_lde', to_date('2/1/2022','mm/dd/yyyy'),  6325 
    union all select 'plan_lde', to_date('3/1/2022','mm/dd/yyyy'),  6589 
    union all select 'plan_lde', to_date('4/1/2022','mm/dd/yyyy'),  6589 
    --
    union all select 'exec_wms', to_date('5/1/2021','mm/dd/yyyy'),  1246 
    union all select 'exec_wms', to_date('6/1/2021','mm/dd/yyyy'),  1246 
    union all select 'exec_wms', to_date('7/1/2021','mm/dd/yyyy'),  1438 
    union all select 'exec_wms', to_date('8/1/2021','mm/dd/yyyy'),  1725 
    union all select 'exec_wms', to_date('9/1/2021','mm/dd/yyyy'),  1917 
    union all select 'exec_wms', to_date('10/1/2021','mm/dd/yyyy'), 2013 
    union all select 'exec_wms', to_date('11/1/2021','mm/dd/yyyy'), 2013 
    union all select 'exec_wms', to_date('12/1/2021','mm/dd/yyyy'), 2108 
    union all select 'exec_wms', to_date('1/1/2022','mm/dd/yyyy'),  2204 
    union all select 'exec_wms', to_date('2/1/2022','mm/dd/yyyy'),  2300 
    union all select 'exec_wms', to_date('3/1/2022','mm/dd/yyyy'),  2396 
    union all select 'exec_wms', to_date('4/1/2022','mm/dd/yyyy'),  2396 
    --
    union all select 'plat_lct', to_date('5/1/2021','mm/dd/yyyy'),  1557 
    union all select 'plat_lct', to_date('6/1/2021','mm/dd/yyyy'),  1557 
    union all select 'plat_lct', to_date('7/1/2021','mm/dd/yyyy'),  1797 
    union all select 'plat_lct', to_date('8/1/2021','mm/dd/yyyy'),  2156 
    union all select 'plat_lct', to_date('9/1/2021','mm/dd/yyyy'),  2396 
    union all select 'plat_lct', to_date('10/1/2021','mm/dd/yyyy'), 2516 
    union all select 'plat_lct', to_date('11/1/2021','mm/dd/yyyy'), 2516 
    union all select 'plat_lct', to_date('12/1/2021','mm/dd/yyyy'), 2635 
    union all select 'plat_lct', to_date('1/1/2022','mm/dd/yyyy'),  2755 
    union all select 'plat_lct', to_date('2/1/2022','mm/dd/yyyy'),  2875 
    union all select 'plat_lct', to_date('3/1/2022','mm/dd/yyyy'),  2995 
    union all select 'plat_lct', to_date('4/1/2022','mm/dd/yyyy'),  2995 
    --
    union all select 'plat_lvds', to_date('5/1/2021','mm/dd/yyyy'),  500 
    union all select 'plat_lvds', to_date('6/1/2021','mm/dd/yyyy'),  500 
    union all select 'plat_lvds', to_date('7/1/2021','mm/dd/yyyy'),  500 
    union all select 'plat_lvds', to_date('8/1/2021','mm/dd/yyyy'),  500 
    union all select 'plat_lvds', to_date('9/1/2021','mm/dd/yyyy'),  500 
    union all select 'plat_lvds', to_date('10/1/2021','mm/dd/yyyy'), 500 
    union all select 'plat_lvds', to_date('11/1/2021','mm/dd/yyyy'), 500 
    union all select 'plat_lvds', to_date('12/1/2021','mm/dd/yyyy'), 500 
    union all select 'plat_lvds', to_date('1/1/2022','mm/dd/yyyy'),  500 
    union all select 'plat_lvds', to_date('2/1/2022','mm/dd/yyyy'),  500 
    union all select 'plat_lvds', to_date('3/1/2022','mm/dd/yyyy'),  500 
    union all select 'plat_lvds', to_date('4/1/2022','mm/dd/yyyy'),  500 
    --
    union all select 'is_dms', to_date('5/1/2021','mm/dd/yyyy'),  1000 
    union all select 'is_dms', to_date('6/1/2021','mm/dd/yyyy'),  1000 
    union all select 'is_dms', to_date('7/1/2021','mm/dd/yyyy'),  1000 
    union all select 'is_dms', to_date('8/1/2021','mm/dd/yyyy'),  1000 
    union all select 'is_dms', to_date('9/1/2021','mm/dd/yyyy'),  1000 
    union all select 'is_dms', to_date('10/1/2021','mm/dd/yyyy'), 1000 
    union all select 'is_dms', to_date('11/1/2021','mm/dd/yyyy'), 1000 
    union all select 'is_dms', to_date('12/1/2021','mm/dd/yyyy'), 1000 
    union all select 'is_dms', to_date('1/1/2022','mm/dd/yyyy'),  1000 
    union all select 'is_dms', to_date('2/1/2022','mm/dd/yyyy'),  1000 
    union all select 'is_dms', to_date('3/1/2022','mm/dd/yyyy'),  1000 
    union all select 'is_dms', to_date('4/1/2022','mm/dd/yyyy'),  1000 
    --
    union all select 'plat_lui', to_date('5/1/2021','mm/dd/yyyy'),  0 
    union all select 'plat_lui', to_date('6/1/2021','mm/dd/yyyy'),  0 
    union all select 'plat_lui', to_date('7/1/2021','mm/dd/yyyy'),  500 
    union all select 'plat_lui', to_date('8/1/2021','mm/dd/yyyy'),  500 
    union all select 'plat_lui', to_date('9/1/2021','mm/dd/yyyy'),  500 
    union all select 'plat_lui', to_date('10/1/2021','mm/dd/yyyy'), 500 
    union all select 'plat_lui', to_date('11/1/2021','mm/dd/yyyy'), 500 
    union all select 'plat_lui', to_date('12/1/2021','mm/dd/yyyy'), 500 
    union all select 'plat_lui', to_date('1/1/2022','mm/dd/yyyy'),  500 
    union all select 'plat_lui', to_date('2/1/2022','mm/dd/yyyy'),  500 
    union all select 'plat_lui', to_date('3/1/2022','mm/dd/yyyy'),  500 
    union all select 'plat_lui', to_date('4/1/2022','mm/dd/yyyy'),  500 
    --
    
    union all select 'plan_retail', to_date('5/1/2021','mm/dd/yyyy'),  0 
    union all select 'plan_retail', to_date('6/1/2021','mm/dd/yyyy'),  0 
    union all select 'plan_retail', to_date('7/1/2021','mm/dd/yyyy'),  500 
    union all select 'plan_retail', to_date('8/1/2021','mm/dd/yyyy'),  500 
    union all select 'plan_retail', to_date('9/1/2021','mm/dd/yyyy'),  500 
    union all select 'plan_retail', to_date('10/1/2021','mm/dd/yyyy'), 500 
    union all select 'plan_retail', to_date('11/1/2021','mm/dd/yyyy'), 500 
    union all select 'plan_retail', to_date('12/1/2021','mm/dd/yyyy'), 500 
    union all select 'plan_retail', to_date('1/1/2022','mm/dd/yyyy'),  500 
    union all select 'plan_retail', to_date('2/1/2022','mm/dd/yyyy'),  500 
    union all select 'plan_retail', to_date('3/1/2022','mm/dd/yyyy'),  500 
    union all select 'plan_retail', to_date('4/1/2022','mm/dd/yyyy'),  500 
    --
)
select
     lm.be_name
    ,lm.month_begin_dt
    ,lm.compute_credit_cnt
    ,current_timestamp()    as dw_load_ts
from
    l_mapping lm
where
    lm.be_name is not null
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      84 |
+-------------------------+
-- load files from acquisition sources into stage tables
!print 200_raw Step 2
200_raw Step 2

!source 200_raw/automatic_clustering_history_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- start_time
        ,s.$5                                            -- end_time
        ,s.$6                                            -- credits_used
        ,s.$7                                            -- num_bytes_reclustered
        ,s.$8                                            -- num_rows_reclustered
        ,s.$9                                            -- table_id
        ,s.$10                                           -- table_name
        ,s.$11                                           -- schema_id
        ,s.$12                                           -- schema_name
        ,s.$13                                           -- database_id
        ,s.$14                                           -- database_name
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/automatic_clustering_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = true
;
+---------------------------------------+
| status                                |
|---------------------------------------|
| Copy executed with 0 files processed. |
+---------------------------------------+
!source 200_raw/data_transfer_history_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- start_time
        ,s.$5                                            -- end_time
        ,s.$6                                            -- source_cloud
        ,s.$7                                            -- source_region
        ,s.$8                                            -- target_cloud
        ,s.$9                                            -- target_region
        ,s.$10                                           -- bytes_transferred
        ,s.$11                                           -- transfer_type
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/data_transfer_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = true
;
+------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
| file                                                                                                       | status | rows_parsed | rows_loaded | error_limit | errors_seen | first_error | first_error_line | first_error_character | first_error_column_name |
|------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------|
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_3_0.csv.gz | LOADED |           2 |           2 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_0_0.csv.gz | LOADED |           1 |           1 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_1_0.csv.gz | LOADED |           2 |           2 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_0_0.csv.gz | LOADED |           2 |           2 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_0_3_0.csv.gz | LOADED |           3 |           3 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_2_0.csv.gz | LOADED |           1 |           1 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/data_transfer_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9886_1_1_0.csv.gz | LOADED |           2 |           2 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
+------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
!source 200_raw/database_storage_usage_history_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- usage_date
        ,s.$5                                            -- database_id
        ,s.$6                                            -- database_name
        ,s.$7                                            -- deleted
        ,s.$8                                            -- average_database_bytes
        ,s.$9                                            -- average_failsafe_bytes
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/database_storage_usage_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = true
;
+---------------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
| file                                                                                                                | status | rows_parsed | rows_loaded | error_limit | errors_seen | first_error | first_error_line | first_error_character | first_error_column_name |
|---------------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------|
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_6_0.csv.gz | LOADED |          83 |          83 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_0_0.csv.gz | LOADED |          70 |          70 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_7_0.csv.gz | LOADED |          81 |          81 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_2_0.csv.gz | LOADED |          83 |          83 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_5_0.csv.gz | LOADED |          93 |          93 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_4_0.csv.gz | LOADED |          70 |          70 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_3_0.csv.gz | LOADED |          85 |          85 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_4_0.csv.gz | LOADED |          98 |          98 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_0_0.csv.gz | LOADED |          82 |          82 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_1_0.csv.gz | LOADED |          86 |          86 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_6_0.csv.gz | LOADED |          66 |          66 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_1_0.csv.gz | LOADED |         101 |         101 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_7_0.csv.gz | LOADED |          88 |          88 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_3_0.csv.gz | LOADED |          90 |          90 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_1_5_0.csv.gz | LOADED |          69 |          69 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/database_storage_usage_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d9896_0_2_0.csv.gz | LOADED |          91 |          91 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
+---------------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
!source 200_raw/materialized_view_refresh_history_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- start_time
        ,s.$5                                            -- end_time
        ,s.$6                                            -- credits_used
        ,s.$7                                            -- table_id
        ,s.$8                                            -- table_name
        ,s.$9                                            -- schema_id
        ,s.$10                                           -- schema_name
        ,s.$11                                           -- database_id
        ,s.$12                                           -- database_name
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/materialized_view_refresh_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = true
;
+------------------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
| file                                                                                                                   | status | rows_parsed | rows_loaded | error_limit | errors_seen | first_error | first_error_line | first_error_character | first_error_column_name |
|------------------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------|
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_4_0.csv.gz | LOADED |           3 |           3 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/materialized_view_refresh_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d989e_1_2_0.csv.gz | LOADED |           2 |           2 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
+------------------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
!source 200_raw/metering_daily_history_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.metering_daily_history_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.metering_daily_history_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- service_type
        ,s.$5                                            -- usage_date
        ,s.$6                                            -- credits_used_compute
        ,s.$7                                            -- credits_used_cloud_services
        ,s.$8                                            -- credits_used
        ,s.$9                                            -- credits_adjustment_cloud_services
        ,s.$10                                           -- credits_billed
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/metering_daily_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = true
;
+-------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
| file                                                                                                        | status | rows_parsed | rows_loaded | error_limit | errors_seen | first_error | first_error_line | first_error_character | first_error_column_name |
|-------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------|
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_0_0.csv.gz | LOADED |           8 |           8 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_3_0.csv.gz | LOADED |          10 |          10 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_0_0.csv.gz | LOADED |           6 |           6 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_3_0.csv.gz | LOADED |           9 |           9 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_5_0.csv.gz | LOADED |          16 |          16 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_4_0.csv.gz | LOADED |           9 |           9 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_2_0.csv.gz | LOADED |           7 |           7 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_7_0.csv.gz | LOADED |           5 |           5 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_2_0.csv.gz | LOADED |           6 |           6 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_6_0.csv.gz | LOADED |           9 |           9 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_1_0.csv.gz | LOADED |          17 |          17 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_7_0.csv.gz | LOADED |           8 |           8 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_6_0.csv.gz | LOADED |          10 |          10 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_4_0.csv.gz | LOADED |           7 |           7 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_1_1_0.csv.gz | LOADED |           8 |           8 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/metering_daily_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc28e_0_5_0.csv.gz | LOADED |           6 |           6 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
+-------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
!source 200_raw/pipe_usage_history_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- start_time
        ,s.$5                                            -- end_time
        ,s.$6                                            -- credits_used
        ,s.$7                                            -- bytes_inserted
        ,s.$8                                            -- files_inserted
        ,s.$9                                            -- pipe_id
        ,s.$10                                           -- pipe_name
        ,s.$11                                           -- schema_name
        ,s.$12                                           -- database_name
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/pipe_usage_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = true
;
+---------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
| file                                                                                                    | status | rows_parsed | rows_loaded | error_limit | errors_seen | first_error | first_error_line | first_error_character | first_error_column_name |
|---------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------|
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_6_0.csv.gz | LOADED |          19 |          19 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/pipe_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db33a_1_4_0.csv.gz | LOADED |           2 |           2 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
+---------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
!source 200_raw/search_optimization_history_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- start_time
        ,s.$5                                            -- end_time
        ,s.$6                                            -- credits_used
        ,s.$7                                            -- table_id
        ,s.$8                                            -- table_name
        ,s.$9                                            -- schema_id
        ,s.$10                                           -- schema_name
        ,s.$11                                           -- database_id
        ,s.$12                                           -- database_name
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/search_optimization_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = true
;
+---------------------------------------+
| status                                |
|---------------------------------------|
| Copy executed with 0 files processed. |
+---------------------------------------+
!source 200_raw/query_history_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.query_history_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.query_history_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- query_id
        ,s.$5                                            -- query_text
        ,s.$6                                            -- database_id
        ,s.$7                                            -- database_name
        ,s.$8                                            -- schema_id
        ,s.$9                                            -- schema_name
        ,s.$10                                           -- query_type
        ,s.$11                                           -- session_id
        ,s.$12                                           -- user_name
        ,s.$13                                           -- role_name
        ,s.$14                                           -- warehouse_id
        ,s.$15                                           -- warehouse_name
        ,s.$16                                           -- warehouse_size
        ,s.$17                                           -- warehouse_type
        ,s.$18                                           -- cluster_number
        ,s.$19                                           -- query_tag
        ,s.$20                                           -- execution_status
        ,s.$21                                           -- error_code
        ,s.$22                                           -- error_message
        ,s.$23                                           -- start_time
        ,s.$24                                           -- end_time
        ,s.$25                                           -- total_elapsed_time
        ,s.$26                                           -- bytes_scanned
        ,s.$27                                           -- percentage_scanned_from_cache
        ,s.$28                                           -- bytes_written
        ,s.$29                                           -- bytes_written_to_result
        ,s.$30                                           -- bytes_read_from_result
        ,s.$31                                           -- rows_produced
        ,s.$32                                           -- rows_inserted
        ,s.$33                                           -- rows_updated
        ,s.$34                                           -- rows_deleted
        ,s.$35                                           -- rows_unloaded
        ,s.$36                                           -- bytes_deleted
        ,s.$37                                           -- partitions_scanned
        ,s.$38                                           -- partitions_total
        ,s.$39                                           -- bytes_spilled_to_local_storage
        ,s.$40                                           -- bytes_spilled_to_remote_storage
        ,s.$41                                           -- bytes_sent_over_the_network
        ,s.$42                                           -- compilation_time
        ,s.$43                                           -- execution_time
        ,s.$44                                           -- queued_provisioning_time
        ,s.$45                                           -- queued_repair_time
        ,s.$46                                           -- queued_overload_time
        ,s.$47                                           -- transaction_blocked_time
        ,s.$48                                           -- outbound_data_transfer_cloud
        ,s.$49                                           -- outbound_data_transfer_region
        ,s.$50                                           -- outbound_data_transfer_bytes
        ,s.$51                                           -- inbound_data_transfer_cloud
        ,s.$52                                           -- inbound_data_transfer_region
        ,s.$53                                           -- inbound_data_transfer_bytes
        ,s.$54                                           -- list_external_files_time
        ,s.$55                                           -- credits_used_cloud_services
        ,s.$56                                           -- release_version
        ,s.$57                                           -- external_function_total_invocations
        ,s.$58                                           -- external_function_total_sent_rows
        ,s.$59                                           -- external_function_total_received_rows
        ,s.$60                                           -- external_function_total_sent_bytes
        ,s.$61                                           -- external_function_total_received_bytes
        ,s.$62                                           -- query_load_percent
        ,to_boolean( s.$63 )                             -- is_client_generated_statement
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/query_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = true
;
+----------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
| file                                                                                               | status | rows_parsed | rows_loaded | error_limit | errors_seen | first_error | first_error_line | first_error_character | first_error_column_name |
|----------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------|
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_2_0.csv.gz | LOADED |         748 |         748 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_5_0.csv.gz | LOADED |        2220 |        2220 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_6_0.csv.gz | LOADED |        2145 |        2145 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_4_0.csv.gz | LOADED |          82 |          82 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_3_0.csv.gz | LOADED |        1728 |        1728 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_5_0.csv.gz | LOADED |        2384 |        2384 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_2_0.csv.gz | LOADED |        4406 |        4406 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_1_0.csv.gz | LOADED |        4007 |        4007 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_1_0.csv.gz | LOADED |        6259 |        6259 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_7_0.csv.gz | LOADED |        6492 |        6492 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_3_0.csv.gz | LOADED |       13763 |       13763 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_0_0.csv.gz | LOADED |           3 |           3 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_7_0.csv.gz | LOADED |        6916 |        6916 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_6_0.csv.gz | LOADED |       14419 |       14419 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_1_0_0.csv.gz | LOADED |       20469 |       20469 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/query_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc296_0_4_0.csv.gz | LOADED |       27643 |       27643 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
+----------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
!source 200_raw/replication_usage_history_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- start_time
        ,s.$5                                            -- end_time
        ,s.$6                                            -- database_id
        ,s.$7                                            -- database_name
        ,s.$8                                            -- credits_used
        ,s.$9                                            -- bytes_transferred
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/replication_usage_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = true
;
+---------------------------------------+
| status                                |
|---------------------------------------|
| Copy executed with 0 files processed. |
+---------------------------------------+
!source 200_raw/stage_storage_usage_history_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- usage_date
        ,s.$5                                            -- average_stage_bytes
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/stage_storage_usage_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = true
;
+------------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
| file                                                                                                             | status | rows_parsed | rows_loaded | error_limit | errors_seen | first_error | first_error_line | first_error_character | first_error_column_name |
|------------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------|
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_0_0.csv.gz | LOADED |          98 |          98 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/stage_storage_usage_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db342_0_1_0.csv.gz | LOADED |         121 |         121 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
+------------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
!source 200_raw/warehouse_load_history_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.warehouse_load_history_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.warehouse_load_history_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- start_time
        ,s.$5                                            -- end_time
        ,s.$6                                            -- warehouse_id
        ,s.$7                                            -- warehouse_name
        ,s.$8                                            -- avg_running
        ,s.$9                                            -- avg_queued_load
        ,s.$10                                           -- avg_queued_provisioning
        ,s.$11                                           -- avg_blocked
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/warehouse_load_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = true
;
+-------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
| file                                                                                                        | status | rows_parsed | rows_loaded | error_limit | errors_seen | first_error | first_error_line | first_error_character | first_error_column_name |
|-------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------|
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_3_0.csv.gz | LOADED |         149 |         149 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_6_0.csv.gz | LOADED |         269 |         269 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_4_0.csv.gz | LOADED |         172 |         172 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_5_0.csv.gz | LOADED |          56 |          56 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_2_0.csv.gz | LOADED |           2 |           2 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_1_0.csv.gz | LOADED |          31 |          31 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_0_0.csv.gz | LOADED |         137 |         137 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_0_0.csv.gz | LOADED |         328 |         328 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_1_0.csv.gz | LOADED |         915 |         915 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_7_0.csv.gz | LOADED |          17 |          17 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_4_0.csv.gz | LOADED |         166 |         166 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_1_2_0.csv.gz | LOADED |         193 |         193 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_6_0.csv.gz | LOADED |        2152 |        2152 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_load_history/apisero_dev/data_019f11b2-0500-b0ad-0027-cb83009d98b2_0_5_0.csv.gz | LOADED |         221 |         221 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
+-------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
!source 200_raw/warehouse_metering_history_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- start_time
        ,s.$5                                            -- end_time
        ,s.$6                                            -- warehouse_id
        ,s.$7                                            -- warehouse_name
        ,s.$8                                            -- credits_used
        ,s.$9                                            -- credits_used_compute
        ,s.$10                                           -- credits_used_cloud_services
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/warehouse_metering_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = TRUE
ON_ERROR = 'SKIP_FILE'
;
+-----------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
| file                                                                                                            | status | rows_parsed | rows_loaded | error_limit | errors_seen | first_error | first_error_line | first_error_character | first_error_column_name |
|-----------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------|
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_4_0.csv.gz | LOADED |          69 |          69 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_7_0.csv.gz | LOADED |          78 |          78 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_2_0.csv.gz | LOADED |          99 |          99 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_2_0.csv.gz | LOADED |         114 |         114 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_1_0.csv.gz | LOADED |          42 |          42 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_6_0.csv.gz | LOADED |          71 |          71 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_0_0.csv.gz | LOADED |          51 |          51 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_0_0.csv.gz | LOADED |          75 |          75 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_7_0.csv.gz | LOADED |          90 |          90 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_1_0.csv.gz | LOADED |          85 |          85 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_5_0.csv.gz | LOADED |          60 |          60 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_3_0.csv.gz | LOADED |          45 |          45 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_3_0.csv.gz | LOADED |         137 |         137 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_6_0.csv.gz | LOADED |         126 |         126 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_0_4_0.csv.gz | LOADED |          47 |          47 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0c0-0027-cb83009dc2aa_1_5_0.csv.gz | LOADED |         138 |         138 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
+-----------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
-- reader accounts
!source 200_raw/warehouse_metering_history_reader_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_reader_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_reader_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- reader_account_name
        ,s.$5                                            -- start_time
        ,s.$6                                            -- end_time
        ,s.$7                                            -- warehouse_id
        ,s.$8                                            -- warehouse_name
        ,s.$9                                            -- credits_used
        ,s.$10                                           -- credits_used_compute
        ,s.$11                                           -- credits_used_cloud_services
        ,s.$12                                           -- reader_account_deleted_on
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/reader_warehouse_metering_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = true
;
+------------------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
| file                                                                                                                   | status | rows_parsed | rows_loaded | error_limit | errors_seen | first_error | first_error_line | first_error_character | first_error_column_name |
|------------------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------|
| account_usage_stg/reader_warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0bb-0027-cb83009da4d2_1_1_0.csv.gz | LOADED |           1 |           1 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
| account_usage_stg/reader_warehouse_metering_history/apisero_dev/data_019f11b2-0500-b0bb-0027-cb83009da4d2_1_2_0.csv.gz | LOADED |           1 |           1 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
+------------------------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
!source 200_raw/query_history_reader_stg_ld.sql
--------------------------------------------------------------------
--  Purpose: load into stage table
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

truncate table DEV_PLAT_GOV_RL_DB.account_usage.query_history_reader_stg;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
copy into
    DEV_PLAT_GOV_RL_DB.account_usage.query_history_reader_stg
from
    (
    select
         s.$1                                            -- organization_name
        ,s.$2                                            -- account_name
        ,s.$3                                            -- region_name
        ,s.$4                                            -- reader_account_name
        ,s.$5                                            -- query_id
        ,s.$6                                            -- query_text
        ,s.$7                                            -- database_id
        ,s.$8                                            -- database_name
        ,s.$9                                            -- schema_id
        ,s.$10                                           -- schema_name
        ,s.$11                                           -- query_type
        ,s.$12                                           -- session_id
        ,s.$13                                           -- user_name
        ,s.$14                                           -- role_name
        ,s.$15                                           -- warehouse_id
        ,s.$16                                           -- warehouse_name
        ,s.$17                                           -- warehouse_size
        ,s.$18                                           -- warehouse_type
        ,s.$19                                           -- cluster_number
        ,s.$20                                           -- query_tag
        ,s.$21                                           -- execution_status
        ,s.$22                                           -- error_code
        ,s.$23                                           -- error_message
        ,s.$24                                           -- start_time
        ,s.$25                                           -- end_time
        ,s.$26                                           -- total_elapsed_time
        ,s.$27                                           -- bytes_scanned
        ,s.$28                                           -- rows_produced
        ,s.$29                                           -- compilation_time
        ,s.$30                                           -- execution_time
        ,s.$31                                           -- queued_provisioning_time
        ,s.$32                                           -- queued_repair_time
        ,s.$33                                           -- queued_overload_time
        ,s.$34                                           -- transaction_blocked_time
        ,s.$35                                           -- outbound_data_transfer_cloud
        ,s.$36                                           -- outbound_data_transfer_region
        ,s.$37                                           -- outbound_data_transfer_bytes
        ,s.$38                                           -- inbound_data_transfer_cloud
        ,s.$39                                           -- inbound_data_transfer_region
        ,s.$40                                           -- inbound_data_transfer_bytes
        ,s.$41                                           -- list_external_files_time
        ,s.$42                                           -- credits_used_cloud_services
        ,s.$43                                           -- reader_account_deleted_on
        ,metadata$filename                               -- dw_file_name
        ,metadata$file_row_number                        -- dw_file_row_no
        ,current_timestamp()                             -- dw_load_ts
    from
        @DEV_PLAT_GOV_COMMON_DB.UTIL.account_usage_stg/reader_query_history s
    )
file_format = ( type=csv field_optionally_enclosed_by = '"' )
purge = true
;
+-----------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
| file                                                                                                      | status | rows_parsed | rows_loaded | error_limit | errors_seen | first_error | first_error_line | first_error_character | first_error_column_name |
|-----------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------|
| account_usage_stg/reader_query_history/apisero_dev/data_019f11b2-0500-b0af-0027-cb83009db34a_1_2_0.csv.gz | LOADED |          97 |          97 |           1 |           0 | NULL        |             NULL |                  NULL | NULL                    |
+-----------------------------------------------------------------------------------------------------------+--------+-------------+-------------+-------------+-------------+-------------+------------------+-----------------------+-------------------------+
-- load distinct dates represented within staged data
!print 200_raw Step 3
200_raw Step 3

!source 200_raw/dw_delta_date_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------
insert overwrite into DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date
with l_delta_date as
(
    select distinct
        date_trunc( day, start_time )    as event_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_stg
    UNION
    select distinct
        date_trunc( day, start_time )    as event_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_reader_stg
    union
    select distinct
        date_trunc( day, usage_date )  as event_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history_stg
    union
    select distinct
        date_trunc( day, usage_date )  as event_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history_stg
    union
    select distinct
        date_trunc( day, start_time )    as event_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history_stg
    union
    select distinct
        date_trunc( day, start_time )    as event_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history_stg
    union
    select distinct
        date_trunc( day, start_time )    as event_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history_stg
    union
    select distinct
        date_trunc( day, start_time )    as event_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.query_history_stg
    union
    select distinct
        date_trunc( day, start_time )    as event_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history_stg
    union
    select distinct
        date_trunc( day, start_time )    as event_dt
    from
        DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history_stg
)
select
     event_dt
    ,current_timestamp()            as dw_load_ts
from
    l_delta_date
order by
    1
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                     219 |
+-------------------------+
-- load staged data into target tables, using delta dates to optimize partition pruning
!print 200_raw Step 4
200_raw Step 4

!source 200_raw/automatic_clustering_history_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history
with l_stg as
(
    select
        -- generate hash key to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', ifnull( s.database_name, '~' )
                            ,'|', ifnull( s.schema_name, '~' )
                            ,'|', ifnull( s.table_name, '~' )
                            ,'|', to_char( s.start_time, 'yyyy-mmm-dd hh24:mi:ss.FF3 TZHTZM'  )
                           )
                    )               as dw_automatic_clustering_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_automatic_clustering_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_automatic_clustering_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.start_time
    ,s.end_time
    ,s.credits_used
    ,s.num_bytes_reclustered
    ,s.num_rows_reclustered
    ,s.table_id
    ,s.table_name
    ,s.schema_id
    ,s.schema_name
    ,s.database_id
    ,s.database_name
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_automatic_clustering_history_shk not in
    (
        select dw_automatic_clustering_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history where start_time >= $l_start_dt and start_time < $l_end_dt
    )
order by
    start_time  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       0 |
+-------------------------+
!source 200_raw/data_transfer_history_ld.sql
--------------------------------------------------------------------
--  Purpose: insert new and modified values into history table
--      This shows and insert-only pattern where every version of a
--      received row is kept.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history
with l_stg as
(
    select
        -- generate hash key and hash diff to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', to_char( s.start_time, 'yyyy-mmm-dd hh24:mi:ss.FF3 TZHTZM'  )
                            ,'|', ifnull( s.source_region, '?' )
                            ,'|', ifnull( s.target_region, '?' )
                            ,'|', s.transfer_type
                           )
                    )               as dw_data_transfer_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_data_transfer_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_data_transfer_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.start_time
    ,s.end_time
    ,s.source_cloud
    ,s.source_region
    ,s.target_cloud
    ,s.target_region
    ,s.bytes_transferred
    ,s.transfer_type
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_data_transfer_history_shk not in
    (
        select dw_data_transfer_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history where start_time >= $l_start_dt and start_time < $l_end_dt
    )
order by
    start_time  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      13 |
+-------------------------+
!source 200_raw/database_storage_usage_history_ld.sql
--------------------------------------------------------------------
--  Purpose: insert new and modified values into history table
--      This shows and insert-only pattern where every version of a
--      received row is kept.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history
with l_stg as
(
    select
        -- generate hash key and hash diff to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', to_char( s.database_name )
                            ,'|', to_char( s.usage_date, 'yyyy-mmm-dd'  )
                           )
                    )               as dw_database_storage_usage_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_database_storage_usage_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_database_storage_usage_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.usage_date
    ,s.database_id
    ,s.database_name
    ,s.deleted
    ,s.average_database_bytes
    ,s.average_failsafe_bytes
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_database_storage_usage_history_shk not in
    (
        select dw_database_storage_usage_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history where usage_date >= $l_start_dt and usage_date < $l_end_dt
    )
order by
    usage_date  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                    1336 |
+-------------------------+
!source 200_raw/materialized_view_refresh_history_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history
with l_stg as
(
    select
        -- generate hash key to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', ifnull( s.database_name, '~' )
                            ,'|', ifnull( s.schema_name, '~' )
                            ,'|', ifnull( s.table_name, '~' )
                            ,'|', to_char( s.start_time, 'yyyy-mmm-dd hh24:mi:ss.FF3 TZHTZM'  )
                          )
                    )               as dw_materialized_view_refresh_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_materialized_view_refresh_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_materialized_view_refresh_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.start_time
    ,s.end_time
    ,s.credits_used
    ,s.table_id
    ,s.table_name
    ,s.schema_id
    ,s.schema_name
    ,s.database_id
    ,s.database_name
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_materialized_view_refresh_history_shk not in
    (
        select dw_materialized_view_refresh_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history where start_time >= $l_start_dt and start_time < $l_end_dt
    )
order by
    start_time  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       5 |
+-------------------------+
!source 200_raw/metering_daily_history_ld.sql
--------------------------------------------------------------------
--  Purpose: insert new and modified values into history table
--      This shows and insert-only pattern where every version of a
--      received row is kept.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.metering_daily_history
with l_stg as
(
    select
        -- generate hash key and hash diff to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', s.service_type
                            ,'|', to_char( s.usage_date, 'yyyy-mmm-dd hh24:mi:ss.FF3 TZHTZM'  )
                           )
                    )               as dw_metering_daily_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.metering_daily_history_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_metering_daily_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_metering_daily_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.service_type
    ,s.usage_date
    ,s.credits_used_compute
    ,s.credits_used_cloud_services
    ,s.credits_used
    ,s.credits_adjustment_cloud_services
    ,s.credits_billed
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_metering_daily_history_shk not in
    (
        select dw_metering_daily_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.metering_daily_history where usage_date >= $l_start_dt and usage_date < $l_end_dt
    )
order by
    usage_date  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                     141 |
+-------------------------+
!source 200_raw/pipe_usage_history_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history
with l_stg as
(
    select
        -- generate hash key to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', ifnull( s.database_name, '~' )
                            ,'|', ifnull( s.schema_name, '~' )
                            ,'|', ifnull( s.pipe_name, '~' )
                            ,'|', to_char( s.start_time, 'yyyy-mmm-dd hh24:mi:ss.FF3 TZHTZM'  )
                           )
                    )               as dw_pipe_usage_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_pipe_usage_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_pipe_usage_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.start_time
    ,s.end_time
    ,s.credits_used
    ,s.bytes_inserted
    ,s.files_inserted
    ,s.pipe_id
    ,s.pipe_name
    ,s.schema_name
    ,s.database_name
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_pipe_usage_history_shk not in
    (
        select dw_pipe_usage_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history where start_time >= $l_start_dt and start_time < $l_end_dt
    )
order by
    start_time  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      21 |
+-------------------------+
!source 200_raw/query_history_ld.sql
--------------------------------------------------------------------
--  Purpose: insert new and modified values into history table
--      This shows and insert-only pattern where every version of a
--      received row is kept.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.query_history
with l_stg as
(
    select
        -- generate hash key and hash diff to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', s.query_id
                           )
                    )               as dw_query_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.query_history_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_query_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_query_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.query_id
    ,s.query_text
    ,s.database_id
    ,s.database_name
    ,s.schema_id
    ,s.schema_name
    ,s.query_type
    ,s.session_id
    ,s.user_name
    ,s.role_name
    ,s.warehouse_id
    ,s.warehouse_name
    ,s.warehouse_size
    ,s.warehouse_type
    ,s.cluster_number
    ,s.query_tag
    ,s.execution_status
    ,s.error_code
    ,s.error_message
    ,s.start_time
    ,s.end_time
    ,s.total_elapsed_time
    ,s.bytes_scanned
    ,s.percentage_scanned_from_cache
    ,s.bytes_written
    ,s.bytes_written_to_result
    ,s.bytes_read_from_result
    ,s.rows_produced
    ,s.rows_inserted
    ,s.rows_updated
    ,s.rows_deleted
    ,s.rows_unloaded
    ,s.bytes_deleted
    ,s.partitions_scanned
    ,s.partitions_total
    ,s.bytes_spilled_to_local_storage
    ,s.bytes_spilled_to_remote_storage
    ,s.bytes_sent_over_the_network
    ,s.compilation_time
    ,s.execution_time
    ,s.queued_provisioning_time
    ,s.queued_repair_time
    ,s.queued_overload_time
    ,s.transaction_blocked_time
    ,s.outbound_data_transfer_cloud
    ,s.outbound_data_transfer_region
    ,s.outbound_data_transfer_bytes
    ,s.inbound_data_transfer_cloud
    ,s.inbound_data_transfer_region
    ,s.inbound_data_transfer_bytes
    ,s.list_external_files_time
    ,s.credits_used_cloud_services
    ,s.release_version
    ,s.external_function_total_invocations
    ,s.external_function_total_sent_rows
    ,s.external_function_total_received_rows
    ,s.external_function_total_sent_bytes
    ,s.external_function_total_received_bytes
    ,s.query_load_percent
    ,s.is_client_generated_statement
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_query_history_shk not in
    (
        select dw_query_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.query_history where start_time >= $l_start_dt and start_time < $l_end_dt
    )
order by
    start_time  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                  113684 |
+-------------------------+
!source 200_raw/replication_usage_history_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history
with l_stg as
(
    select
        -- generate hash key to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', ifnull( s.database_name, '~' )
                            ,'|', to_char( s.start_time, 'yyyy-mmm-dd hh24:mi:ss.FF3 TZHTZM'  )
                           )
                    )               as dw_replication_usage_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_replication_usage_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_replication_usage_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.start_time
    ,s.end_time
    ,s.database_id
    ,s.database_name
    ,s.credits_used
    ,s.bytes_transferred
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_replication_usage_history_shk not in
    (
        select dw_replication_usage_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history where start_time >= $l_start_dt and start_time < $l_end_dt
    )
order by
    start_time  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       0 |
+-------------------------+
!source 200_raw/search_optimization_history_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history
with l_stg as
(
    select
        -- generate hash key to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', ifnull( s.database_name, '~' )
                            ,'|', ifnull( s.schema_name, '~' )
                            ,'|', ifnull( s.table_name, '~' )
                            ,'|', to_char( s.start_time, 'yyyy-mmm-dd hh24:mi:ss.FF3 TZHTZM'  )
                           )
                    )               as dw_search_optimization_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_search_optimization_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_search_optimization_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.start_time
    ,s.end_time
    ,s.credits_used
    ,s.table_id
    ,s.table_name
    ,s.schema_id
    ,s.schema_name
    ,s.database_id
    ,s.database_name
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_search_optimization_history_shk not in
    (
        select dw_search_optimization_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history where start_time >= $l_start_dt and start_time < $l_end_dt
    )
order by
    start_time  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       0 |
+-------------------------+
!source 200_raw/stage_storage_usage_history_ld.sql
--------------------------------------------------------------------
--  Purpose: insert new and modified values into history table
--      This shows and insert-only pattern where every version of a
--      received row is kept.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history
with l_stg as
(
    select
        -- generate hash key and hash diff to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', to_char( s.usage_date, 'yyyy-mmm-dd'  )
                           )
                    )               as dw_stage_storage_usage_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_stage_storage_usage_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_stage_storage_usage_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.usage_date
    ,s.average_stage_bytes
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_stage_storage_usage_history_shk not in
    (
        select dw_stage_storage_usage_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history where usage_date >= $l_start_dt and usage_date < $l_end_dt
    )
order by
    usage_date  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                     219 |
+-------------------------+
!source 200_raw/warehouse_load_history_ld.sql
--------------------------------------------------------------------
--  Purpose: insert new and modified values into history table
--      This shows and insert-only pattern where every version of a
--      received row is kept.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.warehouse_load_history
with l_stg as
(
    select
        -- generate hash key and hash diff to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', s.warehouse_name
                            ,'|', to_char( s.start_time, 'yyyy-mmm-dd hh24:mi:ss.FF3 TZHTZM'  )
                           )
                    )               as dw_warehouse_load_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.warehouse_load_history_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_warehouse_load_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_warehouse_load_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.start_time
    ,s.end_time
    ,s.warehouse_id
    ,s.warehouse_name
    ,s.avg_running
    ,s.avg_queued_load
    ,s.avg_queued_provisioning
    ,s.avg_blocked
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_warehouse_load_history_shk not in
    (
        select dw_warehouse_load_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.warehouse_load_history where start_time >= $l_start_dt and start_time < $l_end_dt
    )
order by
    start_time  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                    4799 |
+-------------------------+
!source 200_raw/warehouse_metering_history_ld.sql
--------------------------------------------------------------------
--  Purpose: insert new and modified values into history table
--      This shows and insert-only pattern where every version of a
--      received row is kept.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history
with l_stg as
(
    select
        -- generate hash key and hash diff to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', s.warehouse_name
                            ,'|', to_char( s.start_time, 'yyyy-mmm-dd hh24:mi:ss.FF3 TZHTZM'  )
                           )
                    )               as dw_warehouse_metering_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_warehouse_metering_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_warehouse_metering_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.start_time
    ,s.end_time
    ,s.warehouse_id
    ,s.warehouse_name
    ,s.credits_used
    ,s.credits_used_compute
    ,s.credits_used_cloud_services
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_warehouse_metering_history_shk not in
    (
        select dw_warehouse_metering_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history where start_time >= $l_start_dt and start_time < $l_end_dt
    )
order by
    start_time  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                    1302 |
+-------------------------+
-- Reader accounts
!source 200_raw/warehouse_metering_history_reader_ld.sql
--------------------------------------------------------------------
--  Purpose: insert new and modified values into history table
--      This shows and insert-only pattern where every version of a
--      received row is kept.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_reader
with l_stg as
(
    select
        -- generate hash key and hash diff to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', s.reader_account_name
                            ,'|', s.warehouse_name
                            ,'|', to_char( s.start_time, 'yyyy-mmm-dd hh24:mi:ss.FF3 TZHTZM'  )
                           )
                    )               as dw_warehouse_metering_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_reader_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_warehouse_metering_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_warehouse_metering_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.reader_account_name
    ,s.start_time
    ,s.end_time
    ,s.warehouse_id
    ,s.warehouse_name
    ,s.credits_used
    ,s.credits_used_compute
    ,s.credits_used_cloud_services
    ,s.reader_account_deleted_on
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_warehouse_metering_history_shk not in
    (
        select dw_warehouse_metering_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_reader where start_time >= $l_start_dt and start_time < $l_end_dt
    )
order by
    start_time  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       2 |
+-------------------------+
!source 200_raw/query_history_reader_ld.sql
--------------------------------------------------------------------
--  Purpose: insert new and modified values into history table
--      This shows and insert-only pattern where every version of a
--      received row is kept.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_RL_DB.account_usage.query_history_reader
with l_stg as
(
    select
        -- generate hash key and hash diff to streamline processing
        sha1_binary( concat( s.organization_name
                            ,'|', s.region_name
                            ,'|', s.account_name
                            ,'|', s.reader_account_name
                            ,'|', s.query_id
                           )
                    )               as dw_query_history_shk
        ,s.*
    from
        DEV_PLAT_GOV_RL_DB.account_usage.query_history_reader_stg s
)
,l_deduped as
(
    select
        *
    from
        (
        select
             -- identify dupes and only keep copy 1
             row_number() over( partition by dw_query_history_shk order by 1 ) as seq_no
            ,s.*
        from
            l_stg s
        )
    where
        seq_no = 1 -- keep only unique rows
)
select
     s.dw_query_history_shk
    ,s.organization_name
    ,s.account_name
    ,s.region_name
    ,s.reader_account_name
    ,s.query_id
    ,s.query_text
    ,s.database_id
    ,s.database_name
    ,s.schema_id
    ,s.schema_name
    ,s.query_type
    ,s.session_id
    ,s.user_name
    ,s.role_name
    ,s.warehouse_id
    ,s.warehouse_name
    ,s.warehouse_size
    ,s.warehouse_type
    ,s.cluster_number
    ,s.query_tag
    ,s.execution_status
    ,s.error_code
    ,s.error_message
    ,s.start_time
    ,s.end_time
    ,s.total_elapsed_time
    ,s.bytes_scanned
    ,s.rows_produced
    ,s.compilation_time
    ,s.execution_time
    ,s.queued_provisioning_time
    ,s.queued_repair_time
    ,s.queued_overload_time
    ,s.transaction_blocked_time
    ,s.outbound_data_transfer_cloud
    ,s.outbound_data_transfer_region
    ,s.outbound_data_transfer_bytes
    ,s.inbound_data_transfer_cloud
    ,s.inbound_data_transfer_region
    ,s.inbound_data_transfer_bytes
    ,s.list_external_files_time
    ,s.credits_used_cloud_services
    ,s.reader_account_deleted_on
    ,s.dw_file_name
    ,s.dw_file_row_no
    ,current_timestamp()    as dw_load_ts
from
    l_deduped s
where
    s.dw_query_history_shk not in
    (
        select dw_query_history_shk from DEV_PLAT_GOV_RL_DB.account_usage.query_history_reader where start_time >= $l_start_dt and start_time < $l_end_dt
    )
order by
    start_time  -- physically sort rows by a logical partitioning date
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      97 |
+-------------------------+

!print SUCCESS!
SUCCESS!
!source 000_admin/account_ld_300_integration_orch.sql
------------------------------------------------------------------------------
-- 300_integration
--
!print 300_integration
300_integration
-- maintain distinct set of source accounts and source resources (warehouses and databases)
-- used by derivation, dimension and fact table load scripts
!print 300_integration Step 1
300_integration Step 1

!source 300_integration/cb_account_h_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h
with l_account as
(
    select distinct
         wmh.organization_name
        ,wmh.region_name
        ,wmh.account_name
        ,'~'                AS reader_account_name
    from
        DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history wmh
    where
        -- wmh
            wmh.start_time        >= $l_start_dt
        and wmh.start_time         < $l_end_dt
    UNION
    select distinct
         wmh.organization_name
        ,wmh.region_name
        ,wmh.account_name
        ,wmh.reader_account_name 
    from
        DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_reader wmh
    where
        -- wmh
            wmh.start_time        >= $l_start_dt
        and wmh.start_time         < $l_end_dt
    union
    select distinct
         dsuh.organization_name
        ,dsuh.region_name
        ,dsuh.account_name
        ,'~'                AS reader_account_name
    from
        DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history dsuh
    where
        -- dsuh
            dsuh.usage_date     >= $l_start_dt
        and dsuh.usage_date      < $l_end_dt
    union
    select distinct
         ssuh.organization_name
        ,ssuh.region_name
        ,ssuh.account_name
        ,'~'                AS reader_account_name
    from
        DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history ssuh
    where
        -- ssuh
            ssuh.usage_date     >= $l_start_dt
        and ssuh.usage_date      < $l_end_dt
    union
    select distinct
         ach.organization_name
        ,ach.region_name
        ,ach.account_name
        ,'~'                AS reader_account_name
    from
        DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history ach
    where
        -- ach
            ach.start_time        >= $l_start_dt
        and ach.start_time         < $l_end_dt
    union
    select distinct
         mvrh.organization_name
        ,mvrh.region_name
        ,mvrh.account_name
        ,'~'                AS reader_account_name
    from
        DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history mvrh
    where
        -- mvrh
            mvrh.start_time        >= $l_start_dt
        and mvrh.start_time         < $l_end_dt
    union
    select distinct
         puh.organization_name
        ,puh.region_name
        ,puh.account_name
        ,'~'                AS reader_account_name
    from
        DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history puh
    where
        -- puh
            puh.start_time        >= $l_start_dt
        and puh.start_time         < $l_end_dt
    union
    select distinct
         soh.organization_name
        ,soh.region_name
        ,soh.account_name
        ,'~'                AS reader_account_name
    from
        DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history soh
    where
        -- soh
            soh.start_time        >= $l_start_dt
        and soh.start_time         < $l_end_dt
    union
    select distinct
         mvrh.organization_name
        ,mvrh.region_name
        ,mvrh.account_name
        ,'~'                AS reader_account_name
    from
        DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history mvrh
    where
        -- ach
            mvrh.start_time        >= $l_start_dt
        and mvrh.start_time         < $l_end_dt
    union
    select distinct
         dth.organization_name
        ,dth.region_name
        ,dth.account_name
        ,'~'                AS reader_account_name
    from
        DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history dth
    where
        -- dth
            dth.start_time        >= $l_start_dt
        and dth.start_time         < $l_end_dt
)
,l_account_shk as
(
    select
        -- generate hash key
         sha1_binary( concat( la.organization_name
                             ,'|', la.region_name
                             ,'|', la.account_name
                             ,'|', la.reader_account_name
                            )
                    )                   as dw_account_shk
        --
        ,la.organization_name
        ,la.region_name
        ,la.account_name
        ,la.reader_account_name
    from
        l_account la
)
select
     las.dw_account_shk
    --
    ,las.organization_name
    ,las.region_name
    ,las.account_name
    ,las.reader_account_name
    --
    ,current_timestamp()            as dw_load_ts
    ,current_timestamp()            as dw_update_ts
from
    l_account_shk las
where
    las.dw_account_shk not in
    (
        select dw_account_shk from DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h
    )
order by
    2,3,4
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       2 |
+-------------------------+
!source 300_integration/cb_resource_h_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h
with l_resource as
(
    select distinct
         wmh.organization_name
        ,wmh.region_name
        ,wmh.account_name
        ,'~'                        as reader_account_name
        ,wmh.warehouse_name         as resource_name
        ,'warehouse'                as resource_type_cd
    from
        DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history wmh
    where
        -- wmh
            wmh.start_time        >= $l_start_dt
        and wmh.start_time         < $l_end_dt
    UNION
    select distinct
         wmh.organization_name
        ,wmh.region_name
        ,wmh.account_name           as account_name
        ,wmh.reader_account_name    as reader_account_name
        ,wmh.warehouse_name         as resource_name
        ,'warehouse'                as resource_type_cd
    from
        DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_reader wmh
    where
        -- wmh
            wmh.start_time        >= $l_start_dt
        and wmh.start_time         < $l_end_dt
    union
    select distinct
         dsuh.organization_name
        ,dsuh.region_name
        ,dsuh.account_name
        ,'~'                        as reader_account_name
        ,dsuh.database_name         as resource_name
        ,'database'                 as resource_type_cd
    from
        DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history dsuh
    where
        -- dsuh
            dsuh.usage_date     >= $l_start_dt
        and dsuh.usage_date      < $l_end_dt
    union
    select distinct
         ssuh.organization_name
        ,ssuh.region_name
        ,ssuh.account_name
        ,'~'                        as reader_account_name
        ,'INTERNAL STAGE'           as resource_name
        ,'internal_stage'           as resource_type_cd
    from
        DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history ssuh
    where
        -- ssuh
            ssuh.usage_date     >= $l_start_dt
        and ssuh.usage_date      < $l_end_dt
    union
    select distinct
         ach.organization_name
        ,ach.region_name
        ,ach.account_name
        ,'~'                        as reader_account_name
        ,ach.database_name          as resource_name
        ,'database'                 as resource_type_cd
    from
        DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history ach
    where
        -- ach
            ach.start_time        >= $l_start_dt
        and ach.start_time         < $l_end_dt
    union
    select distinct
         mvrh.organization_name
        ,mvrh.region_name
        ,mvrh.account_name
        ,'~'                        as reader_account_name
        ,mvrh.database_name         as resource_name
        ,'database'                 as resource_type_cd
    from
        DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history mvrh
    where
        -- mvrh
            mvrh.start_time        >= $l_start_dt
        and mvrh.start_time         < $l_end_dt
    union
    select distinct
         puh.organization_name
        ,puh.region_name
        ,puh.account_name
        ,'~'                        as reader_account_name
        ,puh.database_name          as resource_name
        ,'database'                 as resource_type_cd
    from
        DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history puh
    where
        -- puh
            puh.start_time        >= $l_start_dt
        and puh.start_time         < $l_end_dt
    union
    select distinct
         soh.organization_name
        ,soh.region_name
        ,soh.account_name
        ,'~'                        as reader_account_name
        ,soh.database_name          as resource_name
        ,'database'                 as resource_type_cd
    from
        DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history soh
    where
        -- soh
            soh.start_time        >= $l_start_dt
        and soh.start_time         < $l_end_dt
    union
    select distinct
         mvrh.organization_name
        ,mvrh.region_name
        ,mvrh.account_name
        ,'~'                        as reader_account_name
        ,mvrh.database_name         as resource_name
        ,'database'                 as resource_type_cd
    FROM 
        DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history mvrh
    where
        -- mvrh
            mvrh.start_time        >= $l_start_dt
        and mvrh.start_time         < $l_end_dt
    union
    select distinct
         dth.organization_name
        ,dth.region_name
        ,dth.account_name
        ,'~'                        as reader_account_name
        ,concat( ifnull( dth.target_cloud, '?' ), '.', ifnull( dth.target_region, '?' ) )   as resource_name
        ,'cloudregion'                                                                      as resource_type_cd
    from
        DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history dth
    where
        -- dth
            dth.start_time        >= $l_start_dt
        and dth.start_time         < $l_end_dt
)
,l_resource_shk as
(
    select
        -- generate hash key
         sha1_binary( concat( lr.organization_name
                             ,'|', lr.region_name
                             ,'|', lr.account_name
                             ,'|', lr.reader_account_name
                             ,'|', lr.resource_name
                             ,'|', lr.resource_type_cd
                            )
                    )                   as dw_resource_shk
        --
        ,lr.organization_name
        ,lr.region_name
        ,lr.account_name
        ,lr.reader_account_name
        ,lr.resource_name
        ,lr.resource_type_cd
    from
        l_resource lr
)
select
     lrs.dw_resource_shk
    --
    ,lrs.organization_name
    ,lrs.region_name
    ,lrs.account_name
    ,lrs.reader_account_name
    ,lrs.resource_name
    ,lrs.resource_type_cd
    --
    ,current_timestamp()            as dw_load_ts
    ,current_timestamp()            as dw_update_ts
from
    l_resource_shk lrs
where
    lrs.dw_resource_shk not in
    (
        select dw_resource_shk from DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h
    )
order by
    2,3,4,5
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      41 |
+-------------------------+
!source 300_integration/cb_be_h_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta date range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_be_h
with l_be as
(
    select
        distinct brml.tag_json:be::string        as be_name
    from
        DEV_PLAT_GOV_RL_DB.account_usage.be_resource_mapping_lkp brml 
)
,l_be_shk as
(
    select
        -- generate hash key
         sha1_binary( concat( lr.be_name ) )                   as dw_be_shk
        --
        ,lr.be_name
    from
        l_be lr
)
select
     -- generate hash key
     sha1_binary( concat( lrs.be_name ) )   as dw_be_shk
    --
    ,lrs.be_name
    --
    ,current_timestamp()            as dw_load_ts
    ,current_timestamp()            as dw_update_ts
from
    l_be_shk lrs
where
    lrs.dw_be_shk not in
    (
        select dw_be_shk from DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_be_h
    )
order by
    2
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       9 |
+-------------------------+
-- maintain relationships between source accounts and source resources.
-- used by derivation, dimension and fact table load scripts
!print 300_integration Step 2
300_integration Step 2

!source 300_integration/cb_account_resource_l_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- load delta
--
insert into
    DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_resource_l
select
     cah.dw_account_shk
    ,crh.dw_resource_shk
    ,current_timestamp()            as dw_load_ts
    ,current_timestamp()            as dw_update_ts
from
     DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h crh
     join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
             cah.organization_name   = crh.organization_name
         and cah.region_name         = crh.region_name
         and cah.account_name        = crh.account_name
         AND cah.reader_account_name = crh.reader_account_name
where
    (cah.dw_account_shk, crh.dw_resource_shk) not in
    (
        select dw_account_shk, dw_resource_shk from DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_resource_l
    )
order by
    1,2
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      41 |
+-------------------------+

!print SUCCESS!
SUCCESS!
!source 000_admin/account_ld_310_derivation_orch.sql
------------------------------------------------------------------------------
-- 310_derivation
--
!print 310_derivation
310_derivation
-- map source resources to business entities and assign cost numbers to each resource
!print 310_derivation Step 1
310_derivation Step 1

!source 310_derivation/be_resource_mapping_s_ld.sql
--------------------------------------------------------------------
--  Purpose: load lookup table with an insert-only pattern since the
--           pk has the potential of changing.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- full load
--
-- mapping match patterns and priorities can change which will and
-- should remove old mapping that may have been incorrect, therefore
-- this needs to be a full load each time.
--
insert overwrite into
    DEV_PLAT_GOV_IL_DB.USAGE_METRIC.be_resource_mapping_s
with l_mapping as
(
    select
        row_number() over( partition by crh.dw_resource_shk order by brml.priority_no ) as seq_no
       ,crh.dw_resource_shk
       ,brml.tag_json:be::string        as be_name
       ,brml.priority_no
       ,brml.match_pattern
       ,brml.tag_json
    from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h crh
        join DEV_PLAT_GOV_RL_DB.account_usage.be_resource_mapping_lkp brml on
            regexp_like( crh.resource_name, brml.match_pattern, 'i' )
)
select
     lm.dw_resource_shk
    ,lm.be_name
    ,lm.tag_json
    --
    ,lm.priority_no
    ,lm.match_pattern
    --
    ,current_timestamp()        as dw_load_ts
from
    l_mapping lm
where
    lm.seq_no = 1 -- highest priority match
order by
    2,1
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      41 |
+-------------------------+
!source 310_derivation/sf_compute_cost_s_ld.sql
--------------------------------------------------------------------
--  Purpose: load lookup table with an insert-only pattern since the 
--           pk has the potential of changing.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- full load
--
-- mappings can change which will and 
-- should remove old mappings that may have been incorrect, therefore
-- this needs to be a full load each time.
--
insert overwrite into 
    DEV_PLAT_GOV_IL_DB.USAGE_METRIC.sf_compute_cost_s
select
     cah.dw_account_shk
    ,cst.active_dt
    --
    ,cst.cost_amt
    ,cst.inactive_dt
    --
    ,current_timestamp()        as dw_load_ts
from
    DEV_PLAT_GOV_RL_DB.account_usage.sf_compute_cost_lkp cst
    join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
        cah.organization_name = cst.organization_name
		and cah.account_name  = cst.account_name
        and cah.region_name   = cst.region_name
order by
    2, 1
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       0 |
+-------------------------+
!source 310_derivation/sf_data_xfer_cost_s_ld.sql
--------------------------------------------------------------------
--  Purpose: load lookup table with an insert-only pattern since the 
--           pk has the potential of changing.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- full load
--
-- mappings can change which will and 
-- should remove old mappings that may have been incorrect, therefore
-- this needs to be a full load each time.
--
insert overwrite into 
    DEV_PLAT_GOV_IL_DB.USAGE_METRIC.sf_data_xfer_cost_s
select
     cah.dw_account_shk
    ,cst.active_dt
    --
    ,cst.cost_amt
    ,cst.inactive_dt
    --
    ,current_timestamp()        as dw_load_ts
from
    DEV_PLAT_GOV_RL_DB.account_usage.sf_data_xfer_cost_lkp cst
    join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
        cah.organization_name = cst.organization_name
		and cah.account_name  = cst.account_name
        AND cah.region_name   = cst.region_name
order by
    2,1
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       0 |
+-------------------------+
!source 310_derivation/sf_storage_cost_s_ld.sql
--------------------------------------------------------------------
--  Purpose: load lookup table with an insert-only pattern since the 
--           pk has the potential of changing.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- full load
--
-- mappings can change which will and 
-- should remove old mappings that may have been incorrect, therefore
-- this needs to be a full load each time.
--
insert overwrite into 
    DEV_PLAT_GOV_IL_DB.USAGE_METRIC.sf_storage_cost_s
select
     cah.dw_account_shk
    ,cst.active_dt
    --
    ,cst.cost_amt
    ,cst.inactive_dt
    --
    ,current_timestamp()        as dw_load_ts
from
    DEV_PLAT_GOV_RL_DB.account_usage.sf_storage_cost_lkp cst
    join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
        cah.organization_name = cst.organization_name
		and cah.account_name  = cst.account_name
        AND cah.region_name   = cst.region_name
order by
    2,1
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       0 |
+-------------------------+
!source 310_derivation/be_budget_cost_s_ld.sql
--------------------------------------------------------------------
--  Purpose: load lookup table with an insert-only pattern since the
--           pk has the potential of changing.
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- full load
--
-- mappings can change which will and 
-- should remove old mappings that may have been incorrect, therefore
-- this needs to be a full load each time.
--
insert overwrite into 
    DEV_PLAT_GOV_IL_DB.USAGE_METRIC.be_budget_cost_s
select
     cah.dw_be_shk
    ,cst.be_name
    ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( month, cst.month_begin_dt ) )    as dw_event_date_sid
    ,cst.month_begin_dt
    --
    ,cst.compute_credit_cnt
    ,current_timestamp()        as dw_load_ts
from
    DEV_PLAT_GOV_RL_DB.account_usage.be_budget_cost_lkp cst
    join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_be_h cah on
        cah.be_name = cst.be_name
order by
    2, 1
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      84 |
+-------------------------+
-- monthly aggregation of consumption by resource
!print 310_derivation Step 2
310_derivation Step 2

!source 310_derivation/cb_job_credits_s_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- delete insert pattern
--
-- using a delete/insert pattern because all atomic records must be
-- reprocessed within a given period to ensure allocation is correct
--

--------------------------------------------------------------------
-- pull staged delta as day boundary range
--
set (l_start_dt, l_end_dt ) = (select start_dt, dateadd( day, 1, end_dt ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- pull max number of hour periods that some jobs will need to be expanded across for hourly cost allocation
set l_hour_cnt = (
                 SELECT max( hour_no ) + 1 AS hour_cnt
                 FROM
                     (
		                 select
		                     datediff( hour, date_trunc( hour, qh.start_time ), qh.end_time ) as hour_no
		                 from
		                     DEV_PLAT_GOV_RL_DB.account_usage.query_history qh
		                 where
		                         qh.start_time >= $l_start_dt
		                     and qh.start_time  < $l_end_dt
		                 UNION 
		                 select
		                     datediff( hour, date_trunc( hour, qh.start_time ), qh.end_time ) as hour_no
		                 from
		                     DEV_PLAT_GOV_RL_DB.account_usage.query_history_reader qh
		                 where
		                         qh.start_time >= $l_start_dt
		                     and qh.start_time  < $l_end_dt
		             )
                 )
;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- wrap delete and insert within a transaction so a failure with the insert doesn't leave the table without data for the delta range
begin;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
    -- delete periods within the delta range
    --
    delete from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_job_credits_s
    where
            start_time >= $l_start_dt
        and start_time  < $l_end_dt
    ;
+------------------------+
| number of rows deleted |
|------------------------|
|                      0 |
+------------------------+
--------------------------------------------------------------------
    -- load delta
    --
    insert into
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_job_credits_s
    with l_hour as
    (
        -- generate hour rows
        select
            row_number() over( order by seq4() )  as seq_no
        from
            table( generator( rowcount => $l_hour_cnt ) ) 
    )
    ,l_period as
    (
        -- generate period rows with corresponding hour rows
        -- for example: hour_cnt 1 has rows 1; hour_cnt 2 has rows 1,2; hour_cnt 3 has rows 1,2,3; etc.
        -- these will be used to split jobs that ran for muliple hours across those periods
        select
             a.seq_no as hour_cnt
            ,b.seq_no as hour_seq_no
        from
            l_hour a
            cross join l_hour b
        where
            b.seq_no <= a.seq_no
    )
    ,l_job as
    (
        select
             qh.dw_query_history_shk
            ,qh.organization_name
            ,qh.region_name
            ,qh.account_name
            ,'~'                     as reader_account_name
            ,qh.warehouse_name
            ,qh.query_id
            ,qh.start_time
            ,qh.end_time
            -- 
            -- derivations
            --   move start time to after queueing completion
            --   set period start and end hour times
            --   derive hours spanned from period start and end
            --
            ,case
                when qh.warehouse_size is not null
                then 1
                else 0
             end                                                        as credits_consumed_bt
            ,dateadd( ms, qh.queued_provisioning_time + qh.queued_repair_time + qh.queued_overload_time, qh.start_time )    as adj_job_start_ts
            ,date_trunc( hour, adj_job_start_ts )                       as job_period_start_ts
            ,dateadd( hour, 1, date_trunc( hour, qh.end_time ) )        as job_period_end_ts
            ,datediff( hour, job_period_start_ts, job_period_end_ts )   as job_hour_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.query_history qh
        where
            -- qh
                qh.start_time >= $l_start_dt
            and qh.start_time  < $l_end_dt
        --
        UNION ALL
        -- 
        -- reader account query history
        --
        select
             qh.dw_query_history_shk
            ,qh.organization_name
            ,qh.region_name
            ,qh.account_name
            ,qh.reader_account_name
            ,qh.warehouse_name
            ,qh.query_id
            ,qh.start_time
            ,qh.end_time
            -- 
            -- derivations
            --   move start time to after queueing completion
            --   set period start and end hour times
            --   derive hours spanned from period start and end
            --
            ,case
                when qh.warehouse_size is not null
                then 1
                else 0
             end                                                        as credits_consumed_bt
            ,dateadd( ms, qh.queued_provisioning_time + qh.queued_repair_time + qh.queued_overload_time, qh.start_time )    as adj_job_start_ts
            ,date_trunc( hour, adj_job_start_ts )                       as job_period_start_ts
            ,dateadd( hour, 1, date_trunc( hour, qh.end_time ) )        as job_period_end_ts
            ,datediff( hour, job_period_start_ts, job_period_end_ts )   as job_hour_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.query_history_reader qh
        where
            -- qh
                qh.start_time >= $l_start_dt
            and qh.start_time  < $l_end_dt
    )
    ,l_job_period as
    (
        -- split query history rows across the hour periods that they span and calc percent of execution time within the hour for each job
        select
             lj.*
            ,lp.*
            -- derive period duration
            ,dateadd( hour, lp.hour_seq_no - 1, lj.job_period_start_ts ) as period_start_ts
            ,dateadd( hour, lp.hour_seq_no,     lj.job_period_start_ts ) as period_end_ts
            ,case
                when lp.hour_seq_no = 1
                then datediff( ms, lj.adj_job_start_ts, least( lj.end_time, period_end_ts ) )
                when lp.hour_seq_no < lp.hour_cnt
                then datediff( ms, period_start_ts, period_end_ts )
                when lp.hour_seq_no = lp.hour_cnt
                then datediff( ms, period_start_ts, lj.end_time )
                else -1
             end                        as period_duration
            -- adjust to zero if execution did not consume credits on the warehouse
            ,period_duration * lj.credits_consumed_bt   as adj_period_duration
            --
            ,ratio_to_report( to_number( adj_period_duration, 38, 10 ) ) over( partition by lj.organization_name, lj.region_name, lj.account_name, lj.warehouse_name, period_start_ts ) as period_duration_pct
        from
            l_job lj
            join l_period lp on
                lp.hour_cnt = lj.job_hour_cnt
    )
    ,l_job_cost as
    (
        -- allocate warehouse credits across jobs that spanned a given hour period based on percent of execution time
        select
             ljp.*
            ,nvl( lwm.credits_used_compute, 0 )                         as credits_used_compute
            ,nvl( credits_used_compute * ljp.period_duration_pct, 0 )   as job_credits_used_compute
        from
            l_job_period ljp
            left join DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history lwm on
                    lwm.organization_name   = ljp.organization_name
                and lwm.region_name         = ljp.region_name
                and lwm.account_name        = ljp.account_name
                and lwm.warehouse_name      = ljp.warehouse_name
                and lwm.start_time          = ljp.period_start_ts
        where
            (
                lwm.start_time >= $l_start_dt
            and lwm.start_time  < $l_end_dt
            )
            -- bring in all query history rows
            or lwm.warehouse_name is NULL
        --
        UNION all
        --
        -- reader account warehouse metering
        --
        select
             ljp.*
            ,nvl( lwm.credits_used_compute, 0 )                         as credits_used_compute
            ,nvl( credits_used_compute * ljp.period_duration_pct, 0 )   as job_credits_used_compute
        from
            l_job_period ljp
            left join DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_reader lwm on
                    lwm.organization_name   = ljp.organization_name
                and lwm.region_name         = ljp.region_name
                and lwm.account_name        = ljp.account_name
                AND lwm.reader_account_name = ljp.reader_account_name
                and lwm.warehouse_name      = ljp.warehouse_name
                and lwm.start_time          = ljp.period_start_ts
        where
            (
                lwm.start_time >= $l_start_dt
            and lwm.start_time  < $l_end_dt
            )
            -- bring in all query history rows
            or lwm.warehouse_name is null
    )
    select
         ljp.dw_query_history_shk
        ,ljp.start_time 
        ,ljp.hour_seq_no
        --
        ,ljp.organization_name
        ,ljp.account_name
        ,ljp.reader_account_name
        ,ljp.region_name
        ,ljp.warehouse_name
        ,ljp.job_credits_used_compute
        --
        ,ljp.job_hour_cnt
        ,ljp.credits_used_compute
        ,ljp.period_duration_pct
        ,ljp.period_duration
        ,ljp.adj_period_duration
        ,ljp.credits_consumed_bt
        ,ljp.job_period_start_ts
        ,ljp.period_start_ts 
        ,ljp.period_end_ts
        ,ljp.adj_job_start_ts
        --
        ,current_timestamp()        as dw_load_ts
    from
        l_job_cost ljp
    where
        not exists
        (
            select 1 from DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_job_credits_s where start_time >= $l_start_dt and start_time < $l_end_dt
        )
    order by
        ljp.start_time
    ;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                  227590 |
+-------------------------+
commit;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- monthly aggregation of consumption by resource
!print 310_derivation Step 3
310_derivation Step 3

!source 310_derivation/cb_resource_consumption_ms_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- delete insert pattern
--
-- the delta date range could theoretically ca--use change where a given
-- combination of pk values no longer exist, therefore the months
-- represented by the delta need to be reaggregated in their entirety
--

--------------------------------------------------------------------
-- pull staged delta as a month boundary range
--
set (l_start_dt, l_end_dt ) = (select date_trunc( month, start_dt ), date_trunc( month, dateadd( month, 1, end_dt ) ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- wrap delete and insert within a transaction so a failure with the insert doesn't leave the table without data for the delta range
begin;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
    -- delete periods within the delta range
    --
    delete from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_consumption_ms
    where
            event_month_dt >= $l_start_dt
        and event_month_dt  < $l_end_dt
    ;
+------------------------+
| number of rows deleted |
|------------------------|
|                      0 |
+------------------------+
--------------------------------------------------------------------
    -- load delta
    --
    insert into
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_consumption_ms
    with l_resource_consumption as
    (
        --
        -- warehouse metering
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( month, wmh.start_time ) )    as dw_event_date_sid
            ,date_trunc( month, wmh.start_time )                  as event_month_dt
            --
            ,sum( wmh.credits_used )                            as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history wmh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = wmh.organization_name
                and csh.account_name        = wmh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = wmh.region_name
                and csh.resource_name       = wmh.warehouse_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = wmh.organization_name
                and cah.account_name        = wmh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = wmh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- wmh
                wmh.start_time        >= $l_start_dt
            and wmh.start_time         < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'warehouse'
            -- cstl
            and cstl.service_type_cd = 'WAREHOUSE_METERING'
        group by
            1,2,3,4,5
        union all
        --
        -- reader account warehouse metering
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( month, wmh.start_time ) )    as dw_event_date_sid
            ,date_trunc( month, wmh.start_time )                  as event_month_dt
            --
            ,sum( wmh.credits_used )                            as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_reader wmh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = wmh.organization_name
                and csh.account_name        = wmh.account_name
                and csh.reader_account_name = wmh.reader_account_name
                and csh.region_name         = wmh.region_name
                and csh.resource_name       = wmh.warehouse_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = wmh.organization_name
                and cah.account_name        = wmh.account_name
                and cah.reader_account_name = wmh.reader_account_name
                and cah.region_name         = wmh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- wmh
                wmh.start_time        >= $l_start_dt
            and wmh.start_time         < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'warehouse'
            -- cstl
            and cstl.service_type_cd = 'WAREHOUSE_METERING_READER'
        group by
            1,2,3,4,5
        union all
        --
        -- automatic clustering
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( month, ach.start_time ) )    as dw_event_date_sid
            ,date_trunc( month, ach.start_time )                  as event_month_dt
            --
            ,sum( ach.credits_used )                            as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history ach
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = ach.organization_name
                and csh.account_name        = ach.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = ach.region_name
                and csh.resource_name       = ach.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = ach.organization_name
                and cah.account_name        = ach.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = ach.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- ach
                ach.start_time        >= $l_start_dt
            and ach.start_time         < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'AUTOMATIC_CLUSTERING'
        group by
            1,2,3,4,5
        union all
        --
        -- materialized view refresh
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( month, mvrh.start_time ) )    as dw_event_date_sid
            ,date_trunc( month, mvrh.start_time )               as event_month_dt
            --
            ,sum( mvrh.credits_used )                           as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history mvrh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = mvrh.organization_name
                and csh.account_name        = mvrh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = mvrh.region_name
                and csh.resource_name       = mvrh.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = mvrh.organization_name
                and cah.account_name        = mvrh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = mvrh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- mvrh
                mvrh.start_time     >= $l_start_dt
            and mvrh.start_time      < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'MATERIALIZED_VIEW'
        group by
            1,2,3,4,5
        union all
        --
        -- pipe usage
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( month, puh.start_time ) )    as dw_event_date_sid
            ,date_trunc( month, puh.start_time )                as event_month_dt
            --
            ,sum( puh.credits_used )                            as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history puh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = puh.organization_name
                and csh.account_name        = puh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = puh.region_name
                and csh.resource_name       = puh.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = puh.organization_name
                and cah.account_name        = puh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = puh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- puh
                puh.start_time     >= $l_start_dt
            and puh.start_time      < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'PIPE'
        group by
            1,2,3,4,5
        union all
        --
        -- search optimization
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( month, soh.start_time ) )    as dw_event_date_sid
            ,date_trunc( month, soh.start_time )                as event_month_dt
            --
            ,sum( soh.credits_used )                            as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history soh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = soh.organization_name
                and csh.account_name        = soh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = soh.region_name
                and csh.resource_name       = soh.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = soh.organization_name
                and cah.account_name        = soh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = soh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- soh
                soh.start_time      >= $l_start_dt
            and soh.start_time       < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'SEARCH_OPTIMIZATION'
        group by
            1,2,3,4,5
        union all
        --
        -- replication usage history credits used
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( month, ruh.start_time ) )    as dw_event_date_sid
            ,date_trunc( month, ruh.start_time )                as event_month_dt
            --
            ,sum( ruh.credits_used )                            as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history ruh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = ruh.organization_name
                and csh.account_name        = ruh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = ruh.region_name
                and csh.resource_name       = ruh.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = ruh.organization_name
                and cah.account_name        = ruh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = ruh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- ruh
                ruh.start_time      >= $l_start_dt
            and ruh.start_time       < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'REPLICATION_METERING'
        group by
            1,2,3,4,5
        union all
        --
        -- replication usage history bytes transferred
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( month, ruh.start_time ) )    as dw_event_date_sid
            ,date_trunc( month, ruh.start_time )                as event_month_dt
            --
            ,0                                                  as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,sum( ruh.bytes_transferred )                       as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history ruh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = ruh.organization_name
                and csh.account_name        = ruh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = ruh.region_name
                and csh.resource_name       = ruh.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = ruh.organization_name
                and cah.account_name        = ruh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = ruh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- ruh
                ruh.start_time      >= $l_start_dt
            and ruh.start_time       < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'REPLICATION_DATA_TRANSFER'
        group by
            1,2,3,4,5
        union all
        --
        -- database storage
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( month, dsuh.usage_date ) )     as dw_event_date_sid
            ,date_trunc( month, dsuh.usage_date )                   as event_month_dt
            --
            ,0                                                      as compute_credit_cnt
            ,avg(  dsuh.average_database_bytes
                 + dsuh.average_failsafe_bytes )                    as storage_byte_cnt
            ,0                                                      as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history dsuh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = dsuh.organization_name
                and csh.account_name        = dsuh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = dsuh.region_name
                and csh.resource_name       = dsuh.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = dsuh.organization_name
                and cah.account_name        = dsuh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = dsuh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- dsuh
                dsuh.usage_date     >= $l_start_dt
            and dsuh.usage_date      < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'STORAGE_DATABASE'
        group by
            1,2,3,4,5
        union all
        --
        -- stage storage
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( month, ssuh.usage_date ) )     as dw_event_date_sid
            ,date_trunc( month, ssuh.usage_date )                   as event_month_dt
            --
            ,0                                                      as compute_credit_cnt
            ,avg(  ssuh.average_stage_bytes )                       as storage_byte_cnt
            ,0                                                      as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history ssuh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = ssuh.organization_name
                and csh.account_name        = ssuh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = ssuh.region_name
                and csh.resource_name       = 'INTERNAL STAGE'
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = ssuh.organization_name
                and cah.account_name        = ssuh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = ssuh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- ssuh
                ssuh.usage_date     >= $l_start_dt
            and ssuh.usage_date      < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'internal_stage'
            -- cstl
            and cstl.service_type_cd = 'STORAGE_STAGE'
        group by
            1,2,3,4,5
        union all
        --
        -- data transfer
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( month, dth.start_time ) )        as dw_event_date_sid
            ,date_trunc( month, dth.start_time )                      as event_month_dt
            --
            ,0                                                      as compute_credit_cnt
            ,0                                                      as storage_byte_cnt
            ,sum( dth.bytes_transferred )                           as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history dth
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = dth.organization_name
                and csh.account_name        = dth.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = dth.region_name
                and csh.resource_name       = concat( ifnull( dth.target_cloud, '?' ), '.', ifnull( dth.target_region, '?' ) )
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = dth.organization_name
                and cah.account_name        = dth.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = dth.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- dth
                dth.start_time        >= $l_start_dt
            and dth.start_time         < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'cloudregion'
            -- cstl
            and cstl.service_type_cd = 'DATA_TRANSFER'
        group by
            1,2,3,4,5
    )
    select
         lrc.dw_account_shk
        ,lrc.dw_resource_shk
        ,lrc.dw_service_type_shk
        ,lrc.dw_event_date_sid
        ,lrc.event_month_dt
        --
        ,lrc.compute_credit_cnt
        ,lrc.compute_credit_cnt * DEV_PLAT_GOV_COMMON_DB.UTIL.sf_compute_cost_f( lrc.dw_account_shk, lrc.event_month_dt )
                                                                as compute_cost_amt
        ,lrc.storage_byte_cnt
        ,lrc.storage_byte_cnt / pow( 1024, 4 )                  as storage_tb_cnt
        ,(lrc.storage_byte_cnt / pow( 1024, 4 )) * DEV_PLAT_GOV_COMMON_DB.UTIL.sf_storage_cost_f( lrc.dw_account_shk, lrc.event_month_dt )
                                                                as storage_cost_amt
        ,lrc.data_xfer_byte_cnt
        ,lrc.data_xfer_byte_cnt / pow( 1024, 4 )                as data_xfer_tb_cnt
        ,(lrc.data_xfer_byte_cnt / pow( 1024, 4 )) * DEV_PLAT_GOV_COMMON_DB.UTIL.sf_data_xfer_cost_f( lrc.dw_account_shk, lrc.event_month_dt )
                                                                as data_xfer_cost_amt
        ,compute_cost_amt
         + storage_cost_amt
         + data_xfer_cost_amt                                   as total_cost_amt
        --
        ,current_timestamp()                                    as dw_load_ts
    from
        l_resource_consumption lrc
    where
        not exists
        (
            select 1 from DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_consumption_ms where event_month_dt >= $l_start_dt and event_month_dt < $l_end_dt
        )
    order by
        3
    ;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                     120 |
+-------------------------+
commit;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
!source 310_derivation/cb_resource_consumption_ds_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- delete insert pattern
--
-- the delta date range could theoretically ca--use change where a given
-- combination of pk values no longer exist, therefore the months
-- represented by the delta need to be reaggregated in their entirety
--

--------------------------------------------------------------------
-- pull staged delta as a month boundary range
--
set (l_start_dt, l_end_dt ) = (select start_dt, end_dt from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- wrap delete and insert within a transaction so a failure with the insert doesn't leave the table without data for the delta range
begin;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
    -- delete periods within the delta range
    --
    delete from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_consumption_ds
    where
            event_dt >= $l_start_dt
        and event_dt  < $l_end_dt
    ;
+------------------------+
| number of rows deleted |
|------------------------|
|                      0 |
+------------------------+
--------------------------------------------------------------------
    -- load delta
    --
    insert into
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_consumption_ds
    with l_resource_consumption as
    (
        --
        -- warehouse metering
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( day, wmh.start_time ) )    as dw_event_date_sid
            ,date_trunc( day, wmh.start_time )                  as event_dt
            --
            ,sum( wmh.credits_used )                            as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history wmh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = wmh.organization_name
                and csh.account_name        = wmh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = wmh.region_name
                and csh.resource_name       = wmh.warehouse_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = wmh.organization_name
                and cah.account_name        = wmh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = wmh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- wmh
                wmh.start_time        >= $l_start_dt
            and wmh.start_time         < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'warehouse'
            -- cstl
            and cstl.service_type_cd = 'WAREHOUSE_METERING'
        group by
            1,2,3,4,5
        union all
        --
        -- reader account warehouse metering
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( day, wmh.start_time ) )    as dw_event_date_sid
            ,date_trunc( day, wmh.start_time )                  as event_dt
            --
            ,sum( wmh.credits_used )                            as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.warehouse_metering_history_reader wmh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = wmh.organization_name
                and csh.account_name        = wmh.account_name
                and csh.reader_account_name = wmh.reader_account_name
                and csh.region_name         = wmh.region_name
                and csh.resource_name       = wmh.warehouse_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = wmh.organization_name
                and cah.account_name        = wmh.account_name
                and cah.reader_account_name = wmh.reader_account_name
                and cah.region_name         = wmh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- wmh
                wmh.start_time        >= $l_start_dt
            and wmh.start_time         < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'warehouse'
            -- cstl
            and cstl.service_type_cd = 'WAREHOUSE_METERING_READER'
        group by
            1,2,3,4,5
        union all
        --
        -- automatic clustering
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( day, ach.start_time ) )    as dw_event_date_sid
            ,date_trunc( day, ach.start_time )                  as event_dt
            --
            ,sum( ach.credits_used )                            as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.automatic_clustering_history ach
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = ach.organization_name
                and csh.account_name        = ach.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = ach.region_name
                and csh.resource_name       = ach.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = ach.organization_name
                and cah.account_name        = ach.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = ach.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- ach
                ach.start_time        >= $l_start_dt
            and ach.start_time         < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'AUTOMATIC_CLUSTERING'
        group by
            1,2,3,4,5
        union all
        --
        -- materialized view refresh
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( day, mvrh.start_time ) )    as dw_event_date_sid
            ,date_trunc( day, mvrh.start_time )               as event_dt
            --
            ,sum( mvrh.credits_used )                           as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.materialized_view_refresh_history mvrh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = mvrh.organization_name
                and csh.account_name        = mvrh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = mvrh.region_name
                and csh.resource_name       = mvrh.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = mvrh.organization_name
                and cah.account_name        = mvrh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = mvrh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- mvrh
                mvrh.start_time     >= $l_start_dt
            and mvrh.start_time      < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'MATERIALIZED_VIEW'
        group by
            1,2,3,4,5
        union all
        --
        -- pipe usage
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( day, puh.start_time ) )    as dw_event_date_sid
            ,date_trunc( day, puh.start_time )                as event_dt
            --
            ,sum( puh.credits_used )                            as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.pipe_usage_history puh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = puh.organization_name
                and csh.account_name        = puh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = puh.region_name
                and csh.resource_name       = puh.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = puh.organization_name
                and cah.account_name        = puh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = puh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- puh
                puh.start_time     >= $l_start_dt
            and puh.start_time      < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'PIPE'
        group by
            1,2,3,4,5
        union all
        --
        -- search optimization
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( day, soh.start_time ) )    as dw_event_date_sid
            ,date_trunc( day, soh.start_time )                as event_dt
            --
            ,sum( soh.credits_used )                            as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.search_optimization_history soh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = soh.organization_name
                and csh.account_name        = soh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = soh.region_name
                and csh.resource_name       = soh.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = soh.organization_name
                and cah.account_name        = soh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = soh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- soh
                soh.start_time      >= $l_start_dt
            and soh.start_time       < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'SEARCH_OPTIMIZATION'
        group by
            1,2,3,4,5
        union all
        --
        -- replication usage history credits used
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( day, ruh.start_time ) )    as dw_event_date_sid
            ,date_trunc( day, ruh.start_time )                as event_dt
            --
            ,sum( ruh.credits_used )                            as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,0                                                  as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history ruh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = ruh.organization_name
                and csh.account_name        = ruh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = ruh.region_name
                and csh.resource_name       = ruh.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = ruh.organization_name
                and cah.account_name        = ruh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = ruh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- ruh
                ruh.start_time      >= $l_start_dt
            and ruh.start_time       < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'REPLICATION_METERING'
        group by
            1,2,3,4,5
        union all
        --
        -- replication usage history bytes transferred
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( day, ruh.start_time ) )    as dw_event_date_sid
            ,date_trunc( day, ruh.start_time )                as event_dt
            --
            ,0                                                  as compute_credit_cnt
            ,0                                                  as storage_byte_cnt
            ,sum( ruh.bytes_transferred )                       as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.replication_usage_history ruh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = ruh.organization_name
                and csh.account_name        = ruh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = ruh.region_name
                and csh.resource_name       = ruh.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = ruh.organization_name
                and cah.account_name        = ruh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = ruh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- ruh
                ruh.start_time      >= $l_start_dt
            and ruh.start_time       < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'REPLICATION_DATA_TRANSFER'
        group by
            1,2,3,4,5
        union all
        --
        -- database storage
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( day, dsuh.usage_date ) )     as dw_event_date_sid
            ,date_trunc( day, dsuh.usage_date )                   as event_dt
            --
            ,0                                                      as compute_credit_cnt
            ,avg(  dsuh.average_database_bytes
                 + dsuh.average_failsafe_bytes )                    as storage_byte_cnt
            ,0                                                      as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.database_storage_usage_history dsuh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = dsuh.organization_name
                and csh.account_name        = dsuh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = dsuh.region_name
                and csh.resource_name       = dsuh.database_name
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = dsuh.organization_name
                and cah.account_name        = dsuh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = dsuh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- dsuh
                dsuh.usage_date     >= $l_start_dt
            and dsuh.usage_date      < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'database'
            -- cstl
            and cstl.service_type_cd = 'STORAGE_DATABASE'
        group by
            1,2,3,4,5
        union all
        --
        -- stage storage
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( day, ssuh.usage_date ) )     as dw_event_date_sid
            ,date_trunc( day, ssuh.usage_date )                   as event_dt
            --
            ,0                                                      as compute_credit_cnt
            ,avg(  ssuh.average_stage_bytes )                       as storage_byte_cnt
            ,0                                                      as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.stage_storage_usage_history ssuh
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = ssuh.organization_name
                and csh.account_name        = ssuh.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = ssuh.region_name
                and csh.resource_name       = 'INTERNAL STAGE'
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = ssuh.organization_name
                and cah.account_name        = ssuh.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = ssuh.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- ssuh
                ssuh.usage_date     >= $l_start_dt
            and ssuh.usage_date      < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'internal_stage'
            -- cstl
            and cstl.service_type_cd = 'STORAGE_STAGE'
        group by
            1,2,3,4,5
        union all
        --
        -- data transfer
        --
        select
             cah.dw_account_shk
            ,csh.dw_resource_shk
            ,cstl.dw_service_type_shk
            ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( date_trunc( day, dth.start_time ) )        as dw_event_date_sid
            ,date_trunc( day, dth.start_time )                      as event_dt
            --
            ,0                                                      as compute_credit_cnt
            ,0                                                      as storage_byte_cnt
            ,sum( dth.bytes_transferred )                           as data_xfer_byte_cnt
        from
            DEV_PLAT_GOV_RL_DB.account_usage.data_transfer_history dth
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h csh on
                    csh.organization_name   = dth.organization_name
                and csh.account_name        = dth.account_name
                and csh.reader_account_name = '~'
                and csh.region_name         = dth.region_name
                and csh.resource_name       = concat( ifnull( dth.target_cloud, '?' ), '.', ifnull( dth.target_region, '?' ) )
            join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah on
                    cah.organization_name   = dth.organization_name
                and cah.account_name        = dth.account_name
                and cah.reader_account_name = '~'
                and cah.region_name         = dth.region_name
            cross join DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp cstl
        where
            -- dth
                dth.start_time        >= $l_start_dt
            and dth.start_time         < $l_end_dt
            -- csh
            and csh.resource_type_cd = 'cloudregion'
            -- cstl
            and cstl.service_type_cd = 'DATA_TRANSFER'
        group by
            1,2,3,4,5
    )
    select
         lrc.dw_account_shk
        ,lrc.dw_resource_shk
        ,lrc.dw_service_type_shk
        ,lrc.dw_event_date_sid
        ,lrc.event_dt
        --
        ,lrc.compute_credit_cnt
        ,lrc.compute_credit_cnt * DEV_PLAT_GOV_COMMON_DB.UTIL.sf_compute_cost_f( lrc.dw_account_shk, lrc.event_dt )
                                                                as compute_cost_amt
        ,lrc.storage_byte_cnt
        ,lrc.storage_byte_cnt / pow( 1024, 4 )                  as storage_tb_cnt
        ,(lrc.storage_byte_cnt / pow( 1024, 4 )) * DEV_PLAT_GOV_COMMON_DB.UTIL.sf_storage_cost_f( lrc.dw_account_shk, lrc.event_dt )
                                                                as storage_cost_amt
        ,lrc.data_xfer_byte_cnt
        ,lrc.data_xfer_byte_cnt / pow( 1024, 4 )                as data_xfer_tb_cnt
        ,(lrc.data_xfer_byte_cnt / pow( 1024, 4 )) * DEV_PLAT_GOV_COMMON_DB.UTIL.sf_data_xfer_cost_f( lrc.dw_account_shk, lrc.event_dt )
                                                                as data_xfer_cost_amt
        ,compute_cost_amt
         + storage_cost_amt
         + data_xfer_cost_amt                                   as total_cost_amt
        --
        ,current_timestamp()                                    as dw_load_ts
    from
        l_resource_consumption lrc
    where
        not exists
        (
            select 1 from DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_consumption_ds where event_dt >= $l_start_dt and event_dt < $l_end_dt
        )
    order by
        3
    ;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                    1854 |
+-------------------------+
commit;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- monthly aggregation of consumption by account
!print 310_derivation Step 4
310_derivation Step 4

!source 310_derivation/cb_account_consumption_ms_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- delete insert pattern
--
-- the delta date range could theoretically ca--use change where a given
-- combination of pk values no longer exist, therefore the months
-- represented by the delta need to be reaggregated in their entirety
--

--------------------------------------------------------------------
-- pull staged delta as a month boundary range
--
set (l_start_dt, l_end_dt ) = (select date_trunc( month, start_dt ), date_trunc( month, dateadd( month, 1, end_dt ) ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- wrap delete and insert within a transaction so a failure with the insert doesn't leave the table without data for the delta range
begin;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
    -- delete periods within the delta range
    --
    delete from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_ms
    where
            event_month_dt >= $l_start_dt
        and event_month_dt  < $l_end_dt
    ;
+------------------------+
| number of rows deleted |
|------------------------|
|                      0 |
+------------------------+
--------------------------------------------------------------------
    -- load delta
    --
    insert into
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_ms
    select
         carl.dw_account_shk
        ,crcm.dw_event_date_sid
        ,crcm.event_month_dt
        --
        ,sum( crcm.compute_credit_cnt )    as compute_credit_cnt
        ,sum( crcm.compute_cost_amt   )    as compute_cost_amt
        ,sum( crcm.storage_byte_cnt   )    as storage_byte_cnt
        ,sum( crcm.storage_tb_cnt     )    as storage_tb_cnt
        ,sum( crcm.storage_cost_amt   )    as storage_cost_amt
        ,sum( crcm.data_xfer_byte_cnt )    as data_xfer_byte_cnt
        ,sum( crcm.data_xfer_tb_cnt   )    as data_xfer_tb_cnt
        ,sum( crcm.data_xfer_cost_amt )    as data_xfer_cost_amt
        ,sum( crcm.total_cost_amt     )    as total_cost_amt
        --
        ,current_timestamp()               as dw_load_ts
    from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_consumption_ms crcm
        join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_resource_l carl on
            carl.dw_resource_shk = crcm.dw_resource_shk
    where
        not exists
        (
            select 1 from DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_ms where event_month_dt >= $l_start_dt and event_month_dt < $l_end_dt
        )
        -- crcm
        and crcm.event_month_dt >= $l_start_dt
        and crcm.event_month_dt  < $l_end_dt
    group by
        1,2,3
    order by
        2,1
    ;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       9 |
+-------------------------+
commit;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
!source 310_derivation/cb_account_consumption_ds_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- delete insert pattern
--
-- the delta date range could theoretically ca--use change where a given
-- combination of pk values no longer exist, therefore the months
-- represented by the delta need to be reaggregated in their entirety
--

--------------------------------------------------------------------
-- pull staged delta as a month boundary range
--
set (l_start_dt, l_end_dt ) = (select start_dt, end_dt from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- wrap delete and insert within a transaction so a failure with the insert doesn't leave the table without data for the delta range
begin;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
    -- delete periods within the delta range
    --
    delete from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_ds
    where
            event_dt >= $l_start_dt
        and event_dt  < $l_end_dt
    ;
+------------------------+
| number of rows deleted |
|------------------------|
|                      0 |
+------------------------+
--------------------------------------------------------------------
    -- load delta
    --
    insert into
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_ds
    select
         carl.dw_account_shk
        ,crcm.dw_event_date_sid
        ,crcm.event_dt
        --
        ,sum( crcm.compute_credit_cnt )    as compute_credit_cnt
        ,sum( crcm.compute_cost_amt   )    as compute_cost_amt
        ,sum( crcm.storage_byte_cnt   )    as storage_byte_cnt
        ,sum( crcm.storage_tb_cnt     )    as storage_tb_cnt
        ,sum( crcm.storage_cost_amt   )    as storage_cost_amt
        ,sum( crcm.data_xfer_byte_cnt )    as data_xfer_byte_cnt
        ,sum( crcm.data_xfer_tb_cnt   )    as data_xfer_tb_cnt
        ,sum( crcm.data_xfer_cost_amt )    as data_xfer_cost_amt
        ,sum( crcm.total_cost_amt     )    as total_cost_amt
        --
        ,current_timestamp()               as dw_load_ts
    from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_consumption_ds crcm
        join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_resource_l carl on
            carl.dw_resource_shk = crcm.dw_resource_shk
    where
        not exists
        (
            select 1 from DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_ds where event_dt >= $l_start_dt and event_dt < $l_end_dt
        )
        -- crcm
        and crcm.event_dt >= $l_start_dt
        and crcm.event_dt  < $l_end_dt
    group by
        1,2,3
    order by
        2,1
    ;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                     219 |
+-------------------------+
commit;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- monthly consumption forecast by account
!print 310_derivation Step 5
310_derivation Step 5

!source 310_derivation/cb_account_consumption_fcst_ms_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- date range to process
--
set (l_base_dt, l_start_dt, l_end_dt, l_month_cnt) =
(
    select
         date_trunc( month, current_date() )        as base_dt
        ,dateadd( month, -12, base_dt )             as start_dt
        ,dateadd( month,  12, base_dt )             as end_dt
        ,datediff( month, start_dt, end_dt )        as month_cnt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
-- populate forecasting input table with all prior months to model
-- and future months to forecast
--
create or replace temporary table DEV_PLAT_GOV_IL_DB.USAGE_METRIC.fcst_period_in as
with l_range_month as
(
    select
         DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( event_month_dt )    as dw_event_date_sid
        ,event_month_dt
        ,case
            when event_month_dt >= $l_base_dt then 1
            else 0
         end        as forecast_period_bt
    from
        (
        select
            dateadd( month, seq1(), $l_start_dt ) as event_month_dt
        from
            table( generator( rowcount => $l_month_cnt ) )
        )
)
,l_account as
(
    -- get distinct set of accounts being forecasted
    select
         dw_account_shk
        ,min( event_month_dt ) as first_month_dt
    from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_ms
    group by
        1
)
,l_account_month as
(
    -- fill in all prior and future months for each account
    select
         la.dw_account_shk
        ,lrm.dw_event_date_sid
        ,lrm.event_month_dt
        ,lrm.forecast_period_bt
    from
        l_account la
        cross join l_range_month lrm
    where
        lrm.event_month_dt >= la.first_month_dt
)
select
     lam.dw_account_shk                         as partition_key
    ,lam.event_month_dt                         as period_dt
    ,date_part( year, lam.event_month_dt )      as year_no
    ,date_part( month, lam.event_month_dt )     as period_no
    ,case lam.forecast_period_bt
        when 1
        then null
        else ifnull( cacm.total_cost_amt, 0 )
    end                                         as measure_no
    --
    ,lam.dw_account_shk
    ,lam.dw_event_date_sid
    ,lam.event_month_dt
    ,ifnull( cacm.total_cost_amt, 0 )           as total_cost_amt
from
    l_account_month lam
    left join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_ms cacm on
            cacm.dw_account_shk = lam.dw_account_shk
        and cacm.event_month_dt = lam.event_month_dt
order by
     lam.dw_account_shk
    ,lam.event_month_dt
;
+--------------------------------------------+
| status                                     |
|--------------------------------------------|
| Table FCST_PERIOD_IN successfully created. |
+--------------------------------------------+
--------------------------------------------------------------------
-- forecast current and future months
--
call DEV_PLAT_GOV_COMMON_DB.UTIL.fcst_linear_trend_sp( 'DEV_PLAT_GOV_IL_DB.USAGE_METRIC.fcst_period_in', 'DEV_PLAT_GOV_IL_DB.USAGE_METRIC.fcst_period_out' );
+----------------------+
| FCST_LINEAR_TREND_SP |
|----------------------|
| success              |
+----------------------+
-- wrap delete and insert within a transaction so a failure with the insert doesn't leave the table without data for the delta range
begin;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
    -- delete periods within the delta range
    --
    delete from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_fcst_ms
    where
            event_month_dt >= $l_start_dt
        and event_month_dt  < $l_end_dt
    ;
+------------------------+
| number of rows deleted |
|------------------------|
|                      0 |
+------------------------+
--------------------------------------------------------------------
    -- load delta
    --
    insert into
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_fcst_ms
    select
         fpi.dw_account_shk
        ,fpi.dw_event_date_sid
        --
        ,fpi.event_month_dt
        ,fpi.total_cost_amt
        ,fpo.fcst_measure_no    as fcst_total_cost_amt
        --
        ,current_timestamp()    as dw_load_ts
    from
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.fcst_period_in fpi
        join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.fcst_period_out fpo on
                fpo.partition_key = fpi.partition_key
            and fpo.period_dt     = fpi.period_dt
    where
        not exists
        (
            select 1 from DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_fcst_ms where event_month_dt >= $l_start_dt and event_month_dt < $l_end_dt
        )
    ;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      34 |
+-------------------------+
commit;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+

!print SUCCESS!
SUCCESS!
!source 000_admin/account_ld_320_mdm_orch.sql
------------------------------------------------------------------------------
-- 320_mdm
--
!print 320_mdm
320_mdm

!print SUCCESS!
SUCCESS!
!source 000_admin/account_ld_400_dimension_orch.sql
------------------------------------------------------------------------------
-- 400_dimension
--
!print 400_dimension
400_dimension
-- load dimension tables using raw thru derivation
!print 400_dimension Step 1
400_dimension Step 1

!source 400_dimension/cb_account_dm_ld.sql
--------------------------------------------------------------------
--  Purpose: 
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- a period-based delta scenario is not currently applicable to this
-- load process. a full load is performed since combinations of 
-- pk values may no longer exist after changes to the source mapping
--

insert overwrite into 
    DEV_PLAT_GOV_PL_DB.REPORTING.cb_account_dm
select
     cah.dw_account_shk
    --
    ,cah.organization_name 
    ,cah.account_name    
    ,cah.reader_account_name
    ,cah.region_name
    --
    ,current_timestamp()            as dw_load_ts
from
    DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_h cah
order by
    2,3,4
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       2 |
+-------------------------+

!source 400_dimension/cb_resource_dm_ld.sql
--------------------------------------------------------------------
--  Purpose:
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- a period-based delta scenario is not currently applicable to this
-- load process. a full load is performed since combinations of
-- pk values may no longer exist after changes to the source mapping
--

insert overwrite into
    DEV_PLAT_GOV_PL_DB.REPORTING.cb_resource_dm
select
     brms.dw_resource_shk
    --

    ,brms.be_name           
    ,crh.organization_name 
    ,crh.account_name    
    ,crh.reader_account_name
    ,crh.region_name
    ,crh.resource_name
    ,crh.resource_type_cd
    ,brms.tag_json:be::string     as business_entity
    ,brms.tag_json:team::string     as team_name
    ,brms.tag_json:product_group::string     as product_group
    ,brms.tag_json:environment_type::string      as environment_type
    ,brms.tag_json:cost_center_id::string  as cost_center_id
    ,brms.tag_json:customer::string  as customer
  
    ,current_timestamp()            as dw_load_ts
from
    DEV_PLAT_GOV_IL_DB.USAGE_METRIC.be_resource_mapping_s brms
    join DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_h crh on
        crh.dw_resource_shk = brms.dw_resource_shk
order by
    2,3,4,5
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      41 |
+-------------------------+
!source 400_dimension/cb_service_type_dm_ld.sql
--------------------------------------------------------------------
--  Purpose: 
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- a period-based delta scenario is not currently applicable to this
-- load process. so a merge of all source rows is performed
--

--
-- update modified and insert new
--
merge into DEV_PLAT_GOV_PL_DB.REPORTING.cb_service_type_dm t using
(
    with l_stg as
    (
        select
             sha1_binary( concat( s.service_type_cd
                                 ,'|', s.service_type_name
                                 ,'|', s.service_type_group_name
                                 ,'|', to_char( s.active_dt, 'yyyymmdd' )
                                 ,'|', to_char( s.inactive_dt, 'yyyymmdd' )
                                )
                        )                       as dw_hash_diff
            --
            ,s.dw_service_type_shk
            ,s.service_type_cd
            ,s.service_type_name
            ,s.service_type_group_name
            ,s.active_dt
            ,s.inactive_dt
            ,s.dw_load_ts
            ,s.dw_update_ts              
        from
            DEV_PLAT_GOV_RL_DB.account_usage.cb_service_type_lkp s
    )
    ,l_deduped as
    (
        select
            *
        from
            (
            select
                 -- identify dupes and only keep copy 1
                 -- note this is deduping on the primary key
                 row_number() over( partition by s.dw_service_type_shk order by s.active_dt desc ) as seq_no
                ,s.*
            from
                l_stg s
            )
        where
            seq_no = 1 -- keep only unique rows
    )
    select
         current_timestamp()        as dw_version_ts
        ,s.*
    from
        l_deduped s
        left join DEV_PLAT_GOV_PL_DB.REPORTING.cb_service_type_dm t on
            t.dw_service_type_shk = s.dw_service_type_shk
    where
        -- source row does not exist in target table
        t.dw_service_type_shk is null
        -- or source row is more recent and differs from target table
        or (
                t.dw_update_ts      < s.dw_update_ts
            and t.dw_hash_diff     != s.dw_hash_diff
           )
    order by
        s.active_dt
) s
on
(
    t.dw_service_type_shk = s.dw_service_type_shk
)
when matched then update set
     t.dw_hash_diff             = s.dw_hash_diff
    ,t.service_type_cd          = s.service_type_cd        
    ,t.service_type_name        = s.service_type_name      
    ,t.service_type_group_name  = s.service_type_group_name
    ,t.active_dt                = s.active_dt              
    ,t.inactive_dt              = s.inactive_dt
    --
    ,t.dw_update_ts             = current_timestamp()
when not matched then insert
(
     dw_service_type_shk
    ,dw_hash_diff
    ,service_type_cd        
    ,service_type_name      
    ,service_type_group_name
    ,active_dt              
    ,inactive_dt            
    ,dw_load_ts
    ,dw_update_ts
)
values
(
     s.dw_service_type_shk
    ,s.dw_hash_diff
    ,s.service_type_cd        
    ,s.service_type_name      
    ,s.service_type_group_name
    ,s.active_dt              
    ,s.inactive_dt            
    ,current_timestamp()
    ,current_timestamp()
)
;
+-------------------------+------------------------+
| number of rows inserted | number of rows updated |
|-------------------------+------------------------|
|                      11 |                      0 |
+-------------------------+------------------------+

!source 400_dimension/date_dm_ld.sql
--------------------------------------------------------------------
--  Purpose: data acquisition
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- date range to maintain
--
set (l_start_dt, l_end_dt, l_day_cnt, l_null_dt, l_undefined_dt ) = 
(
    select
         to_date( '01/01/2010', 'mm/dd/yyyy' )                     as start_dt
        ,date_trunc( year, dateadd( year,  4, current_date() ) )   as end_dt
        ,datediff( day, start_dt, end_dt )                         as day_cnt
        -- defaults for nulls and undefined values
        ,to_date( '01/01/1950', 'mm/dd/yyyy' )                     as null_dt
        ,to_date( '01/01/1900', 'mm/dd/yyyy' )                     as undefined_dt
);
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
insert overwrite into DEV_PLAT_GOV_PL_DB.REPORTING.date_dm
with l_date as
(
    -- generate broad date range to translate
    select
         cal_dt
        ,date_part( year, cal_dt )              as cal_year_no
        ,date_part( quarter, cal_dt )           as cal_year_quarter_no
        ,date_part( month, cal_dt )             as cal_year_month_no
        ,date_part( dayofyear, cal_dt )         as cal_year_day_no
        -- dates
        ,min( cal_dt ) over( partition by date_part( year, cal_dt ) )                                 as cal_year_dt
        ,min( cal_dt ) over( partition by date_part( year, cal_dt ), date_part( quarter, cal_dt ) )   as cal_quarter_dt
        ,min( cal_dt ) over( partition by date_part( year, cal_dt ), date_part( month, cal_dt ) )     as cal_month_dt
    from
        (
        select
            dateadd( day, seq4(), $l_start_dt )      as cal_dt
        from
            table( generator( rowcount => $l_day_cnt ) )
        -- union in null and undefined placeholders
        union all select $l_null_dt
        union all select $l_undefined_dt
        )
)
,l_cal_dt as
(
    --
    -- generate dates - full ISO years are generated.
    --
    select
         cal_dt
        ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( cal_dt )                           as dw_date_sid
        ,DEV_PLAT_GOV_COMMON_DB.UTIL.date_sid_f( dateadd( 'day',  -364, cal_dt ) )  as dw_cal_ly_date_sid
        ,to_char( cal_dt, 'yyyy/mm/dd Dy' )             as cal_date_label
        ,case
            when date_part( 'dow', cal_dt ) in ( 0,6 ) then 'Y'
            else 'N'
         end                                            as cal_weekend_fl
        ,case
            when date_part( 'dow', cal_dt ) in ( 0,6 ) then 'N'
            else 'Y'
         end                                            as cal_weekday_fl
        ,cal_year_no
        ,cal_year_dt
        ,cal_year_quarter_no
        ,min( case when cal_year_no = date_part( year, current_date ) then cal_quarter_dt else to_date( null ) end ) over( partition by cal_year_quarter_no )    as cal_year_quarter_dt
        ,cal_year_month_no
        ,min( case when cal_year_no = date_part( year, current_date ) then cal_month_dt else to_date( null ) end ) over( partition by cal_year_month_no )       as cal_year_month_dt
        ,to_char( cal_year_no )
          || '/'
          || lpad( date_part( 'mm', cal_dt ), 2, '0' )
          || '/01 '
          || monthname( cal_dt )                        as cal_month_label
        ,cal_year_day_no
        ,cal_quarter_dt
        ,to_char( cal_quarter_dt, 'yyyy/mm/dd' )
                     || ' Q'
                     || cal_year_quarter_no             as cal_quarter_label
        ,dense_rank()
                over ( partition by
                        cal_year_no
                       ,cal_year_quarter_no
                    order by
                        cal_year_month_no    )          as cal_quarter_month_no
        ,dense_rank()
                over ( partition by
                           cal_year_no
                          ,cal_year_quarter_no
                       order by
                           cal_year_day_no      )       as cal_quarter_day_no
        ,cal_month_dt
        ,dense_rank()
             over ( partition by
                        cal_year_no
                       ,cal_year_month_no
                    order by
                        cal_year_day_no   )             as cal_month_day_no
        ,date_part( 'dow', cal_dt ) + 1                 as cal_week_day_no
        ,dense_rank()
              over ( order by
                          cal_year_no
                         ,cal_year_quarter_no )         as cal_itd_quarter_no
        ,dense_rank()
              over ( order by
                          cal_year_no
                         ,cal_year_month_no )           as cal_itd_month_no
        ,dense_rank()
              over ( order by
                          cal_dt )                      as cal_itd_day_no
    from
        l_date
)
,l_iso_dt as
(
    --
    -- generate iso periods - this includes iso_year_<period>_dt for quarter, month and week
    --
    select
         cal_dt
        ,iso_year_no
        ,iso_year_quarter_no
        --
        -- year dates based on current iso year for todays date
        --
        ,min( case when iso_year_no = iso_current_year_no then iso_quarter_dt else to_date( null ) end ) over( partition by iso_year_quarter_no )    as iso_year_quarter_dt
        ,min( case when iso_year_no = iso_current_year_no then iso_month_dt   else to_date( null ) end ) over( partition by iso_year_month_no )      as iso_year_month_dt
        ,min( case when iso_year_no = iso_current_year_no then iso_week_dt    else to_date( null ) end ) over( partition by iso_year_week_no )       as iso_year_week_dt
        ,to_char( iso_quarter_dt, 'yyyy/mm/dd' )
                     || ' Q'
                     || iso_year_quarter_no                      as iso_quarter_label
        ,iso_year_month_no
        ,to_char( iso_month_dt, 'yyyy/mm/dd' )
                     || ' '
                     || monthname( iso_month_dt )                as iso_month_label
        ,iso_year_week_no
        ,iso_year_day_no
        -- dates
        ,iso_year_dt
        ,iso_quarter_dt
        ,dense_rank()
                over ( partition by
                           iso_year_no
                          ,iso_year_quarter_no
                       order by
                           iso_year_month_no    )                as iso_quarter_month_no
        ,dense_rank()
                over ( partition by
                           iso_year_no
                          ,iso_year_quarter_no
                       order by
                           iso_week_dt    )                      as iso_quarter_week_no
        ,dense_rank()
                over ( partition by
                           iso_year_no
                          ,iso_year_quarter_no
                       order by
                           iso_year_day_no      )                as iso_quarter_day_no
        ,iso_month_dt
        ,dense_rank()
                over ( partition by
                           iso_year_no
                          ,iso_year_month_no
                       order by
                           iso_week_dt    )                      as iso_month_week_no
        ,dense_rank()
                over ( partition by
                           iso_year_no
                          ,iso_year_month_no
                       order by
                           iso_year_day_no   )                   as iso_month_day_no
        ,iso_week_dt
        ,to_char( max( iso_week_dt )
                 over( partition by iso_year_no, iso_year_week_no )
                 ,'yyyy/mm/dd' )
            || ' Wk '
            || lpad( to_char( iso_year_week_no ), 2, '0' )       as iso_week_label
        ,date_part( 'dow_iso', cal_dt )                          as iso_week_day_no
        -- current iso year
        ,iso_current_year_no
        ,dense_rank()
              over ( order by
                          iso_year_no
                         ,iso_year_quarter_no )                    as iso_itd_quarter_no
         ,dense_rank()
              over ( order by
                          iso_year_no
                         ,iso_year_month_no )                      as iso_itd_month_no
         ,dense_rank()
              over ( order by
                          iso_year_no
                         ,iso_year_week_no )                       as iso_itd_week_no
         ,dense_rank()
              over ( order by
                          cal_dt )                                 as iso_itd_day_no
    from
        (
        select
             cal_dt
            ,iso_year_no
            ,iso_year_quarter_no
            ,iso_year_month_no
            ,iso_year_week_no
            ,iso_year_day_no
            -- dates
            ,date_from_parts( iso_year_no, 1, 1 )                   as iso_year_dt
            ,case iso_year_quarter_no
                when 1 then date_from_parts( iso_year_no,  1, 1 )
                when 2 then date_from_parts( iso_year_no,  4, 1 )
                when 3 then date_from_parts( iso_year_no,  7, 1 )
                when 4 then date_from_parts( iso_year_no, 10, 1 )
                else to_date( null )
             end                                                    as iso_quarter_dt
            ,date_from_parts( iso_year_no, iso_year_month_no, 1 )   as iso_month_dt
            ,iso_week_dt
            -- current iso year
            ,date_part( year, dateadd( day, 3, date_trunc( week, current_date ) ) )     as iso_current_year_no
        from
            (
            select
                 cal_dt
                ,date_part( year, dateadd( day, 3, iso_week_dt ) )       as iso_year_no
                --
                -- each quarter is 13 weeks with q4 sometimes being 14 weeks for 53 week years
                --
                ,case
                    when iso_year_week_no <= 13 then  1
                    when iso_year_week_no <= 26 then  2
                    when iso_year_week_no <= 39 then  3
                    when iso_year_week_no <= 53 then  4
                    else 5 -- should never hit
                 end                        as iso_year_quarter_no
                --
                -- months are driven by 4-5-4 quarters
                --
                ,case
                    when iso_year_week_no <=  4 then  1  -- jan 4
                    when iso_year_week_no <=  9 then  2  -- feb 5
                    when iso_year_week_no <= 13 then  3  -- mar 4
                    when iso_year_week_no <= 17 then  4  -- apr 4
                    when iso_year_week_no <= 22 then  5  -- may 5
                    when iso_year_week_no <= 26 then  6  -- jun 4
                    when iso_year_week_no <= 30 then  7  -- jul 4
                    when iso_year_week_no <= 35 then  8  -- aug 5
                    when iso_year_week_no <= 39 then  9  -- sep 4
                    when iso_year_week_no <= 43 then 10  -- oct 4
                    when iso_year_week_no <= 48 then 11  -- nov 5
                    when iso_year_week_no <= 53 then 12  -- dec 4
                    else 13 -- should never hit
                 end                        as iso_year_month_no
                ,iso_year_week_no
                ,iso_week_dt
                ,row_number() over( partition by date_part( year, dateadd( day, 3, iso_week_dt ) ) order by cal_dt )    as iso_year_day_no
            from
                (
                select
                     cal_dt
                    ,date_trunc( week, cal_dt )                                                 as iso_week_dt
                    ,date_part( week, cal_dt )                                                  as iso_year_week_no
                from
                    l_cal_dt
                )
            )
        )
)
select
    -- cal
     lcd.dw_date_sid
    ,lcd.dw_cal_ly_date_sid
    ,lcd.cal_dt
    ,lcd.cal_date_label
    ,lcd.cal_weekend_fl
    ,lcd.cal_weekday_fl
    -- iso
    ,lid.iso_year_no
    ,lid.iso_year_dt
    ,lid.iso_year_quarter_no
    ,lid.iso_year_quarter_dt
    ,lid.iso_year_month_no
    ,lid.iso_year_month_dt
    ,lid.iso_year_week_no
    ,lid.iso_year_week_dt
    ,lid.iso_year_day_no
    --
    ,lcd.cal_year_no
    ,lcd.cal_year_dt
    ,lcd.cal_year_quarter_no
    ,lcd.cal_year_quarter_dt
    ,lcd.cal_year_month_no
    ,lcd.cal_year_month_dt
    ,lcd.cal_year_day_no
    --
    ,lid.iso_quarter_dt
    ,lid.iso_quarter_label
    ,lid.iso_quarter_month_no
    ,lid.iso_quarter_week_no
    ,lid.iso_quarter_day_no
    --
    ,lcd.cal_quarter_dt
    ,lcd.cal_quarter_label
    ,lcd.cal_quarter_month_no
    ,dense_rank()
           over ( partition by
                      lcd.cal_year_no
                     ,lcd.cal_year_quarter_no
                  order by
                      lid.iso_week_dt    )        as cal_quarter_week_no
    ,lcd.cal_quarter_day_no
    --
    ,lid.iso_month_dt
    ,lid.iso_month_label
    ,lid.iso_month_week_no
    ,lid.iso_month_day_no
    --
    ,lcd.cal_month_dt
    ,lcd.cal_month_label
    ,dense_rank()
           over ( partition by
                      lcd.cal_year_no
                     ,lcd.cal_year_month_no
                  order by
                      lid.iso_week_dt    )       as cal_month_week_no
    ,lcd.cal_month_day_no
    --
    ,lid.iso_week_dt
    ,lid.iso_week_label
    ,lid.iso_week_day_no
    ,lcd.cal_week_day_no
    -- iso itd
    ,lid.iso_itd_quarter_no
    ,lid.iso_itd_month_no
    ,lid.iso_itd_week_no
    ,lid.iso_itd_day_no
    -- cal itd
    ,lcd.cal_itd_quarter_no
    ,lcd.cal_itd_month_no
    ,lcd.cal_itd_day_no
     --
    ,0                                                            as iso_ptd_bt
    ,'N'                                                          as iso_ptd_label
    ,0                                                            as cal_ptd_bt
    ,'N'                                                          as cal_ptd_label
    -- future
    ,0                                                            as cal_future_date_bt
--    ,nvl( dhs.holiday_label, '~' )                               as holiday_name
    ,'~'                                                          as holiday_name
    ,to_timestamp_ltz( current_timestamp() )                      as dw_load_ts
    ,to_timestamp_ltz( current_timestamp() )                      as dw_update_ts
from
    l_cal_dt        lcd
    join l_iso_dt   lid on
        lid.cal_dt = lcd.cal_dt
    --
    -- create a holiday satellite within the derivation layer and then join into this load script
    -- to populate holiday names.
    --
    --    left join date_holiday_s dhs on
    --        dhs.holiday_dt = lcd.cal_dt
where
    lcd.cal_dt is not null
order by
    lcd.cal_dt
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                    5481 |
+-------------------------+
!source 400_dimension/cb_be_dm_ld.sql
--------------------------------------------------------------------
--  Purpose: 
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- a period-based delta scenario is not currently applicable to this
-- load process. a full load is performed since combinations of 
-- pk values may no longer exist after changes to the source mapping
--

insert overwrite into 
    DEV_PLAT_GOV_PL_DB.REPORTING.cb_be_dm
select
     cah.dw_be_shk
    --
    ,cah.be_name 
    --
    ,current_timestamp()            as dw_load_ts
from
    DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_be_h cah
order by
    2
;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                       9 |
+-------------------------+


!print SUCCESS!
SUCCESS!
!source 000_admin/account_ld_410_fact_atomic_orch.sql
------------------------------------------------------------------------------
-- 410_fact_atomic
--
!print 410_fact_atomic
410_fact_atomic

!print SUCCESS!
SUCCESS!
!source 000_admin/account_ld_420_fact_aggregate_orch.sql
------------------------------------------------------------------------------
-- 420_fact_aggregate
--
!print 420_fact_aggregate
420_fact_aggregate
-- load resource and account fact tables with actuals
!print 420_fact_aggregate Step 1
420_fact_aggregate Step 1

!source 420_fact_aggregate/cb_resource_mf_ld.sql
--------------------------------------------------------------------
--  Purpose: 
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- delete insert pattern
--
-- the delta date range could theoretically ca--use change where a given
-- combination of pk values no longer exist, therefore the months
-- represented by the delta need to be reaggregated in their entirety
--  

--------------------------------------------------------------------
-- pull staged delta as a month boundary range
--
set (l_start_dt, l_end_dt ) = (select date_trunc( month, start_dt ), date_trunc( month, dateadd( month, 1, end_dt ) ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- wrap delete and insert within a transaction so a failure with the insert doesn't leave the table without data for the delta range
begin;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
    -- delete periods within the delta range
    --
    delete from
        DEV_PLAT_GOV_PL_DB.REPORTING.cb_resource_mf
    where
            event_month_dt >= $l_start_dt
        and event_month_dt  < $l_end_dt
    ;
+------------------------+
| number of rows deleted |
|------------------------|
|                      0 |
+------------------------+
--------------------------------------------------------------------
    -- load delta
    --
    insert into 
        DEV_PLAT_GOV_PL_DB.REPORTING.cb_resource_mf
    select 
         crcm.dw_resource_shk
        ,crcm.dw_service_type_shk
        ,crcm.dw_event_date_sid
        --
        ,crcm.event_month_dt
        ,crcm.compute_credit_cnt
        ,crcm.compute_cost_amt
        ,crcm.storage_byte_cnt
        ,crcm.storage_cost_amt
        ,crcm.data_xfer_byte_cnt
        ,crcm.data_xfer_cost_amt
        --
        ,current_timestamp()                                as dw_load_ts
    from 
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_consumption_ms crcm
    where
        not exists 
        (
            select 1 from DEV_PLAT_GOV_PL_DB.REPORTING.cb_resource_mf where event_month_dt >= $l_start_dt and event_month_dt < $l_end_dt
        )
        and crcm.event_month_dt >= $l_start_dt
        and crcm.event_month_dt < $l_end_dt
    order by
        3,1,2
    ;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                     120 |
+-------------------------+
commit;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+

!source 420_fact_aggregate/cb_account_mf_ld.sql
--------------------------------------------------------------------
--  Purpose: 
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta as a month boundary range
--
set (l_start_dt, l_end_dt ) = (select date_trunc( month, start_dt ), date_trunc( month, dateadd( month, 1, end_dt ) ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- wrap delete and insert within a transaction so a failure with the insert doesn't leave the table without data for the delta range
begin;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
    -- delete periods within the delta range
    --
    delete from 
        DEV_PLAT_GOV_PL_DB.REPORTING.cb_account_mf
    where
            event_month_dt >= $l_start_dt
        and event_month_dt  < $l_end_dt
    ;
+------------------------+
| number of rows deleted |
|------------------------|
|                      0 |
+------------------------+
--------------------------------------------------------------------
    -- load delta
    --
    insert into 
        DEV_PLAT_GOV_PL_DB.REPORTING.cb_account_mf 
    select
         dw_account_shk
        ,dw_event_date_sid
        --
        ,event_month_dt
        ,max( compute_credit_cnt  )         as compute_credit_cnt  
        ,max( compute_cost_amt    )         as compute_cost_amt   
        ,max( storage_byte_cnt    )         as storage_byte_cnt   
        ,max( storage_cost_amt    )         as storage_cost_amt   
        ,max( data_xfer_byte_cnt  )         as data_xfer_byte_cnt 
        ,max( data_xfer_cost_amt  )         as data_xfer_cost_amt 
        ,max( total_cost_amt      )         as total_cost_amt     
        ,max( fcst_total_cost_amt )         as fcst_total_cost_amt
        ,current_timestamp()                as dw_load_ts
        ,current_timestamp()                as dw_update_ts
    from
        (
        -- actuals
        select 
             cacm.dw_account_shk
            ,cacm.dw_event_date_sid
            --
            ,cacm.event_month_dt
            ,cacm.compute_credit_cnt 
            ,cacm.compute_cost_amt
            ,cacm.storage_byte_cnt
            ,cacm.storage_cost_amt
            ,cacm.data_xfer_byte_cnt
            ,cacm.data_xfer_cost_amt
            ,cacm.total_cost_amt
            ,0                                  as fcst_total_cost_amt
        from 
            DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_ms cacm
        where
                cacm.event_month_dt >= $l_start_dt
            and cacm.event_month_dt  < $l_end_dt
        union all
        -- forecast
        select 
             cacfm.dw_account_shk
            ,cacfm.dw_event_date_sid
            --
            ,cacfm.event_month_dt
            ,0                                  as compute_credit_cnt 
            ,0                                  as compute_cost_amt
            ,0                                  as storage_byte_cnt
            ,0                                  as storage_cost_amt
            ,0                                  as data_xfer_byte_cnt
            ,0                                  as data_xfer_cost_amt
            ,0                                  as total_cost_amt
            ,cacfm.fcst_total_cost_amt
        from 
            DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_fcst_ms cacfm
        where
                cacfm.event_month_dt >= $l_start_dt
            and cacfm.event_month_dt  < $l_end_dt
        )
    group by
        2,1,3
    order by
        2,1
    ;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      12 |
+-------------------------+
commit;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
!source 420_fact_aggregate/cb_resource_df_ld.sql
--------------------------------------------------------------------
--  Purpose: 
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- delete insert pattern
--
-- the delta date range could theoretically ca--use change where a given
-- combination of pk values no longer exist, therefore the months
-- represented by the delta need to be reaggregated in their entirety
--  

--------------------------------------------------------------------
-- pull staged delta as a month boundary range
--
set (l_start_dt, l_end_dt ) = (select start_dt, end_dt from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- wrap delete and insert within a transaction so a failure with the insert doesn't leave the table without data for the delta range
begin;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
    -- delete periods within the delta range
    --
    delete from
        DEV_PLAT_GOV_PL_DB.REPORTING.cb_resource_df
    where
            event_dt >= $l_start_dt
        and event_dt  < $l_end_dt
    ;
+------------------------+
| number of rows deleted |
|------------------------|
|                      0 |
+------------------------+
--------------------------------------------------------------------
    -- load delta
    --
    insert into 
        DEV_PLAT_GOV_PL_DB.REPORTING.cb_resource_df
    select 
         crcm.dw_resource_shk
        ,crcm.dw_service_type_shk
        ,crcm.dw_event_date_sid
        --
        ,crcm.event_dt
        ,crcm.compute_credit_cnt
        ,crcm.compute_cost_amt
        ,crcm.storage_byte_cnt
        ,crcm.storage_cost_amt
        ,crcm.data_xfer_byte_cnt
        ,crcm.data_xfer_cost_amt
        --
        ,current_timestamp()                                as dw_load_ts
    from 
        DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_resource_consumption_ds crcm
    where
        not exists 
        (
            select 1 from DEV_PLAT_GOV_PL_DB.REPORTING.cb_resource_df where event_dt >= $l_start_dt and event_dt < $l_end_dt
        )
        and crcm.event_dt >= $l_start_dt
        and crcm.event_dt < $l_end_dt
    order by
        3,1,2
    ;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                    1854 |
+-------------------------+
commit;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+

!source 420_fact_aggregate/cb_account_df_ld.sql
--------------------------------------------------------------------
--  Purpose: 
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta as a month boundary range
--
set (l_start_dt, l_end_dt ) = (select start_dt, end_dt from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- wrap delete and insert within a transaction so a failure with the insert doesn't leave the table without data for the delta range
begin;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
    -- delete periods within the delta range
    --
    delete from 
        DEV_PLAT_GOV_PL_DB.REPORTING.cb_account_df
    where
            event_dt >= $l_start_dt
        and event_dt  < $l_end_dt
    ;
+------------------------+
| number of rows deleted |
|------------------------|
|                      0 |
+------------------------+
--------------------------------------------------------------------
    -- load delta
    --
    insert into 
        DEV_PLAT_GOV_PL_DB.REPORTING.cb_account_df 
    select
         dw_account_shk
        ,dw_event_date_sid
        --
        ,event_dt
        ,max( compute_credit_cnt  )         as compute_credit_cnt  
        ,max( compute_cost_amt    )         as compute_cost_amt   
        ,max( storage_byte_cnt    )         as storage_byte_cnt   
        ,max( storage_cost_amt    )         as storage_cost_amt   
        ,max( data_xfer_byte_cnt  )         as data_xfer_byte_cnt 
        ,max( data_xfer_cost_amt  )         as data_xfer_cost_amt 
        ,max( total_cost_amt      )         as total_cost_amt     
        ,current_timestamp()                as dw_load_ts
        ,current_timestamp()                as dw_update_ts
    from
        (
        -- actuals
        select 
             cacm.dw_account_shk
            ,cacm.dw_event_date_sid
            --
            ,cacm.event_dt
            ,cacm.compute_credit_cnt 
            ,cacm.compute_cost_amt
            ,cacm.storage_byte_cnt
            ,cacm.storage_cost_amt
            ,cacm.data_xfer_byte_cnt
            ,cacm.data_xfer_cost_amt
            ,cacm.total_cost_amt
            ,0                                  as fcst_total_cost_amt
        from 
            DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_ds cacm
        where
                cacm.event_dt >= $l_start_dt
            and cacm.event_dt  < $l_end_dt
        )
    group by
        2,1,3
    order by
        2,1
    ;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                     219 |
+-------------------------+
commit;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
!source 420_fact_aggregate/cb_be_budget_mf_ld.sql
--------------------------------------------------------------------
--  Purpose: 
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta as a month boundary range
--
set (l_start_dt, l_end_dt ) = (select date_trunc( month, start_dt ), date_trunc( month, dateadd( month, 1, end_dt ) ) from table( DEV_PLAT_GOV_COMMON_DB.UTIL.dw_delta_date_range_f( 'all' ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- wrap delete and insert within a transaction so a failure with the insert doesn't leave the table without data for the delta range
begin;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
    -- delete periods within the delta range
    --
    delete from 
        DEV_PLAT_GOV_PL_DB.REPORTING.cb_be_budget_mf
    where
            event_month_dt >= $l_start_dt
        and event_month_dt  < $l_end_dt
    ;
+------------------------+
| number of rows deleted |
|------------------------|
|                      0 |
+------------------------+
--------------------------------------------------------------------
    -- load delta
    --
    insert into 
        DEV_PLAT_GOV_PL_DB.REPORTING.cb_be_budget_mf 
    select
         dw_be_shk
        ,dw_event_date_sid
        --
        ,month_begin_dt
        ,max( compute_credit_cnt  )  as budget_compute_credit_cnt  
        ,current_timestamp()         as dw_load_ts
        ,current_timestamp()         as dw_update_ts
    from
        (
        -- actuals
        select 
             cacm.dw_be_shk
            ,cacm.dw_event_date_sid
            -- 
            ,cacm.month_begin_dt
            ,cacm.compute_credit_cnt 
            ,0                                  as fcst_total_cost_amt
        from 
            DEV_PLAT_GOV_IL_DB.USAGE_METRIC.be_budget_cost_s cacm
        where
               cacm.month_begin_dt >= $l_start_dt
           and cacm.month_begin_dt  < $l_end_dt
        )
    group by
        2,1,3
    order by
        2,1
    ;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      35 |
+-------------------------+
commit;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- update account fact with forecast
!print 420_fact_aggregate Step 2
420_fact_aggregate Step 2

!source 420_fact_aggregate/cb_account_mf_fcst_ld.sql
--------------------------------------------------------------------
--  Purpose: 
--
--  Revision History:
--  Date     Engineer      Description
--  -------- ------------- ----------------------------------
--  dd/mm/yy
--------------------------------------------------------------------

--------------------------------------------------------------------
-- pull staged delta as a month boundary range
-- fixed at current month thru next 11 months
--
set (l_start_dt, l_end_dt) = (select date_trunc( month, current_date() ), date_trunc( month, dateadd( month, 12, current_date() ) ));
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
-- wrap delete and insert within a transaction so a failure with the insert doesn't leave the table without data for the delta range
begin;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+
--------------------------------------------------------------------
    -- delete periods within the delta range
    --
    delete from 
        DEV_PLAT_GOV_PL_DB.REPORTING.cb_account_mf
    where
            event_month_dt >= $l_start_dt
        and event_month_dt  < $l_end_dt
    ;
+------------------------+
| number of rows deleted |
|------------------------|
|                      2 |
+------------------------+
--------------------------------------------------------------------
    -- load delta
    --
    insert into 
        DEV_PLAT_GOV_PL_DB.REPORTING.cb_account_mf 
    select
         dw_account_shk
        ,dw_event_date_sid
        --
        ,event_month_dt
        ,max( compute_credit_cnt  )         as compute_credit_cnt  
        ,max( compute_cost_amt    )         as compute_cost_amt   
        ,max( storage_byte_cnt    )         as storage_byte_cnt   
        ,max( storage_cost_amt    )         as storage_cost_amt   
        ,max( data_xfer_byte_cnt  )         as data_xfer_byte_cnt 
        ,max( data_xfer_cost_amt  )         as data_xfer_cost_amt 
        ,max( total_cost_amt      )         as total_cost_amt     
        ,max( fcst_total_cost_amt )         as fcst_total_cost_amt
        ,current_timestamp()                as dw_load_ts
        ,current_timestamp()                as dw_update_ts
    from
        (
        -- actuals
        select 
             cacm.dw_account_shk
            ,cacm.dw_event_date_sid
            --
            ,cacm.event_month_dt
            ,cacm.compute_credit_cnt 
            ,cacm.compute_cost_amt
            ,cacm.storage_byte_cnt
            ,cacm.storage_cost_amt
            ,cacm.data_xfer_byte_cnt
            ,cacm.data_xfer_cost_amt
            ,cacm.total_cost_amt
            ,0                                  as fcst_total_cost_amt
        from 
            DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_ms cacm
        where
                cacm.event_month_dt >= $l_start_dt
            and cacm.event_month_dt  < $l_end_dt
        union all
        -- forecast
        select 
             cacfm.dw_account_shk
            ,cacfm.dw_event_date_sid
            --
            ,cacfm.event_month_dt
            ,0                                  as compute_credit_cnt 
            ,0                                  as compute_cost_amt
            ,0                                  as storage_byte_cnt
            ,0                                  as storage_cost_amt
            ,0                                  as data_xfer_byte_cnt
            ,0                                  as data_xfer_cost_amt
            ,0                                  as total_cost_amt
            ,cacfm.fcst_total_cost_amt
        from 
            DEV_PLAT_GOV_IL_DB.USAGE_METRIC.cb_account_consumption_fcst_ms cacfm
        where
                cacfm.event_month_dt >= $l_start_dt
            and cacfm.event_month_dt  < $l_end_dt
        )
    group by
        2,1,3
    order by
        2,1
    ;
+-------------------------+
| number of rows inserted |
|-------------------------|
|                      24 |
+-------------------------+
commit;
+----------------------------------+
| status                           |
|----------------------------------|
| Statement executed successfully. |
+----------------------------------+

!print SUCCESS!
SUCCESS!
!source 000_admin/account_ld_500_outbound_orch.sql
------------------------------------------------------------------------------
-- 500_outbound
--
!print 500_outbound
500_outbound

!print SUCCESS!
SUCCESS!

!disconnect

!print SUCCESS!
SUCCESS!
!quit
